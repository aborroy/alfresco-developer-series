
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Tutorials and best practices for Alfresco developers">
      
      
      
      
        <link rel="prev" href="../../../webscripts/tutorial/tutorial/">
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.20">
    
    
      
        <title>Workflows - Alfresco Developer Series</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.e53b48f4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#creating-custom-advanced-workflows-in-alfresco" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Alfresco Developer Series" class="md-header__button md-logo" aria-label="Alfresco Developer Series" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Alfresco Developer Series
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Workflows
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/aborroy/alfresco-developer-series" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Alfresco Developer Series" class="md-nav__button md-logo" aria-label="Alfresco Developer Series" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Alfresco Developer Series
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/aborroy/alfresco-developer-series" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Tutorials
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../maven-sdk/tutorial/tutorial/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Maven SDK
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../content/tutorial/tutorial/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Content Types & CMIS
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../actions/tutorial/tutorial/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Actions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../behaviors/tutorial/tutorial/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Behaviors
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../webscripts/tutorial/tutorial/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    WebScripts
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Workflows
    
  </span>
  

      </a>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="creating-custom-advanced-workflows-in-alfresco">Creating Custom Advanced Workflows in Alfresco<a class="headerlink" href="#creating-custom-advanced-workflows-in-alfresco" title="Permanent link">&para;</a></h1>
<p><em>Jeff Potts, <a href="https://www.ecmarchitect.com/">Metaversant Group</a> — July, 2021</em></p>
<h1 id="license">License<a class="headerlink" href="#license" title="Permanent link">&para;</a></h1>
<p><img alt="" src="../images/cc-by-sa-88x31.png" /></p>
<p>This work is licensed under the Creative Commons Attribution-ShareAlike 3.0
Unported License. To view a copy of this license, visit http://creativecommons.org/licenses/by-sa/3.0/
or send a letter to Creative Commons, 444 Castro Street, Suite 900, Mountain
View, California, 94041, USA.</p>
<h1 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h1>
<p>This tutorial is about the advanced workflow functionality available in Alfresco
through its embedded Activiti workflow engine. First, because "workflow" can
mean different things to different people, I'll talk about my definition of the
term. Then, I'll introduce some Activiti concepts that will help you understand
how processes are defined and how the workflow engine actually works. Once that
foundation is in place, I'll walk through some examples that feature many of the
different concepts.</p>
<p>This tutorial builds upon the "SomeCo" examples covered in earlier tutorials. In
it, I'll implement a business process that helps SomeCo route whitepapers for
review and approval by internal as well as external parties.</p>
<h1 id="what-is-a-workflow">What is a workflow?<a class="headerlink" href="#what-is-a-workflow" title="Permanent link">&para;</a></h1>
<p>When Alfresco released version 1.4 of the product, they made a huge leap forward
in enterprise readiness. That was the release when Alfresco embedded the JBoss
jBPM engine into the product which meant that enterprises could route Alfresco
repository content through complex business processes. A content repository
without the ability to facilitate business processes that produce, consume, or
transform the content within it is little more than a glorified file server,
so this was a welcome addition.</p>
<p>But before I geek out on the wonders of graph based execution languages let's
agree on what the term <em>workflow</em> means. Generically, a workflow is "a reliably
repeatable pattern of activity enabled by a systematic organization of
resources...that can be documented and learned"(<a href="http://en.wikipedia.org/wiki/Workflow">source</a>).
The term has been around since people started studying the nature of work in
the early 20^th^ century in an effort to streamline manufacturing processes.</p>
<p>In fact, in the world of ECM, it is sometimes helpful to think of an assembly
line or manufacturing process when thinking about how content flows through an
organization. Content is born of raw material (data), shaped and molded by one
or more people (collaboration) or machines (systems), reviewed for quality, and
delivered to consumers. Content may go through a single process or many
sub-processes. Content may take different routes through a process based on
certain characteristics of that content. The output of an organization or
department of knowledge workers is essentially the content that comes rolling
off the assembly line (the collection of workflows that define that
organization's business processes).</p>
<p>Although not always formalized or automated, almost everyone in modern society
has been involved in a workflow in some way:</p>
<ul>
<li>When you submit an insurance claim, you are initiating a workflow.</li>
<li>If you witness drunk and disorderly conduct on an airline flight and are asked
to provide a statement to the airline, you are participating in a workflow.
(Seriously, it happens more often than you'd think).</li>
<li>When you check on the status of your loan application, you are asking for
metadata about a running workflow.</li>
<li>When someone brings you a capital request that requires your approval because
it is over a certain dollar amount, a characteristic of that request (the dollar
amount) has triggered a decision within the workflow that routes the capital
request to you.</li>
<li>When you give the final approval for a piece of web content to be published,
it is likely you are completing a workflow.</li>
</ul>
<p>As varied as these examples are, all of them have a couple of things in common
that make them relevant to ECM:</p>
<ol>
<li>They are examples of human-to-human and, in some cases, human-to-machine
interaction</li>
<li>They are content- or document-centric.</li>
</ol>
<p>These are two very important characteristics that help clarify the kind of
workflow I am talking about. There are standalone workflow engines (in fact,
Activiti is one of them) that can be used to model and execute all sorts of
"repeatable patterns of activity", with or without content, but in the ECM
space, the patterns focused on most often are those that involve humans
working with content.</p>
<p>Of course document-centric workflows may include fully automated steps and
machine-to-machine interactions—the point is that document-centric workflows in
which humans review, approve, or collaborate in some way are in the scope of the
discussion while processes which run lights-out system-to-system orchestration
or integration are not.</p>
<h2 id="options-for-implementing-workflow-in-your-apps">Options for implementing workflow in your apps<a class="headerlink" href="#options-for-implementing-workflow-in-your-apps" title="Permanent link">&para;</a></h2>
<p>Some of you are saying, "You're right. Workflows are everywhere. I could really
streamline my organization by moving processes currently implemented with email,
phone calls, and cubical drive-bys into a more formalized workflow. What are my
options?" Let's talk about three: Roll your own, Standalone workflow engines,
and Embedded workflow engines.</p>
<h3 id="roll-your-own">Roll your own<a class="headerlink" href="#roll-your-own" title="Permanent link">&para;</a></h3>
<p>People are often tempted to meet their workflow requirements with custom code.
Very basic systems might be able to get by with a single flag on a record or an
object that declares the status of the content like "Draft" or "In Review" or
"Approved". But flags only capture the "state" of a piece of content. If you
want to automate <em>how</em> content moves from state to state, the coding and
maintenance becomes more complex. Sure, you can write code as part of your
application that knows that once Draft documents are submitted for review, they
need to go to Purchasing first and then to Finance, if and only if the requested
cash outlay is more than \$10m but do you really want to?</p>
<p>People intent on rolling their own workflow often realize the maintenance
problem this creates, so they create an abstraction used to describe the flow
from state-to-state that keeps them from embedding that logic in compiled code.
Once they've done that, though, they've essentially created their own
proprietary workflow engine that no one else in the world knows how to run or
maintain. And with all of the open source workflow engines available, why would
you want to do that? So the "roll your own" option is really not recommended for
any but the most basic workflow requirements.</p>
<h3 id="standalone-engines">Standalone engines<a class="headerlink" href="#standalone-engines" title="Permanent link">&para;</a></h3>
<p>There are a number of standalone workflow engines—sometimes more broadly
referred to as BPM (Business Process Management)—both open source and
proprietary. These are often extremely robust and scalable solutions that can be
used to model, simulate, and execute any process you can think of from
high-volume loan processing to call center queue management. Often, these
workflow engines are implemented in conjunction with a rules engine which lets
business users have control over complicated if-then-else decision trees.</p>
<p>Standalone engines are most appropriate for extremely high volume or exceedingly
complex solutions involving multiple systems. Another good use for standalone
engines is when you are developing a custom application that has workflow
requirements. Standalone engines can usually talk to any database or content
management repository you might have implemented, but they won't be as tightly
integrated into the content management system's user interface as the workflow
engine built-in to the CMS. For this reason, for content-centric solutions that
operate mostly within the scope of the CMS, it is usually less complicated (and
less costly) to use the workflow engine embedded within the CMS, provided it
has enough functionality to meet the business' workflow requirements.</p>
<h3 id="embedded-workflow-engines">Embedded workflow engines<a class="headerlink" href="#embedded-workflow-engines" title="Permanent link">&para;</a></h3>
<p>Almost every CMS available today, whether open source or proprietary, has a
workflow engine of some sort embedded within it. However, the capability of each
of these vary widely. If you are in the process of selecting a CMS and you
already know the kind of workflow requirements you'll face, it is important to
understand the capabilities of the workflow engine embedded within the systems
you are considering before making a final selection.</p>
<p>The major benefit of leveraging an embedded workflow engine is the tight level
of integration for users as well as developers. Users can initiate and interact
with workflows without leaving the CMS client. Typically, developers customizing
or extending the CMS can work with workflows using the core CMS API.</p>
<h2 id="out-of-the-box-workflow-options-in-alfresco">Out-of-the-box workflow options in Alfresco<a class="headerlink" href="#out-of-the-box-workflow-options-in-alfresco" title="Permanent link">&para;</a></h2>
<p>Alfresco has two options for implementing workflows within the product. For very
simplistic workflows, non-technical end-users can leverage Alfresco's Basic
Workflow functionality. For more complex needs, Alfresco has Advanced Workflow
functionality.</p>
<h3 id="basic-workflows">Basic workflows<a class="headerlink" href="#basic-workflows" title="Permanent link">&para;</a></h3>
<p>Basic workflows are a nice end-user tool. You should know how they work and what
the features and limitations are so you can make good decisions about when to
use them. Basic workflows use folders and a "forward step/backward step" model
to implement serial processes. When a piece of content is dropped in a folder, a
rule is triggered that associates a "forward step" and a "backward step" (one or
the other or both) with the content. These steps are tied to Alfresco actions
such as "Set a property" or "Move the content to a specified folder". End
users can then click on the appropriate step for a given piece of content.</p>
<p>For example, suppose SomeCo has a simple submit-review-approve process in which
content is submitted, then reviewed, then approved or rejected. One way to
implement this with basic workflows is to use three folders—let's say they are
called "Draft", "In Review", and "Approved"—each of which have a rule set that
applies a basic workflow. The workflow for content in the Draft folder would
have a single forward step labeled "Submit" and its action would move content to
the "In Review" folder and send an email to the approver group. The "In Review"
folder would have a workflow in which the forward step would be labeled
"Approve" and it would copy the content to an "Approved" folder. The backward
step would be labeled "Reject" and its action would move the content back to the
"Drafts" folder.</p>
<p>In the <a href="https://ecmarchitect.com/alfresco-developer-series-tutorials/actions/tutorial/tutorial.html">"Creating Custom Actions"</a>
tutorial, you created a custom rule action called "Move Replaced" that could be
used in conjunction with this basic workflow to move old content out of the
Approved folder and into an Archived folder, for example.</p>
<p>You can see that basic workflows are useful, and when combined with rules and
actions, you can automate simple business processes. But basic workflows are
limited with regard to the complexity of the business processes they can handle.</p>
<h3 id="advanced-workflows">Advanced workflows<a class="headerlink" href="#advanced-workflows" title="Permanent link">&para;</a></h3>
<p>Advanced workflows are useful when you need much more control over the business
process. Typical requirements that require the use of the advanced workflow
engine are things like:</p>
<ul>
<li>Assignment of tasks to specific users or groups</li>
<li>Parallel paths through the business process</li>
<li>Decisions based on content metadata or other criteria</li>
<li>The ability to handle exceptions</li>
<li>Timers</li>
</ul>
<p>All of these (and more) are features of the embedded Activiti workflow engine
which is what is used to implement advanced workflows in Alfresco.</p>
<p>Although I haven't yet covered the detailed capabilities of Alfresco advanced
workflows, I thought it would be a good idea to compare basic and advanced
workflows at a high level now so I can leave the topic of basic workflows behind
and spend the rest of the tutorial on advanced workflows:</p>
<table>
<thead>
<tr>
<th>Alfresco basic workflows...</th>
<th>Alfresco advanced workflows...</th>
</tr>
</thead>
<tbody>
<tr>
<td>Are configurable by non-technical end-users via Alfresco Share</td>
<td>Are defined by business analysts and developers using a graphical tool or by writing XML</td>
</tr>
<tr>
<td>Leverage rules, folders, and actions</td>
<td>Leverage the power of the embedded Activiti workflow engine</td>
</tr>
<tr>
<td>Can only handle processes with single-step, forward and/or backward, serial flows</td>
<td>Can model any business process including decisions, splits, joins, parallel flows, sub-processes, wait states, and timers</td>
</tr>
<tr>
<td>Do not support decisions, splits, joins, or parallel flows</td>
<td>Can include business logic written either in JavaScript or Java, either of which can access the Alfresco API</td>
</tr>
<tr>
<td>Do not maintain state or metadata about the process itself</td>
<td>Maintain state and process variables (metadata) about the process itself</td>
</tr>
<tr>
<td>Do not support the concept of task assignment</td>
<td>Support assigning tasks to individuals, groups, and pools of users</td>
</tr>
</tbody>
</table>
<p>Table: Difference between basic and advanced workflows</p>
<p>Now that you understand the definition of workflow in the context of ECM, some
of the options for implementing workflow requirements, and the options within
Alfresco specifically, it's time to start exploring some Activiti concepts.</p>
<h1 id="activiti-concepts">Activiti Concepts<a class="headerlink" href="#activiti-concepts" title="Permanent link">&para;</a></h1>
<p>This section introduces you to some Activiti concepts before moving on to the
developer setup.</p>
<h2 id="what-is-activiti">What is Activiti?<a class="headerlink" href="#what-is-activiti" title="Permanent link">&para;</a></h2>
<p>Activiti is an open source, standalone workflow engine. All it needs is Java.
It can run in a servlet container or it can be embedded in any Java application.
The Activiti engine is responsible for managing deployed processes,
instantiating and executing processes, persisting process state and metadata to
a relational database, and tracking task assignment and task lists.</p>
<p>Activiti is its own independent open source project. It just happens that the
founders of the project and several other members of the development team are
employed by Alfresco. Activiti is built to be embedded in any application that
has workflow requirements. What's cool is that the work of integrating it with
Alfresco has already been done for you.</p>
<h2 id="why-two-advanced-workflow-engines">Why two advanced workflow engines?<a class="headerlink" href="#why-two-advanced-workflow-engines" title="Permanent link">&para;</a></h2>
<p>I mentioned earlier that Alfresco started embedding JBoss jBPM in Alfresco with
release 1.4. Starting with Alfresco 4.0, Alfresco added Activiti.</p>
<p>Alfresco added Activiti because they wanted an Apache-licensed workflow engine.
JBoss was unwilling to change the jBPM license, so Alfresco hired jBPM creator,
Tom Baeyens, and some of his team to start a new open source project aimed at
building an Apache-licensed, BPMN 2.0 compliant workflow engine. The result is
Activiti.</p>
<p>In Alfresco 5.1, Alfresco dropped jBPM from the product and is moving forward
with Activiti. If you are on older versions of Alfresco and you are still using
jBPM, you should move to Activiti now.</p>
<h2 id="bpmn-20">BPMN 2.0<a class="headerlink" href="#bpmn-20" title="Permanent link">&para;</a></h2>
<p>I mentioned earlier that Activiti is BPMN 2.0-compliant. BPMN stands for
Business Process Modeling Notation. It's a specification managed by the Object
Management Group (OMG) that defines exactly what the name suggests: A standard
syntax for describing business processes. The specification is aimed at both
humans (i.e., graphical notation of a business process) and machines (i.e., XML
syntax describing the business process).</p>
<p>The two main benefits of using a BPMN-compliant workflow engine are:</p>
<ol>
<li>When business analysts collaborate on business process projects,
   they can use a common diagram and language to discuss the process,
   regardless of the tool that is ultimately used to implement it.</li>
<li>Any tool that produces BPMN-compliant XML can be used to define a
   business process and the resulting XML should theoretically work
   with any compliant workflow engine.</li>
</ol>
<h2 id="process-definitions">Process definitions<a class="headerlink" href="#process-definitions" title="Permanent link">&para;</a></h2>
<p>A business process can be described as a graph of connected nodes. In Activiti
(and really, in BPMN) these nodes are essentially events (start, stop, timer),
tasks, and gateways. These nodes are connected by "sequence flows". You can
model just about any business process you can think of by organizing events,
tasks, gateways, and sequence flows on a diagram.</p>
<p>The OMG has a great document called, "BPMN 2.0 by Example" that shows several
examples of business process diagrams and then walks you through each. There's a
link to it at the end of this document. The diagrams include features that may
not be included in the current release of Activiti, but they do illustrate the
kinds of things you can do with BPMN 2.0. For example, here's a diagram from
that document called "The Pizza Collaboration":</p>
<p><img alt="OMG's Pizza Collaboration Example" src="../images/omg-pizza-example.png" /></p>
<p>A process, then, is a collection of events, tasks (some automated, some
  performed by humans), and gateways, connected by sequence flows.</p>
<h1 id="setup">Setup<a class="headerlink" href="#setup" title="Permanent link">&para;</a></h1>
<p>It's almost time to roll up your sleeves. Let me tell you about the tools you'll
need and then give you a description of the project organization.</p>
<h2 id="tools">Tools<a class="headerlink" href="#tools" title="Permanent link">&para;</a></h2>
<p>Here is what I am using on my machine:</p>
<ul>
<li>MacOS 11.4</li>
<li>Java OpenJDK 11.0.2</li>
<li>Apache Maven 3.8.1</li>
<li>Alfresco Maven SDK 4.2 (No download necessary)</li>
<li>Docker 20.10.6</li>
<li>Docker Compose 1.29.1</li>
<li>Eclipse Java EE IDE for Web Developers, Neon</li>
<li>Activiti Eclipse BPMN 2.0 Designer 5.18 (<a href="http://www.activiti.org/designer/update/">Eclipse Update Site</a>)</li>
<li>Apache James 2.3.1 (for testing third-party notification via SMTP)</li>
</ul>
<p>By default, when you create an Alfresco project using the Alfresco Maven SDK the
project will be configured to depend on the latest stable Alfresco Community
Edition.</p>
<h2 id="project-organization">Project Organization<a class="headerlink" href="#project-organization" title="Permanent link">&para;</a></h2>
<p>I am going to use the Alfresco Maven SDK to create a project from the
"all-in-one" archetype that will package up my customizations in two AMPs
(Alfresco Module Packages). One AMP is for the Alfresco web application (the
"repo" tier) and the other is for the Alfresco Share web application (the
"Share" tier).</p>
<p>I am not going to spend much time talking about how the Alfresco Maven SDK
works. If you aren't already familiar with it, you may want to read the <a href="https://ecmarchitect.com/alfresco-developer-series">Getting Started with the Alfresco Maven SDK</a>
tutorial on ecmarchitect.com first and then come back to this one.</p>
<p>This tutorial relies on code from the <a href="https://ecmarchitect.com/alfresco-developer-series-tutorials/content/tutorial/tutorial.html">Custom Content Types</a>
tutorial. The tutorial assumes that the repo tier AMP and Share tier AMP created
during that tutorial have been installed into your local Maven repository.
Or, if you are deploying to an Alfresco server instead of running the Docker
images generated by the SDK, those AMPs need to be deployed to the Alfresco
server. More details on that will be discussed later in the document.</p>
<p>If you are planning on following along, go ahead and use the Alfresco Maven SDK
to create a new project from the "all-in-one" archetype. Use a <code>groupId</code> of
"com.someco" and an <code>artifactId</code> of "workflow-tutorial".</p>
<p>Starting with 3.0.0, the SDK will generate JAR files by default. We always want
to generate AMPs, not JARs, so edit the pom.xml file to uncomment
the maven-assembly-plugin.</p>
<p>We'll be running the project using Docker and Docker Compose. We can configure
the project to install AMPs from the earlier tutorials into the Docker
containers automatically. Edit the pom.xml file in the
"workflow-tutorial-platform-docker" directory to add the following dependencies:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;dependencies&gt;</span>
<span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
<span class="w">        </span><span class="nt">&lt;groupId&gt;</span>com.someco<span class="nt">&lt;/groupId&gt;</span>
<span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>workflow-tutorial-platform<span class="nt">&lt;/artifactId&gt;</span>
<span class="w">        </span><span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
<span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- Bring in the content tutorial repo AMP so we can run embedded. --&gt;</span>
<span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
<span class="w">        </span><span class="nt">&lt;groupId&gt;</span>com.someco<span class="nt">&lt;/groupId&gt;</span>
<span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>content-tutorial-platform<span class="nt">&lt;/artifactId&gt;</span>
<span class="w">        </span><span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
<span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- Bring in the behavior tutorial repo AMP so we can run embedded. --&gt;</span>
<span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
<span class="w">        </span><span class="nt">&lt;groupId&gt;</span>com.someco<span class="nt">&lt;/groupId&gt;</span>
<span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>behavior-tutorial-platform<span class="nt">&lt;/artifactId&gt;</span>
<span class="w">        </span><span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
<span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- Bring in the actions tutorial repo AMP so we can run embedded. --&gt;</span>
<span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
<span class="w">        </span><span class="nt">&lt;groupId&gt;</span>com.someco<span class="nt">&lt;/groupId&gt;</span>
<span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>actions-tutorial-platform<span class="nt">&lt;/artifactId&gt;</span>
<span class="w">        </span><span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
<span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span>
</code></pre></div>
<p>Those all have corresponding Share tier modules so edit the pom.xml file in the
"workflow-tutorial-share-docker" directory to add the following dependencies:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;dependencies&gt;</span>
<span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
<span class="w">        </span><span class="nt">&lt;groupId&gt;</span>com.someco<span class="nt">&lt;/groupId&gt;</span>
<span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>workflow-tutorial-share<span class="nt">&lt;/artifactId&gt;</span>
<span class="w">        </span><span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
<span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- Bring in the content tutorial share AMP so we can run embedded. --&gt;</span>
<span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
<span class="w">        </span><span class="nt">&lt;groupId&gt;</span>com.someco<span class="nt">&lt;/groupId&gt;</span>
<span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>content-tutorial-share<span class="nt">&lt;/artifactId&gt;</span>
<span class="w">        </span><span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
<span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- Bring in the behavior tutorial share AMP so we can run embedded. --&gt;</span>
<span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
<span class="w">        </span><span class="nt">&lt;groupId&gt;</span>com.someco<span class="nt">&lt;/groupId&gt;</span>
<span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>behavior-tutorial-share<span class="nt">&lt;/artifactId&gt;</span>
<span class="w">        </span><span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
<span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- Bring in the actions tutorial share AMP so we can run embedded. --&gt;</span>
<span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
<span class="w">        </span><span class="nt">&lt;groupId&gt;</span>com.someco<span class="nt">&lt;/groupId&gt;</span>
<span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>actions-tutorial-share<span class="nt">&lt;/artifactId&gt;</span>
<span class="w">        </span><span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
<span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span>
</code></pre></div>
<p>Now when we fire up the Docker containers the workflow AMPs will be installed
as well as the AMPs from the earlier content, behavior, and actions tutorials.</p>
<p>If you have not installed those artifacts into your local Maven repository,
switch to the root of each of those earlier tutorial projects and run
<code>mvn install -DskipTests</code> to do so now.</p>
<h1 id="hello-world-examples">Hello World Examples<a class="headerlink" href="#hello-world-examples" title="Permanent link">&para;</a></h1>
<p>Let's create a couple of super simple Hello World processes using the Activiti
Process Designer. These processes will not be wired into the Alfresco web client
user interface. Instead, I'll use the workflow console to start them. Once I've
run through the basic steps of diagramming and deploying workflows, I'll show
you examples that are fully integrated into the user interface.</p>
<h2 id="the-helloworld-process">The helloWorld process<a class="headerlink" href="#the-helloworld-process" title="Permanent link">&para;</a></h2>
<p>The helloWorld process will consist of a start event, a user task, and an end
event. The goal is to do nothing more than write "Hello, World!" to the Alfresco
log.</p>
<p>Workflows reside in:</p>
<div class="highlight"><pre><span></span><code>$TUTORIAL_HOME/workflow-tutorial-platform/src/main/resources/alfresco/module/workflow-tutorial-platform/workflow
</code></pre></div>
<p>When you created the workflow-tutorial project using the Alfresco Maven SDK, the
folder structure was created for you, and it may have included a "workflow"
directory in the workflow-tutorial-platform module with a sample workflow.
If so, you can delete the sample workflow. If not, create the "workflow"
directory now.</p>
<p>Once that is done, follow these steps:</p>
<ol>
<li>Right-click the workflows folder and choose New, Other, Activiti Diagram.
Specify "<a href="https://github.com/jpotts/alfresco-developer-series/blob/master/workflow/workflow-tutorial/workflow-tutorial-platform/src/main/resources/alfresco/module/workflow-tutorial-platform/workflow/helloWorld.bpmn">helloWorld.bpmn</a>"
for the process name and click Finish.</li>
<li>Drag-and-drop a start event, a user task and an end event from the palette
onto your blank canvas.</li>
<li>Connect the start event to the user task and the user task to the end event
using sequence flows from the palette. When you are done, the diagram should
look like this:</li>
</ol>
<p><img alt="Hello World BPMN Diagram" src="../images/hello-world-bpmn.png" /></p>
<ol>
<li>If it isn't open already, open the "Properties" view by going to Window, Show
View, Other, General, Properties.</li>
<li>Make sure "Select" is clicked in the palette, then single-click the "User
Task" task.</li>
<li>Specify "\${initiator.properties.userName}" as the assignee, as shown below:</li>
</ol>
<p><img alt="Hello World user task properties" src="../images/hello-world-properties.png" /></p>
<ol>
<li>Click somewhere on the canvas. This should display the "Process" tab in the
Properties viewer. Specify "helloWorld" as the ID and "Hello World" as the Name.</li>
</ol>
<p><img alt="Hello World user task properties" src="../images/hello-world-process-properties.png" /></p>
<ol>
<li>Save and close the diagram.</li>
</ol>
<p>Let's put a little logger statement in the process to see how to add code to a
process. Activiti supports multiple scripting languages, but in Alfresco's
embedded Activiti, JavaScript is the most practical because it gives you access
to the full JavaScript API.</p>
<p>To add code to the process, re-open the "helloWorld.bpmn" file in the XML editor
instead of the diagram editor and look for the sequence flow that connects the
start event to the user task. It should look something like this:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;sequenceFlow</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;flow1&quot;</span><span class="w"> </span><span class="na">sourceRef=</span><span class="s">&quot;startevent1&quot;</span><span class="w"> </span><span class="na">targetRef=</span><span class="s">&quot;usertask1&quot;</span><span class="nt">&gt;&lt;/sequenceFlow&gt;</span>
</code></pre></div>
<p>Note that your <code>id</code> attribute value may be different than mine depending on what
order you created the sequence flow.</p>
<p>Activiti has all kinds of hook points for custom code. To log a message when
this sequence flow starts, add an execution listener on the flow, like this:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;sequenceFlow</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;flow1&quot;</span><span class="w"> </span><span class="na">sourceRef=</span><span class="s">&quot;startevent1&quot;</span><span class="w"> </span><span class="na">targetRef=</span><span class="s">&quot;usertask1&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;extensionElements&gt;</span>
<span class="w">        </span><span class="nt">&lt;activiti:executionListener</span><span class="w"> </span><span class="na">event=</span><span class="s">&quot;start&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.alfresco.repo.workflow.activiti.listener.ScriptExecutionListener&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;activiti:field</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;script&quot;</span><span class="nt">&gt;</span>
<span class="w">                </span><span class="nt">&lt;activiti:string&gt;</span>logger.log(&quot;Hello,<span class="w"> </span>World!&quot;);<span class="nt">&lt;/activiti:string&gt;</span>
<span class="w">            </span><span class="nt">&lt;/activiti:field&gt;</span>
<span class="w">        </span><span class="nt">&lt;/activiti:executionListener&gt;</span>
<span class="w">    </span><span class="nt">&lt;/extensionElements&gt;</span>
<span class="nt">&lt;/sequenceFlow&gt;</span>
</code></pre></div>
<p>Now save the diagram.</p>
<p>Look at the <code>activiti:executionListener</code> element. You can see from the <code>event</code>
attribute that this script will be fired when the "start" event for this
sequence flow happens. The <code>class</code> attribute specifies the class to invoke which
is an out-of-the-box class called <code>ScriptExecutionListener</code>. The
<code>activiti:string</code> element could contain any server-side JavaScript. For right
now it is a simple logger statement. In a later example, you'll see how to
iterate over the documents in the workflow package.</p>
<p>You're going to run this process shortly. Before that, let's create another
simple process to see how forks work.</p>
<h2 id="the-helloworldfork-process">The helloWorldFork process<a class="headerlink" href="#the-helloworldfork-process" title="Permanent link">&para;</a></h2>
<p>Before I show you how to deploy the process definition to Alfresco, let's do
another Hello World example that does a fork and a join.</p>
<p>Do this:</p>
<ol>
<li>Create a new diagram in the workflows folder called "<a href="https://github.com/jpotts/alfresco-developer-series/blob/master/workflow/workflow-tutorial/workflow-tutorial-platform/src/main/resources/alfresco/module/workflow-tutorial-platform/workflow/helloWorldFork.bpmn">helloWorldFork.bpmn</a>".</li>
<li>From the palette, grab a start event, an end event, two user tasks, and two
parallel gateways.</li>
<li>Click "Select" in the palette, then click each of the two user tasks to
change their names to "User Task A" and "User Task B" respectively.</li>
<li>Click "Sequence Flow" in the palette and connect the nodes in the diagram so
it looks like this:</li>
</ol>
<p><img alt="Hello World Fork BPMN Diagram" src="../images/hello-world-fork.png" /></p>
<ol>
<li>Click somewhere on the canvas. This should display the "Process" tab in the
Properties viewer. Specify "helloWorldFork" as the ID and "Hello World Fork" as
the Name.</li>
<li>Save and close the diagram.</li>
</ol>
<p>Now you have a business process with two parallel paths of execution. If you
wanted the process to go to either User Task A or User Task B, but not both, you
would use an exclusive gateway instead of a parallel gateway.</p>
<p>Similar to the first example, let's add a logger statement to the sequence flows
leading to the two user tasks. Open helloWorldFork.bpmn in the XML editor and
add two new <code>extensionElements</code> elements, one in each of the <code>sequenceFlow</code>
elements that lead to "usertask1" and "usertask2":</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;sequenceFlow</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;flow2&quot;</span><span class="w"> </span><span class="na">sourceRef=</span><span class="s">&quot;parallelgateway1&quot;</span><span class="w"> </span><span class="na">targetRef=</span><span class="s">&quot;usertask1&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;extensionElements&gt;</span>
<span class="w">        </span><span class="nt">&lt;activiti:executionListener</span><span class="w"> </span><span class="na">event=</span><span class="s">&quot;start&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.alfresco.repo.workflow.activiti.listener.ScriptExecutionListener&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;activiti:field</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;script&quot;</span><span class="nt">&gt;</span>
<span class="w">                </span><span class="nt">&lt;activiti:string&gt;</span>
<span class="w">                    </span>logger.log(&quot;Hello,<span class="w"> </span>World,<span class="w"> </span>from<span class="w"> </span>transition<span class="w"> </span>to<span class="w"> </span>User<span class="w"> </span>Task<span class="w"> </span>A!&quot;);
<span class="w">                </span><span class="nt">&lt;/activiti:string&gt;</span>
<span class="w">            </span><span class="nt">&lt;/activiti:field&gt;</span>
<span class="w">        </span><span class="nt">&lt;/activiti:executionListener&gt;</span>
<span class="w">    </span><span class="nt">&lt;/extensionElements&gt;</span>
<span class="nt">&lt;/sequenceFlow&gt;</span>
<span class="nt">&lt;sequenceFlow</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;flow3&quot;</span><span class="w"> </span><span class="na">sourceRef=</span><span class="s">&quot;parallelgateway1&quot;</span><span class="w"> </span><span class="na">targetRef=</span><span class="s">&quot;usertask2&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;extensionElements&gt;</span>
<span class="w">        </span><span class="nt">&lt;activiti:executionListener</span><span class="w"> </span><span class="na">event=</span><span class="s">&quot;start&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.alfresco.repo.workflow.activiti.listener.ScriptExecutionListener&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;activiti:field</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;script&quot;</span><span class="nt">&gt;</span>
<span class="w">                </span><span class="nt">&lt;activiti:string&gt;</span>
<span class="w">                    </span>logger.log(&quot;Hello,<span class="w"> </span>World,<span class="w"> </span>from<span class="w"> </span>transition<span class="w"> </span>to<span class="w"> </span>User<span class="w"> </span>Task<span class="w"> </span>B!&quot;);
<span class="w">                </span><span class="nt">&lt;/activiti:string&gt;</span>
<span class="w">            </span><span class="nt">&lt;/activiti:field&gt;</span>
<span class="w">        </span><span class="nt">&lt;/activiti:executionListener&gt;</span>
<span class="w">    </span><span class="nt">&lt;/extensionElements&gt;</span>
<span class="nt">&lt;/sequenceFlow&gt;</span>
</code></pre></div>
<p>Remember to save the diagram.</p>
<p>With a couple of, admittedly, ridiculously simple examples saved in the
workflow-tutorial-platform module, it is time to deploy them to Activiti
running within Alfresco and try them out.</p>
<h2 id="deploying-processes">Deploying processes<a class="headerlink" href="#deploying-processes" title="Permanent link">&para;</a></h2>
<p>There are two other options for deploying workflows to Alfresco:</p>
<ol>
<li>Use the Alfresco Workflow Console</li>
<li>Configure the workflows through Spring configuration</li>
</ol>
<p>This tutorial will use Spring to deploy the workflows initially. Then, use the
Alfresco Workflow Console to deploy subsequent versions if needed.</p>
<h3 id="deploying-the-workflows-with-spring">Deploying the workflows with Spring<a class="headerlink" href="#deploying-the-workflows-with-spring" title="Permanent link">&para;</a></h3>
<p>As you learned in previous tutorials, the AMP project created by the Alfresco
Maven SDK already has a Spring context file. It is named "<a href="https://github.com/jpotts/alfresco-developer-series/blob/master/workflow/workflow-tutorial/workflow-tutorial-platform/src/main/resources/alfresco/module/workflow-tutorial-platform/context/bootstrap-context.xml">bootstrap-context.xml</a>" and resides in:</p>
<div class="highlight"><pre><span></span><code>$TUTORIAL_HOME/workflow-tutorial-platform/src/main/resources/alfresco/module/workflow-tutorial-platform/context
</code></pre></div>
<p>Edit that file and delete any existing bean elements that the SDK might have
added for you. Then, add a workflow deployer bean, like this:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;${project.artifactId}.workflowBootstrap&quot;</span><span class="w"> </span><span class="na">parent=</span><span class="s">&quot;workflowDeployer&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;workflowDefinitions&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;list&gt;</span>
<span class="w">            </span><span class="nt">&lt;props&gt;</span>
<span class="w">                </span><span class="nt">&lt;prop</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;engineId&quot;</span><span class="nt">&gt;</span>activiti<span class="nt">&lt;/prop&gt;</span>
<span class="w">                </span><span class="nt">&lt;prop</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;location&quot;</span><span class="nt">&gt;</span>alfresco/module/${project.artifactId}/workflow/helloWorld.bpmn<span class="nt">&lt;/prop&gt;</span>
<span class="w">                </span><span class="nt">&lt;prop</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;mimetype&quot;</span><span class="nt">&gt;</span>text/xml<span class="nt">&lt;/prop&gt;</span>
<span class="w">                </span><span class="nt">&lt;prop</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;redeploy&quot;</span><span class="nt">&gt;</span>false<span class="nt">&lt;/prop&gt;</span>
<span class="w">            </span><span class="nt">&lt;/props&gt;</span>
<span class="w">            </span><span class="nt">&lt;props&gt;</span>
<span class="w">                </span><span class="nt">&lt;prop</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;engineId&quot;</span><span class="nt">&gt;</span>activiti<span class="nt">&lt;/prop&gt;</span>
<span class="w">                </span><span class="nt">&lt;prop</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;location&quot;</span><span class="nt">&gt;</span>alfresco/module/${project.artifactId}/workflow/helloWorldFork.bpmn<span class="nt">&lt;/prop&gt;</span>
<span class="w">                </span><span class="nt">&lt;prop</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;mimetype&quot;</span><span class="nt">&gt;</span>text/xml<span class="nt">&lt;/prop&gt;</span>
<span class="w">                </span><span class="nt">&lt;prop</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;redeploy&quot;</span><span class="nt">&gt;</span>false<span class="nt">&lt;/prop&gt;</span>
<span class="w">            </span><span class="nt">&lt;/props&gt;</span>
<span class="w">        </span><span class="nt">&lt;/list&gt;</span>
<span class="w">    </span><span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</code></pre></div>
<p>Setting "redeploy" to false prevents the workflows from being redeployed every
time Alfresco restarts.</p>
<p>The JavaScript in these business processes contain "logger" statements. To get
those to show up in the log, edit the <a href="https://github.com/jpotts/alfresco-developer-series/blob/master/workflow/workflow-tutorial/workflow-tutorial-platform-docker/src/main/docker/dev-log4j.properties">dev-log4j.properties</a>
file that is in the workflow-tutorial-platform-docker module. It resides in:</p>
<div class="highlight"><pre><span></span><code>$TUTORIAL_HOME/workflow-tutorial-platform-docker/src/main/docker
</code></pre></div>
<p>Change the <code>ScriptLogger</code> to debug by changing this line:</p>
<div class="highlight"><pre><span></span><code>log4j.logger.org.alfresco.repo.jscript.ScriptLogger=DEBUG
</code></pre></div>
<p>Now everything is ready to go. For this test, you can leverage the SDK-generated
Docker images that the Alfresco Maven SDK sets up for you. To run your AMPs in
Docker, open a command-line window, switch to $TUTORIAL_HOME, and run
<code>./run.sh build_start</code> (or <code>run.bat</code> depending on your operating system).</p>
<p>Apache Maven will download some dependencies, build your AMPs, merge them with
the Alfresco WAR file and Share WAR file, then use Docker Compose to start up
containers for Alfresco, Share, PostgreSQL, and SOLR.</p>
<p>Next you'll see how to use the Alfresco Workflow Console to test the two hello
world process definitions.</p>
<h2 id="using-the-workflow-console">Using the workflow console<a class="headerlink" href="#using-the-workflow-console" title="Permanent link">&para;</a></h2>
<p>Your Alfresco server is running and the hello world process definitions should
have been deployed when the server started up. The Alfresco Workflow Console can
be used to verify that they were deployed successfully. And you can use it to
start instances of those workflows to test them out. It can also be a handy
workflow debugging tool.</p>
<p>In Alfresco Enterprise, the Workflow Console link is: <a href="http://localhost:8080/alfresco/s/enterprise/admin/admin-workflowconsole">http://localhost:8080/alfresco/s/enterprise/admin/admin-workflowconsole</a></p>
<p>In Alfresco Community, the Workflow Console link is:
<a href="http://localhost:8080/alfresco/s/admin/admin-workflowconsole">http://localhost:8080/alfresco/s/admin/admin-workflowconsole</a></p>
<p>If you haven't already authenticated as an administrator you will be asked to do
so when you go to that URL.</p>
<p>In the workflow console do this:</p>
<ol>
<li>
<p>Type "show definitions all" then click Execute to see what process
definitions have been deployed:</p>
<p><img alt="Workflow console: Show definitions all" src="../images/workflow-console.png" /></p>
</li>
</ol>
<p>You should see entries for helloWorld and helloWorldFork. Note that the ID for
helloWorld is "activiti$helloWorld:1:104" and the ID for helloWorldFork is
"activiti$helloWorldFork:1:108". Your IDs may be different.</p>
<ol>
<li>Type "use definition activiti\$helloWorld:1:104" and click Execute.
Subsequent commands having to do with a workflow definition will now use that
one by default.</li>
<li>
<p>Start an instance of the helloWorld workflow by typing "start" and clicking
Execute. You should see something like this:</p>
<p><img alt="Workflow console: Start workflow" src="../images/workflow-console-start-workflow.png" /></p>
</li>
</ol>
<p>And in the server log, the logger output appears:</p>
<p><img alt="Hello World log output" src="../images/hello-world-log-output.png" /></p>
<p>Now follow the same steps to start an instance of the <code>helloWorldFork</code> process.
You should see log messages from both tasks.</p>
<p><img alt="Hello World log output" src="../images/hello-world-fork-log-output.png" /></p>
<p>After running helloWorldFork go back to the workflow console and type "show
workflows all" and click Execute. That command shows the running workflow
instances. You'll notice that the helloWorldFork workflow is still running.
The easiest way to get rid of it is to use the "delete workflow [workflow ID]"
command (you'll need the workflow's ID from the "show workflows all" command you
just completed).</p>
<p>You've seen how to start workflows and how to list and delete running workflows
using the workflow console. The table below shows some other common commands and
what they do.</p>
<table>
<thead>
<tr>
<th>Command</th>
<th>What it does</th>
</tr>
</thead>
<tbody>
<tr>
<td>show workflows all</td>
<td>Shows all running workflows.</td>
</tr>
<tr>
<td>use workflow \&lt;workflow id&gt; where \&lt;workflow id&gt; is something like activiti\$6300</td>
<td>Makes all subsequent commands happen in the context of the specified workflow.</td>
</tr>
<tr>
<td>show transitions</td>
<td>Shows all leaving transitions.</td>
</tr>
<tr>
<td>signal \&lt;path id&gt; \&lt;transition&gt; where \&lt;path id&gt; is something like activiti\$6334 and transition is the name of the leaving transition you want to take. Leave off the transition to take the default.</td>
<td>Signals the token. Good when your workflow is stuck on a node or when you want to take a transition without fooling with the task management UI.</td>
</tr>
<tr>
<td>desc path \&lt;path id&gt; where \&lt;path id&gt; is something like activiti\$6334</td>
<td>Dumps the current context. Great for debugging process variables.</td>
</tr>
<tr>
<td>end workflow \&lt;workflow id&gt; where \&lt;workflow id&gt; is something like activiti\$6300</td>
<td>Cancels the specified workflow.</td>
</tr>
<tr>
<td>show definitions all</td>
<td>Shows the current deployed workflows.</td>
</tr>
<tr>
<td>undeploy definition \&lt;workflow id&gt; or undeploy definition name \&lt;workflow name&gt;</td>
<td>Undeploys the specified workflow and stops any workflows running with that definition. The \&lt;workflow id&gt; variant undeploys a specific version of a workflow.</td>
</tr>
</tbody>
</table>
<p>Table: Partial list of workflow console commands</p>
<p>These are a subset of the commands available. Type "help" and click Execute to
see the full list of commands.</p>
<p>You may be wondering what happens to running workflow instances when a new
version of the process definition is checked in. The answer is that Activiti
handles that—it makes sure that running workflows continue to run with their
original process definition. By default, all new workflows will use the most
current version of the process definition.</p>
<h1 id="configuring-a-workflow-for-alfresco-share">Configuring a workflow for Alfresco Share<a class="headerlink" href="#configuring-a-workflow-for-alfresco-share" title="Permanent link">&para;</a></h1>
<p>So far you've learned what a workflow is and some Activiti concepts. You used
the process designer to diagram two simple processes, deployed those to
Alfresco, and ran them using the workflow console. This part of the tutorial
explains how to configure a workflow in the Alfresco Share user interface.</p>
<p>Workflows are configured for the Alfresco Share user interface through the form
service. Recall from the custom content types stutorial that the form service
uses the content model XML and the Share form configuration to generate a nice
form for end users. Configuring a workflow works exactly the same way: you
configure a content model that maps to a business process definition, then
configure the form service to produce a form for that model.</p>
<p>At a high level, then, the steps are:</p>
<ol>
<li>Define a process using the Activiti Process Designer.</li>
<li>Define a content model for your workflow in which workflow tasks map to
content types. There will never be instances of these content types--they are
solely for the purpose of defining forms that the Alfresco Share form service
will understand.</li>
<li>Configure the Alfresco Share user interface. Recall from the custom content
types tutorial that share-config-custom.xml is used to configure the Alfresco
Share web client.</li>
</ol>
<p>With that in mind, let's do one more hello world example. This time, the example
will use Alfresco Share form configuration. After that, you'll be ready to work
through a more real world example that builds upon the SomeCo work started in
previous tutorials.</p>
<h2 id="step-1-define-the-helloworldui-process">Step 1: Define the helloWorldUI process<a class="headerlink" href="#step-1-define-the-helloworldui-process" title="Permanent link">&para;</a></h2>
<p>The goal for this example is to create a workflow that will capture a piece of
metadata (a name the logger should use for a greeting) when the workflow is
submitted, and then write the greeting out to the log. The first step is to
define the process.</p>
<ol>
<li>In Eclipse, right-click on the "workflows" folder and create a new Activiti
Diagram named "<a href="https://github.com/jpotts/alfresco-developer-series/blob/master/workflow/workflow-tutorial/workflow-tutorial-platform/src/main/resources/alfresco/module/workflow-tutorial-platform/workflow/helloWorldUI.bpmn">helloWorldUI.bpmn</a>".</li>
<li>From the palette, drag a start event, an end event, an Alfresco User Task,
and an Alfresco Script task onto the canvas. You'll see the benefit of using the
Alfresco-specific User Task and Script Task shortly.</li>
<li>
<p>Click "Sequence Flow" in the palette and then connect the nodes in the
process to look like this:</p>
<p><img alt="Hello World UI BPMN Diagram" src="../images/hello-world-ui-bpmn.png" /></p>
</li>
<li>
<p>Now set the properties on the Alfresco User Task. Set the performer type to
"Assignee" and the expression to "${initiator.properties.userName}". This is the
equivalent to what you've done in the first two hello world examples, it's just
that this panel uses two separate fields for the performer type and the
expression.</p>
</li>
<li>
<p>Now set the form key. In Alfresco, a form key is the name of a type in a
workflow-specific content model. Because this is an Alfresco User Task instead
of a generic User Task, it already knows the possible values for the
out-of-the-box form keys. Set the form key to "wf:activitiReviewTask". The
out-of-the-box workflow content model has a type by that name and the
out-of-the-box form configuration is already set up to create a form for the
properties defined as part of that type.</p>
<p><img alt="Alfresco User Task properties" src="../images/user-task-properties.png" /></p>
</li>
<li>
<p>The requirement is to let the workflow initiator specify a name that the
logger will use in a greeting. So the start event needs to point to a custom
form key (which represents a custom content type you'll create shortly).
Single-click the start event, then set the form key to
"scwf:submitHelloWorldTask".</p>
<p><img alt="Start event properties" src="../images/start-event-properties.png" /></p>
</li>
<li>
<p>Single-click the canvas to open the properties editor for the process. Set
the ID to "helloWorldUI" and the name to "Hello World UI".</p>
</li>
<li>Save and close the diagram.</li>
</ol>
<h3 id="tasks">Tasks<a class="headerlink" href="#tasks" title="Permanent link">&para;</a></h3>
<p>You saw in the steps above that tasks can be assigned to human performers.
Activiti maintains a list of tasks assigned to each participant. How users
interact with the task list is up to each application. In Alfresco, a dashlet
displays a to-do list for the currently logged in user. As users complete their
tasks the tasks are removed from the to-do list. An empty to do list is shown
below.</p>
<p><img alt="An empty task list in Alfresco Share" src="../images/my-tasks-dashlet-empty.png" /></p>
<h3 id="task-assignment">Task Assignment<a class="headerlink" href="#task-assignment" title="Permanent link">&para;</a></h3>
<p>If tasks are steps a human performs, how do tasks get assigned to the people who
need to perform them? Activiti has extended BPMN with their own attribute called
"activiti:assignee". The value of the attribute can be a literal username or
group name, or it can be an expression. In this case you assigned the user task
to \${initiator.properties.userName}. Initiator is a special object that will
always contain the object representing the person who started the workflow.</p>
<p>The diagram is now complete and ready for some server-side JavaScript to be
added.</p>
<h3 id="add-logic-to-the-process-definition">Add logic to the process definition<a class="headerlink" href="#add-logic-to-the-process-definition" title="Permanent link">&para;</a></h3>
<p>The diagram is done. Let's add some logic.</p>
<p>Similar to earlier hello world examples, let's add a logger statement to print a
greeting. The difference is that in this example, the greeting includes a
person's name that was specified in a form when the initiator started the
workflow.</p>
<h4 id="process-variables">Process Variables<a class="headerlink" href="#process-variables" title="Permanent link">&para;</a></h4>
<p>Often, there is metadata about a process that needs to be tracked. In this case,
the metadata is the person's name. The person's name isn't really a property of
the content being routed through the workflow—it's a property of the process
itself. Activiti gives us the ability to store this kind of data as part of the
running process through <em>process variables.</em></p>
<p>Process variables are name-value pairs that will get persisted with the rest of
the process state.</p>
<h4 id="try-it">Try It<a class="headerlink" href="#try-it" title="Permanent link">&para;</a></h4>
<p>To add a logger statement with a process variable to the helloWorldUI example,
do this:</p>
<p>Open helloWorldUI.bpmn in the XML editor.</p>
<p>Find the <code>sequenceFlow</code> element that goes from the start event to the user task
and add the following <code>extensionElements</code> element:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;sequenceFlow</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;flow1&quot;</span><span class="w"> </span><span class="na">sourceRef=</span><span class="s">&quot;startevent1&quot;</span><span class="w"> </span><span class="na">targetRef=</span><span class="s">&quot;alfrescoUsertask1&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;extensionElements&gt;</span>
<span class="w">        </span><span class="nt">&lt;activiti:executionListener</span><span class="w"> </span><span class="na">event=</span><span class="s">&quot;start&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.alfresco.repo.workflow.activiti.listener.ScriptExecutionListener&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;activiti:field</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;script&quot;</span><span class="nt">&gt;</span>
<span class="w">                </span><span class="nt">&lt;activiti:string&gt;</span>logger.log(&quot;Hello,<span class="w"> </span>&quot;<span class="w"> </span>+<span class="w"> </span>scwf_helloName<span class="w"> </span>+<span class="w"> </span>&quot;!&quot;);<span class="nt">&lt;/activiti:string&gt;</span>
<span class="w">            </span><span class="nt">&lt;/activiti:field&gt;</span>
<span class="w">        </span><span class="nt">&lt;/activiti:executionListener&gt;</span>
<span class="w">    </span><span class="nt">&lt;/extensionElements&gt;</span>
<span class="nt">&lt;/sequenceFlow&gt;</span>
</code></pre></div>
<p>The <code>scwf_helloName</code> variable maps to a property defined in the
<code>scwf:submitHelloWorldTask</code> type. You'll define that later.</p>
<p>The review task lets the user select "approve" or "reject". The execution of the
workflow needs the value of that selection. Add the logic needed to make that
happen:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;userTask</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;alfrescoUsertask1&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;Alfresco User Task&quot;</span><span class="w"> </span><span class="na">activiti:assignee=</span><span class="s">&quot;${initiator.properties.userName}&quot;</span><span class="w"> </span><span class="na">activiti:formKey=</span><span class="s">&quot;wf:activitiReviewTask&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;extensionElements&gt;</span>
<span class="w">        </span><span class="nt">&lt;activiti:taskListener</span><span class="w"> </span><span class="na">event=</span><span class="s">&quot;complete&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;activiti:field</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;script&quot;</span><span class="nt">&gt;</span>
<span class="w">                </span><span class="nt">&lt;activiti:string&gt;</span>execution.setVariable(&#39;wf_reviewOutcome&#39;,<span class="w"> </span>task.getVariable(&#39;wf_reviewOutcome&#39;));<span class="nt">&lt;/activiti:string&gt;</span>
<span class="w">            </span><span class="nt">&lt;/activiti:field&gt;</span>
<span class="w">        </span><span class="nt">&lt;/activiti:taskListener&gt;</span>
<span class="w">    </span><span class="nt">&lt;/extensionElements&gt;</span>
<span class="nt">&lt;/userTask&gt;</span>
</code></pre></div>
<p>And, finally, just to show that a value can be set in one task and read in
another, let's log the value of the approve/reject selection from within the
Alfresco Script service task:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;serviceTask</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;alfrescoScripttask1&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;Alfresco Script Task&quot;</span><span class="w"> </span><span class="na">activiti:class=</span><span class="s">&quot;org.alfresco.repo.workflow.activiti.script.AlfrescoScriptDelegate&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;extensionElements&gt;</span>
<span class="w">        </span><span class="nt">&lt;activiti:field</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;script&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;activiti:string&gt;</span>logger.log(&quot;The<span class="w"> </span>outcome<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span>review<span class="w"> </span>task<span class="w"> </span>is:<span class="w"> </span>&quot;<span class="w"> </span>+<span class="w"> </span>wf_reviewOutcome);<span class="nt">&lt;/activiti:string&gt;</span>
<span class="w">        </span><span class="nt">&lt;/activiti:field&gt;</span>
<span class="w">    </span><span class="nt">&lt;/extensionElements&gt;</span>
<span class="nt">&lt;/serviceTask&gt;</span>
</code></pre></div>
<p>Now the process is ready to go. The next step is to get the workflow content
model squared away.</p>
<h2 id="step-2-define-a-workflow-specific-content-model">Step 2: Define a workflow-specific content model<a class="headerlink" href="#step-2-define-a-workflow-specific-content-model" title="Permanent link">&para;</a></h2>
<p>The workflow-specific content model defines the data structure for the process.
Workflow models use the same fundamental building blocks—types, properties,
aspects, and associations—as "normal" Alfresco content model definitions. In
fact, if you already have a custom model, you can define your workflow-specific
model in the same content model XML file, although to reduce confusion, I
recommend you keep your content types separate from your workflow types by using
at least two different model files.</p>
<p>What is the purpose of the workflow-specific model? Think of it like any other
content model. Custom content models are used to define the metadata that needs
to be captured about a piece of content. The metadata (properties) are grouped
into types and aspects. By virtue of defining these properties as part of the
content model, Alfresco takes care of persisting the data to the underlying
database.</p>
<p>Workflow models function in the same way. Suppose you have a process in which
three different departments are involved in an approval process. Maybe you'd
like the workflow initiator to be able to define which of those departments are
required approvers and which are optional or "FYI" reviewers. A workflow model
defines how that information is going to be stored.</p>
<p>As in other content models, you don't have to start from scratch. Alfresco ships
out-of-the-box with some workflow-specific types already defined. There are two
model definition files related to this. One is called called bpmModel.xml. It
resides in your Alfresco web application root under
WEB-INF/classes/alfresco/model. The other is called workflowModel.xml and it
resides under WEB-INF/classes/alfresco/workflow.</p>
<p>The <strong>bpmModel</strong> file contains the lowest-level workflow classes such as the
base definition for all tasks and the default start task. It also contains
important aspects such as a set of "assignee" aspects that define associations
between tasks and users or groups.</p>
<p>The <strong>workflowModel</strong> file contains the content model for the out-of-the-box
process definitions. This model file offers a lot of potential for reuse in your
custom processes. For example, if your process starts by allowing the submitter
to specify a list of several people to receive a task, you could use the
<code>wf:submitParallelReviewTask</code> type. If you want to base an approval on the
percentage of individuals who approve a task, you can use the
<code>wf:submitConcurrentReviewTask</code> type. Of course just like any model you are free
to use these as-is, extend them, or not use them at all.</p>
<p>When users interact with the workflow via the web client, Alfresco will use the
workflow content model and the Alfresco Share form service configuration to
figure out what metadata to expose to the UI and how to present it just as it
does when viewing content properties. In Activiti, Alfresco uses the value of
the form key attribute to figure out the appropriate workflow content type. So,
<strong>all tasks in which there are Alfresco web client user interactions must be
given a form key that corresponds to the name of a workflow content type.</strong></p>
<h3 id="create-the-workflow-content-model-xml">Create the workflow content model XML<a class="headerlink" href="#create-the-workflow-content-model-xml" title="Permanent link">&para;</a></h3>
<p>In the helloWorldUI example, you defined the following start event:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;startEvent</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;startevent1&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;Start&quot;</span><span class="w"> </span><span class="na">activiti:formKey=</span><span class="s">&quot;scwf:submitHelloWorldTask&quot;</span><span class="nt">&gt;&lt;/startEvent&gt;</span>
</code></pre></div>
<p>Now you need to create a content model with a custom type that corresponds to
the form key value. From previous tutorials you know that models are defined in
XML and reside in:</p>
<div class="highlight"><pre><span></span><code>$TUTORIAL_HOME/workflow-tutorial-platform/src/main/resources/alfresco/module/workflow-tutorial-platform/model
</code></pre></div>
<p>The SDK has already created the "model" folder for you as well as a couple of
sample model files. Go ahead and delete the sample model files as they will not
be needed.</p>
<p>In the model folder, create a new content model XML file called "<a href="https://github.com/jpotts/alfresco-developer-series/blob/master/workflow/workflow-tutorial/workflow-tutorial-platform/src/main/resources/alfresco/module/workflow-tutorial-platform/model/scWorkflowModel.xml">scWorkflowModel.xml</a>"
with the following content:</p>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cm">&lt;!-- Definition of new Model --&gt;</span>
<span class="nt">&lt;model</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;scwf:workflowmodel&quot;</span>
<span class="w">    </span><span class="na">xmlns=</span><span class="s">&quot;http://www.alfresco.org/model/dictionary/1.0&quot;</span><span class="nt">&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- Optional meta-data about the model --&gt;</span>
<span class="w">    </span><span class="nt">&lt;description&gt;</span>Someco<span class="w"> </span>Workflow<span class="w"> </span>Model<span class="nt">&lt;/description&gt;</span>
<span class="w">    </span><span class="nt">&lt;author&gt;</span>Jeff<span class="w"> </span>Potts<span class="nt">&lt;/author&gt;</span>
<span class="w">    </span><span class="nt">&lt;version&gt;</span>1.0<span class="nt">&lt;/version&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- Imports are required to allow references to definitions in other models --&gt;</span>
<span class="w">    </span><span class="nt">&lt;imports&gt;</span>
<span class="w">        </span><span class="nt">&lt;import</span><span class="w"> </span><span class="na">uri=</span><span class="s">&quot;http://www.alfresco.org/model/dictionary/1.0&quot;</span>
<span class="w">            </span><span class="na">prefix=</span><span class="s">&quot;d&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;import</span><span class="w"> </span><span class="na">uri=</span><span class="s">&quot;http://www.alfresco.org/model/bpm/1.0&quot;</span>
<span class="w">            </span><span class="na">prefix=</span><span class="s">&quot;bpm&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/imports&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- Introduction of new namespaces defined by this model --&gt;</span>
<span class="w">    </span><span class="nt">&lt;namespaces&gt;</span>
<span class="w">        </span><span class="nt">&lt;namespace</span><span class="w"> </span><span class="na">uri=</span><span class="s">&quot;http://www.someco.com/model/workflow/1.0&quot;</span>
<span class="w">            </span><span class="na">prefix=</span><span class="s">&quot;scwf&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/namespaces&gt;</span>

<span class="w">    </span><span class="nt">&lt;types&gt;</span>
<span class="w">        </span><span class="nt">&lt;type</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;scwf:submitHelloWorldTask&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;parent&gt;</span>bpm:startTask<span class="nt">&lt;/parent&gt;</span>
<span class="w">            </span><span class="nt">&lt;properties&gt;</span>
<span class="w">                </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;scwf:helloName&quot;</span><span class="nt">&gt;</span>
<span class="w">                    </span><span class="nt">&lt;type&gt;</span>d:text<span class="nt">&lt;/type&gt;</span>
<span class="w">                    </span><span class="nt">&lt;mandatory&gt;</span>true<span class="nt">&lt;/mandatory&gt;</span>
<span class="w">                    </span><span class="nt">&lt;multiple&gt;</span>false<span class="nt">&lt;/multiple&gt;</span>
<span class="w">                </span><span class="nt">&lt;/property&gt;</span>
<span class="w">            </span><span class="nt">&lt;/properties&gt;</span>
<span class="w">        </span><span class="nt">&lt;/type&gt;</span>
<span class="w">    </span><span class="nt">&lt;/types&gt;</span>

<span class="nt">&lt;/model&gt;</span>
</code></pre></div>
<p>The <code>scwf:submitHelloWorldTask</code> type is a child of <code>bpm:startTask</code> and declares
a property called <code>scwf:helloName</code>. That's a text property that will be
displayed as a text field the workflow initiator can use to tell the workflow
who to greet.</p>
<p>Alfresco needs to know about this model. This is done through Spring
configuration. There will be a few other additions to that context file so
you'll do them all at once shortly.</p>
<h2 id="step-3-configure-alfresco-share">Step 3: Configure Alfresco Share<a class="headerlink" href="#step-3-configure-alfresco-share" title="Permanent link">&para;</a></h2>
<p>The next step is to tell Alfresco Share how to display the process metadata.
This works exactly like custom content types. As you saw in that tutorial, Share
customizations go in their own project so that they can be packaged in an AMP
specifically for the share tier.</p>
<h3 id="edit-share-config-customxml">Edit share-config-custom.xml<a class="headerlink" href="#edit-share-config-customxml" title="Permanent link">&para;</a></h3>
<p>The user interface configuration for Alfresco Share resides in a directory
called:</p>
<div class="highlight"><pre><span></span><code>$TUTORIAL_HOME/workflow-tutorial-share/src/main/resources/META-INF
</code></pre></div>
<p>The SDK probably already created this directory structure as well as a sample
share-config-custom.xml file.</p>
<p>In the META-INF directory, edit the file called "<a href="https://github.com/jpotts/alfresco-developer-series/blob/master/workflow/workflow-tutorial/workflow-tutorial-share/src/main/resources/META-INF/share-config-custom.xml">share-config-custom.xml</a>"
. Replace the sample content with the following content:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;alfresco-config&gt;</span>
<span class="w">    </span><span class="nt">&lt;config</span><span class="w"> </span><span class="na">evaluator=</span><span class="s">&quot;string-compare&quot;</span><span class="w"> </span><span class="na">condition=</span><span class="s">&quot;activiti$helloWorldUI&quot;</span><span class="nt">&gt;</span>
<span class="w">      </span><span class="nt">&lt;forms&gt;</span>
<span class="w">         </span><span class="nt">&lt;form&gt;</span>
<span class="w">            </span><span class="nt">&lt;field-visibility&gt;</span>
<span class="w">               </span><span class="nt">&lt;show</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;bpm:workflowDescription&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">               </span><span class="nt">&lt;show</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;packageItems&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">               </span><span class="nt">&lt;show</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;scwf:helloName&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">               </span><span class="nt">&lt;show</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;transitions&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">               </span><span class="nt">&lt;show</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;bpm:status&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;/field-visibility&gt;</span>
<span class="w">            </span><span class="nt">&lt;appearance&gt;</span>
<span class="w">               </span><span class="nt">&lt;set</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="na">appearance=</span><span class="s">&quot;title&quot;</span><span class="w"> </span><span class="na">label-id=</span><span class="s">&quot;workflow.set.general&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">               </span><span class="nt">&lt;set</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;items&quot;</span><span class="w"> </span><span class="na">appearance=</span><span class="s">&quot;title&quot;</span><span class="w"> </span><span class="na">label-id=</span><span class="s">&quot;workflow.set.items&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">               </span><span class="nt">&lt;set</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;progress&quot;</span><span class="w"> </span><span class="na">appearance=</span><span class="s">&quot;title&quot;</span><span class="w"> </span><span class="na">label-id=</span><span class="s">&quot;workflow.set.task.progress&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">               </span><span class="nt">&lt;set</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;other&quot;</span><span class="w"> </span><span class="na">appearance=</span><span class="s">&quot;title&quot;</span><span class="w"> </span><span class="na">label-id=</span><span class="s">&quot;workflow.set.other&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">               </span><span class="nt">&lt;field</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;bpm:workflowDescription&quot;</span><span class="w"> </span><span class="na">label-id=</span><span class="s">&quot;workflow.field.message&quot;</span><span class="nt">&gt;</span>
<span class="w">                  </span><span class="nt">&lt;control</span><span class="w"> </span><span class="na">template=</span><span class="s">&quot;/org/alfresco/components/form/controls/textarea.ftl&quot;</span><span class="nt">&gt;</span>
<span class="w">                     </span><span class="nt">&lt;control-param</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;style&quot;</span><span class="nt">&gt;</span>width:<span class="w"> </span>95%<span class="nt">&lt;/control-param&gt;</span>
<span class="w">                  </span><span class="nt">&lt;/control&gt;</span>
<span class="w">               </span><span class="nt">&lt;/field&gt;</span>
<span class="w">               </span><span class="nt">&lt;field</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;packageItems&quot;</span><span class="w"> </span><span class="na">set=</span><span class="s">&quot;items&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">               </span><span class="nt">&lt;field</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;scwf:helloName&quot;</span><span class="w"> </span><span class="na">set=</span><span class="s">&quot;other&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">               </span><span class="nt">&lt;field</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;bpm:status&quot;</span><span class="w"> </span><span class="na">set=</span><span class="s">&quot;progress&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;/appearance&gt;</span>
<span class="w">         </span><span class="nt">&lt;/form&gt;</span>
<span class="w">      </span><span class="nt">&lt;/forms&gt;</span>
<span class="w">    </span><span class="nt">&lt;/config&gt;</span>
<span class="nt">&lt;/alfresco-config&gt;</span>
</code></pre></div>
<p>This form tells Alfresco Share that when someone starts a process named
"activiti$helloWorldUI" it should show the user this form. The form definition
includes the <code>scwf:helloName</code> property defined in the custom type.</p>
<h3 id="externalize-the-strings">Externalize the strings<a class="headerlink" href="#externalize-the-strings" title="Permanent link">&para;</a></h3>
<p>Alfresco Share needs to know which strings to use to display things like the
workflow title and description that show up in the "Start Advanced Workflow"
dialog, and titles and descriptions for individual tasks. The identifiers for
these strings follow a specific format.</p>
<p>There are two separate properties bundles to deal with. One is for the "repo"
tier, so it goes in the workflow-tutorial-platform module. The other is for
the "share" tier, so it goes in the workflow-tutorial-share module.</p>
<p>Properties for the repo tier go in:</p>
<div class="highlight"><pre><span></span><code>$TUTORIAL_HOME/workflow-tutorial-platform/src/main/resources/alfresco/module/workflow-tutorial-platform/messages
</code></pre></div>
<p>The SDK has already created the "messages" folder along with a sample properties
file, which you can delete.</p>
<p>In the messages folder, create a new file called "<a href="https://github.com/jpotts/alfresco-developer-series/blob/master/workflow/workflow-tutorial/workflow-tutorial-platform/src/main/resources/alfresco/module/workflow-tutorial-platform/messages/scWorkflow.properties">scWorkflow.properties</a>" with the following content:</p>
<div class="highlight"><pre><span></span><code># Workflow related strings
helloWorldUI.workflow.title=Hello World UI (Activiti)
helloWorldUI.workflow.description=A simple hello world process using Activiti

# Workflow Model related strings
scwf_workflowmodel.type.scwf_submitHelloWorldTask.title=Start Hello World UI Workflow
scwf_workflowmodel.type.scwf_submitHelloWorldTask.description=Submit a workflow that says hello in the log
scwf_workflowmodel.property.scwf_helloName.title=Name
scwf_workflowmodel.property.scwf_helloName.description=Say hello to this person
</code></pre></div>
<p>I tend to think of these properties as belonging to two groups. One group is the
set of model-related properties. These properties externalize the strings in the
workflow content model. The other is the set of process-related properties.
These properties externalize the strings users see when they are working with
the process (the workflow title, the workflow history, etc.).</p>
<p>Properties for the share tier go in:</p>
<div class="highlight"><pre><span></span><code>$TUTORIAL_HOME/workflow-tutorial-share/src/main/resources/alfresco/web-extension/messages
</code></pre></div>
<p>The SDK has already created the "messages" folder and a sample properties file
which you can delete.</p>
<p>In the messages folder, create a new file called "<a href="https://github.com/jpotts/alfresco-developer-series/blob/master/workflow/workflow-tutorial/workflow-tutorial-share/src/main/resources/alfresco/web-extension/messages/scWorkflow.properties">scWorkflow.properties</a>" with the following content:</p>
<div class="highlight"><pre><span></span><code>#scwf:helloName
prop.scwf_helloName=Name

#workflow properties
workflow.scwf_helloWorldUI=Hello World UI
</code></pre></div>
<p>Both of these properties files have to be registered through Spring. You'll see
that next.</p>
<h3 id="update-the-spring-configuration">Update the Spring configuration<a class="headerlink" href="#update-the-spring-configuration" title="Permanent link">&para;</a></h3>
<p>In this section you've made several changes that require Spring configuration
updates in each of the two projects:</p>
<ul>
<li>Custom workflow model</li>
<li>helloWorldUI business process definition</li>
<li>Localized properties for the repo tier</li>
<li>Localized properties for the share tier</li>
</ul>
<p>Let's update the repo tier Spring configuration, then the share tier.</p>
<h4 id="repo-tier-spring-configuration">Repo tier Spring configuration<a class="headerlink" href="#repo-tier-spring-configuration" title="Permanent link">&para;</a></h4>
<p>Edit the <a href="https://github.com/jpotts/alfresco-developer-series/blob/master/workflow/workflow-tutorial/workflow-tutorial-platform/src/main/resources/alfresco/module/workflow-tutorial-platform/context/bootstrap-context.xml">bootstrap-context.xml</a> file that resides in:</p>
<div class="highlight"><pre><span></span><code>$TUTORIAL_HOME/workflow-tutorial-platform/src/main/resources/alfresco/module/workflow-tutorial-platform/context
</code></pre></div>
<p>You can add the workflow model, the new workflow, and the labels all in the same
bean. Edit the bootstrap-context.xml file and append the following to the
existing <code>bean</code> element:</p>
<div class="highlight"><pre><span></span><code><span class="w">            </span><span class="nt">&lt;props&gt;</span>
<span class="w">                </span><span class="nt">&lt;prop</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;engineId&quot;</span><span class="nt">&gt;</span>activiti<span class="nt">&lt;/prop&gt;</span>
<span class="w">                </span><span class="nt">&lt;prop</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;location&quot;</span><span class="nt">&gt;</span>alfresco/module/${project.artifactId}/workflow/helloWorldUI.bpmn<span class="nt">&lt;/prop&gt;</span>
<span class="w">                </span><span class="nt">&lt;prop</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;mimetype&quot;</span><span class="nt">&gt;</span>text/xml<span class="nt">&lt;/prop&gt;</span>
<span class="w">                </span><span class="nt">&lt;prop</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;redeploy&quot;</span><span class="nt">&gt;</span>false<span class="nt">&lt;/prop&gt;</span>
<span class="w">            </span><span class="nt">&lt;/props&gt;</span>
<span class="w">        </span><span class="nt">&lt;/list&gt;</span>
<span class="w">    </span><span class="nt">&lt;/property&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;models&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;list&gt;</span>
<span class="w">            </span><span class="nt">&lt;value&gt;</span>alfresco/module/${project.artifactId}/model/scWorkflowModel.xml<span class="nt">&lt;/value&gt;</span>
<span class="w">        </span><span class="nt">&lt;/list&gt;</span>
<span class="w">    </span><span class="nt">&lt;/property&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;labels&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;list&gt;</span>
<span class="w">            </span><span class="nt">&lt;value&gt;</span>alfresco.module.${project.artifactId}.messages.scWorkflow<span class="nt">&lt;/value&gt;</span>
<span class="w">        </span><span class="nt">&lt;/list&gt;</span>
<span class="w">    </span><span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</code></pre></div>
<p>Save and close the file.</p>
<h4 id="share-tier-spring-configuration">Share tier Spring configuration<a class="headerlink" href="#share-tier-spring-configuration" title="Permanent link">&para;</a></h4>
<p>The Spring configuration for the workflow-tutorial-share module resides in:</p>
<div class="highlight"><pre><span></span><code>$TUTORIAL_HOME/workflow-tutorial-share/src/main/resources/alfresco/web-extension
</code></pre></div>
<p>In the web-extension directory, the SDK has created file called "<a href="https://github.com/jpotts/alfresco-developer-series/blob/master/workflow/workflow-tutorial/workflow-tutorial-share/src/main/resources/alfresco/web-extension/workflow-tutorial-share-slingshot-application-context.xml">workflow-tutorial-share-slingshot-application-context.xml</a>"
. Replace the content of that file with the following content:</p>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;?xml version=&#39;1.0&#39; encoding=&#39;UTF-8&#39;?&gt;</span>
<span class="cp">&lt;!DOCTYPE beans PUBLIC &#39;-//SPRING//DTD BEAN//EN&#39; &#39;http://www.springframework.org/dtd/spring-beans.dtd&#39;&gt;</span>
<span class="nt">&lt;beans&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- Add Someco Workflow messages --&gt;</span>
<span class="w">    </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;${project.artifactId}_resources&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.springframework.extensions.surf.util.ResourceBundleBootstrapComponent&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;resourceBundles&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;list&gt;</span>
<span class="w">                </span><span class="nt">&lt;value&gt;</span>alfresco.web-extension.messages.scWorkflow<span class="nt">&lt;/value&gt;</span>
<span class="w">            </span><span class="nt">&lt;/list&gt;</span>
<span class="w">        </span><span class="nt">&lt;/property&gt;</span>
<span class="w">    </span><span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</code></pre></div>
<p>Save and close the file.</p>
<p>The helloWorldUI example is now ready to deploy.</p>
<h2 id="deploy-test">Deploy &amp; Test<a class="headerlink" href="#deploy-test" title="Permanent link">&para;</a></h2>
<p>The hello world UI example can be tested using the SDK-generated Docker images.
You probably already have containers running from earlier. To find out:</p>
<ol>
<li>Open a command-line window.</li>
<li>Run <code>docker ps</code>.</li>
<li>If anything comes back there are containers running. To stop them,
switch to $TUTORIAL_HOME then do <code>./run.sh stop</code>.</li>
</ol>
<p>Now you are ready to re-build the AMPs and start up fresh
containers. To do that:</p>
<ol>
<li>Switch to $TUTORIAL_HOME.</li>
<li>Run <code>./run.sh build_start</code> (or <code>run.bat</code>).</li>
</ol>
<p>Your repo tier AMP and Share tier AMPs will be built, installed into their
respective WARs in Docker images, and then Docker Compose will start up
containers based on those images. Alfresco is running on port 8080 and Share is
running on port 8180.</p>
<p>When everything starts up:</p>
<ol>
<li>Go to http://localhost:8180/share and log in as admin (password: admin).</li>
<li>
<p>In the "My Tasks" dashlet, click "Start Workflow" to start a workflow. You
should see the Hello World UI workflow in the list of workflows:</p>
<p><img alt="Share workflow list shows custom workflows" src="../images/start-workflow-list.png" /></p>
</li>
<li>
<p>Select the Hello World UI workflow. Alfresco Share should display a form that
includes the greeting field:</p>
<p><img alt="Hello World UI: Start workflow form" src="../images/start-workflow-form.png" /></p>
</li>
<li>
<p>Specify a name in the name field then click "Start Workflow" to start the
workflow.</p>
</li>
<li>
<p>After the workflow starts, you should see the greeting in the log:</p>
<p><img alt="Hello World UI greeting in the log" src="../images/greeting-in-the-log.png" /></p>
</li>
<li>
<p>The "My Tasks" dashlet should now have a task waiting on you. Click the task
description to edit the task.</p>
</li>
<li>Add a comment if you want, then click either "Approve" or "Reject".</li>
<li>Check the log again. You should see a log message showing which one you
selected:</li>
</ol>
<p><img alt="Hello World UI approval result in the log" src="../images/approval-result-in-log.png" /></p>
<p>If all goes well, congratulations, you've successfully deployed a custom
workflow with custom metadata that can be started and managed in Alfresco Share.</p>
<h2 id="implementation-summary">Implementation summary<a class="headerlink" href="#implementation-summary" title="Permanent link">&para;</a></h2>
<p>You've covered a lot of ground so far. The following summarizes the advanced
workflow implementation steps:</p>
<ol>
<li>Model the process using the Activiti Process Designer. Add logic using
expressions, Alfresco JavaScript, or Java classes. Use the workflow deployer
bean in Spring so that the process definition will get deployed when Alfresco
starts.</li>
<li>Define a workflow content model. Remember to configure it in Spring.</li>
<li>Update share-config-custom.xml with form configuration that tells Alfresco
Share how to handle workflow model you defined in the previous step. Configuring
Alfresco Share also means externalizing the strings and referring to those in
the Spring context file for both the repo tier and the share tier.</li>
</ol>
<p>At this point you know enough about advanced workflows to be dangerous. Let's
work through an example for the fictitious company, SomeCo, to put some of this
new knowledge to work.</p>
<h1 id="someco-whitepaper-submission-example">SomeCo Whitepaper submission example<a class="headerlink" href="#someco-whitepaper-submission-example" title="Permanent link">&para;</a></h1>
<p>This example continues the SomeCo example from the past several <a href="https://ecmarchitect.com/alfresco-developer-series">Alfresco Developer Series</a>
tutorials. SomeCo is going to use Advanced Workflows to route Whitepapers for
approval before being flagged for publication on the web site. The next section
describes the process.</p>
<h2 id="business-requirements">Business requirements<a class="headerlink" href="#business-requirements" title="Permanent link">&para;</a></h2>
<p>Anyone that can log in to Alfresco can submit a whitepaper for publication on
the SomeCo web site. The only information the submitter needs to specify is the
email address of an external third-party reviewer, if applicable. More on that
shortly.</p>
<p>The whitepaper needs to be reviewed by the Engineering team as well as the
Marketing team. It doesn't matter who on the team does the review—SomeCo wants
to notify each team and then let one representative from each team "own" the
review task. Either team can reject the whitepaper. If rejected, the person who
submitted the whitepaper can make revisions and resubmit. If both teams approve,
the whitepaper moves on to the next step.</p>
<p>Some whitepapers need to be reviewed by an external third-party. The third-party
won't actually log in to Alfresco—they'll get an email and click a link to
approve or reject the whitepaper. If the third-party doesn't do anything in a
certain amount of time, the whitepaper should be automatically approved.</p>
<h2 id="high-level-steps">High-level steps<a class="headerlink" href="#high-level-steps" title="Permanent link">&para;</a></h2>
<p>Alright. You're going to implement this process in four major steps.
Here's a look at the major steps and the respective sub-steps:</p>
<ol>
<li>Implement the basic flow and workflow user interface<ol>
<li>Lay out the process using the Activiti Process Designer.</li>
<li>Configure user tasks with appropriate assignments.</li>
<li>Add decision logic.</li>
<li>Implement the workflow content model, the Alfresco Share client
configuration, and the workflow properties.</li>
<li>Deploy and test.</li>
</ol>
</li>
<li>Implement web scripts and actions for external third-party integration and
other business logic<ol>
<li>Execute the "set web flag" action (created in an earlier tutorial)
against every whitepaper in the workflow package. The action adds the
<code>sc:webable</code> aspect to the whitepaper and sets the properties appropriately.</li>
<li>Write a web script to handle approval/rejection via HTTP. The logic needs
to grab the task and then set the outcome with the appropriate "approve" or
"reject" flag.</li>
<li>Write an Activiti task listener Java class that sends a notification to
the third-party email address.</li>
<li>Deploy and test.</li>
</ol>
</li>
<li>Add a timer to the third-party task<ol>
<li>Add a timer to the Third Party Review task so that if the third party
doesn't respond in a timely fashion the task will automatically approve.</li>
<li>Deploy and test.</li>
</ol>
</li>
</ol>
<p>Now that you know where you're headed at a high-level, let's get into the
details.</p>
<h2 id="step-1-implement-the-basic-flow-and-workflow-user-interface">Step 1: Implement the basic flow and workflow user interface<a class="headerlink" href="#step-1-implement-the-basic-flow-and-workflow-user-interface" title="Permanent link">&para;</a></h2>
<p>Just like in the Hello World examples, the first thing to do is diagram the
process. Then, assign tasks, add a bit of logic, and establish the workflow
content model before a quick deploy and test.</p>
<h3 id="diagram-the-process">Diagram the process<a class="headerlink" href="#diagram-the-process" title="Permanent link">&para;</a></h3>
<p>The diagram step is just like you've seen before, it's just that the diagram is
a little more complex.</p>
<ol>
<li>Right-click on the workflows folder, New, Other, Activiti Process Diagram.</li>
<li>Name the process "<a href="https://github.com/jpotts/alfresco-developer-series/blob/master/workflow/workflow-tutorial/workflow-tutorial-platform/src/main/resources/alfresco/module/workflow-tutorial-platform/workflow/publishWhitepaper.bpmn">publishWhitepaper.bpmn</a>".</li>
<li>Click on the canvas to open the properties editor for the entire process. Set
the ID to "publishWhitepaper" and the name to "Publish Whitepaper".</li>
<li>
<p>Drag-and-drop nodes from the palette and connect them with sequence flows to
make your diagram look like this:</p>
<p><img alt="Publish Whitepaper BPMN Diagram" src="../images/publish-whitepaper-bpmn.png" /></p>
</li>
</ol>
<p>Submit is a Service Task. The rest are User Tasks. This example does not use the
Alfresco-specific events or tasks, but feel free to do so in your own diagrams.</p>
<p>Now that the diagram is in place, continue to the next section to see how to set
the task properties.</p>
<h3 id="configure-user-tasks-with-assignments">Configure user tasks with assignments<a class="headerlink" href="#configure-user-tasks-with-assignments" title="Permanent link">&para;</a></h3>
<p>This table tells you how to set the performer type, expression, and form
key on each task:</p>
<table>
<thead>
<tr>
<th>Task</th>
<th>Performer Type</th>
<th>Expression</th>
<th>Form Key</th>
</tr>
</thead>
<tbody>
<tr>
<td>Start Event</td>
<td>N/A</td>
<td>N/A</td>
<td>scwf:submitReviewTask</td>
</tr>
<tr>
<td>Operations Review</td>
<td>Candidate Groups</td>
<td>GROUP_Operations</td>
<td>scwf:activitiOperationsReview</td>
</tr>
<tr>
<td>Marketing Review</td>
<td>Candidate Groups</td>
<td>GROUP_Marketing</td>
<td>scwf:activitiMarketingReview</td>
</tr>
<tr>
<td>Revise</td>
<td>Assignee</td>
<td>\${initiator.properties.userName}</td>
<td>scwf:activitiRevise</td>
</tr>
<tr>
<td>Third-Party Review</td>
<td>Assignee</td>
<td>\${initiator.properties.userName}</td>
<td>scwf:activitiThirdPartyReview</td>
</tr>
<tr>
<td>Approved Notification</td>
<td>Assignee</td>
<td>\${initiator.properties.userName}</td>
<td>scwf:activitiApprovedNotification</td>
</tr>
</tbody>
</table>
<p>Table: Settings for performer, expression, &amp; form key</p>
<h4 id="pooled-assignments">Pooled Assignments<a class="headerlink" href="#pooled-assignments" title="Permanent link">&para;</a></h4>
<p>Notice that the Operations Review and Marketing Review are being assigned to
groups instead of individuals. How will the group of people decide who should
work on a task? This particular process uses a "pooled assignment". Suppose, for
example, the Operations group contains ten people. You could iterate through the
group and assign a task to each and every member of the group and then not
consider the task complete until some or all group members have taken action. An
alternative to that is to use a pooled assignment. Using a pool, all members of
a group are notified of the task, but as soon as one group member takes
"ownership" of the task, it is removed from everyone else's to do list. The
owner can then either complete the task or return it to the pool. If it is
returned to the pool, all members of the group see the task in their to do list
until another person takes ownership or completes the task. To use pooled
assignment, use the <code>activiti:candidateGroups</code> attribute on the <code>userTask</code>
element instead of the <code>activiti:assignee</code> element.</p>
<p>The decision to use pooled actors or not depends entirely on the business
process—there is no best practice approach.</p>
<h3 id="add-decision-logic">Add decision logic<a class="headerlink" href="#add-decision-logic" title="Permanent link">&para;</a></h3>
<p>At this point the process diagram should save without a problem. Now it is time
to switch to re-open the file using the XML editor to add some decision logic to
the process.</p>
<p>The process definition has two decisions. One decision figures out if all
required approvals have been obtained. If so, the process continues. If not, the
initiator gets a chance to make revisions. The other decision is used to
determine if a third-party review is required based on whether or not the
initiator provided an email address. These are represented by the two exclusive
gateways on the diagram.</p>
<p>These are pretty easy decisions to make based on process variables.</p>
<h4 id="implement-the-approval-check">Implement the approval check<a class="headerlink" href="#implement-the-approval-check" title="Permanent link">&para;</a></h4>
<p>In the business process XML, find the <code>serviceTask</code> element named "Submit" and
add the following script:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;serviceTask</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;scripttask1&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;Submit&quot;</span><span class="w"> </span><span class="na">activiti:class=</span><span class="s">&quot;org.alfresco.repo.workflow.activiti.script.AlfrescoScriptDelegate&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;extensionElements&gt;</span>
<span class="w">    </span><span class="nt">&lt;activiti:field</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;script&quot;</span><span class="nt">&gt;</span>
<span class="w">      </span><span class="nt">&lt;activiti:string&gt;</span><span class="cp">&lt;![CDATA[execution.setVariable(&#39;scwf_approveCount&#39;, 0);</span>
<span class="cp">          execution.setVariable(&#39;scwf_tpApproved&#39;, false);]]&gt;</span><span class="nt">&lt;/activiti:string&gt;</span>
<span class="w">    </span><span class="nt">&lt;/activiti:field&gt;</span>
<span class="w">  </span><span class="nt">&lt;/extensionElements&gt;</span>
<span class="nt">&lt;/serviceTask&gt;</span>
</code></pre></div>
<p>This initializes two variables that will be used as part of the approval check.
The <code>scwf_approveCount</code> variable will get incremented when the process follows
the "approve" sequence flow. If the counter is equal to 2, the package received
both approvals. It is important to initialize the counter to 0 and the approved
variable to false in the "Submit" script task because it is possible that a
whitepaper may go through several review cycles. Every time a new cycle starts
the counters need to be reset.</p>
<p>You may be wondering why this is a service task instead of a script task. In
5.0.d, the underlying JavaScript engine in Activiti switched from Rhino to
Nashorn. This caused a problem related to setting execution variables. The
workaround is to use a service task.</p>
<p>Now add code to increment the counter when the execution follows the approve
sequence flow. Find the <code>userTask</code> named "Operations Review" and add this
extension element:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;userTask</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;usertask1&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;Operations Review&quot;</span><span class="w"> </span><span class="na">activiti:candidateGroups=</span><span class="s">&quot;GROUP_Operations&quot;</span><span class="w"> </span><span class="na">activiti:formKey=</span><span class="s">&quot;scwf:activitiOperationsReview&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;extensionElements&gt;</span>
<span class="w">        </span><span class="nt">&lt;activiti:taskListener</span><span class="w"> </span><span class="na">event=</span><span class="s">&quot;complete&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;activiti:field</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;script&quot;</span><span class="nt">&gt;</span>
<span class="w">                </span><span class="nt">&lt;activiti:string&gt;</span>
<span class="w">                    </span>if(task.getVariableLocal(&#39;scwf_approveRejectOutcome&#39;)<span class="w"> </span>==<span class="w"> </span>&#39;Approve&#39;)<span class="w"> </span>{
<span class="w">                        </span>var<span class="w"> </span>newApprovedCount<span class="w"> </span>=<span class="w"> </span>scwf_approveCount<span class="w"> </span>+<span class="w"> </span>1;
<span class="w">                        </span>execution.setVariable(&#39;scwf_approveCount&#39;,<span class="w"> </span>newApprovedCount);
<span class="w">                    </span>}
<span class="w">                </span><span class="nt">&lt;/activiti:string&gt;</span>
<span class="w">            </span><span class="nt">&lt;/activiti:field&gt;</span>
<span class="w">        </span><span class="nt">&lt;/activiti:taskListener&gt;</span>
<span class="w">    </span><span class="nt">&lt;/extensionElements&gt;</span>
<span class="nt">&lt;/userTask&gt;</span>
</code></pre></div>
<p>The JavaScript inspects the value of <code>scwf_approveRejectOutcome</code> which will be
set by the user when they manage the task in Alfresco Share. If it is equal to
"Approve" it increments <code>scwf_approveCount</code>.</p>
<p>Now add the same thing to the <code>userTask</code> element named Marketing Review.</p>
<p>The first exclusive gateway after the "Operations Review" and "Marketing Review"
user tasks represents a decision. If the approvals have been reached, the flow
should continue on, otherwise it should go to the "Revise" user task.</p>
<p>To implement this, find the <code>sequenceFlow</code> elements that connect that exclusive
gateway and add a <code>conditionExpression</code> element to each one that inspects the
<code>scwf_approveCount</code> variable, like this:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;sequenceFlow</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;flow8&quot;</span><span class="w"> </span><span class="na">sourceRef=</span><span class="s">&quot;exclusivegateway1&quot;</span><span class="w"> </span><span class="na">targetRef=</span><span class="s">&quot;exclusivegateway2&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;conditionExpression</span><span class="w"> </span><span class="na">xsi:type=</span><span class="s">&quot;tFormalExpression&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;![CDATA[${scwf_approveCount == 2}]]&gt;</span><span class="nt">&lt;/conditionExpression&gt;</span>
<span class="nt">&lt;/sequenceFlow&gt;</span>
<span class="nt">&lt;sequenceFlow</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;flow9&quot;</span><span class="w"> </span><span class="na">sourceRef=</span><span class="s">&quot;exclusivegateway1&quot;</span><span class="w"> </span><span class="na">targetRef=</span><span class="s">&quot;usertask3&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;conditionExpression</span><span class="w"> </span><span class="na">xsi:type=</span><span class="s">&quot;tFormalExpression&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;![CDATA[${scwf_approveCount &lt; 2}]]&gt;</span><span class="nt">&lt;/conditionExpression&gt;</span>
<span class="nt">&lt;/sequenceFlow&gt;</span>
</code></pre></div>
<p>The "Third Party" decision is similar. In this case, if the person who started
the workflow provided an email address for the third-party reviewer, the
workflow should route to the "Third Party Review", otherwise, it should continue
on. Here is what those conditions look like:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;sequenceFlow</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;flow11&quot;</span><span class="w"> </span><span class="na">sourceRef=</span><span class="s">&quot;exclusivegateway2&quot;</span><span class="w"> </span><span class="na">targetRef=</span><span class="s">&quot;usertask2&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;conditionExpression</span><span class="w"> </span><span class="na">xsi:type=</span><span class="s">&quot;tFormalExpression&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;![CDATA[${scwf_reviewerEmail != &#39;&#39;}]]&gt;</span><span class="nt">&lt;/conditionExpression&gt;</span>
<span class="nt">&lt;/sequenceFlow&gt;</span>
<span class="nt">&lt;sequenceFlow</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;flow14&quot;</span><span class="w"> </span><span class="na">sourceRef=</span><span class="s">&quot;exclusivegateway2&quot;</span><span class="w"> </span><span class="na">targetRef=</span><span class="s">&quot;usertask5&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;conditionExpression</span><span class="w"> </span><span class="na">xsi:type=</span><span class="s">&quot;tFormalExpression&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;![CDATA[${scwf_reviewerEmail == &#39;&#39;}]]&gt;</span><span class="nt">&lt;/conditionExpression&gt;</span>
<span class="nt">&lt;/sequenceFlow&gt;</span>
</code></pre></div>
<p>There are two more places condition expressions are needed. One is on the two
flows that leave Third Party Review. If the third-party approves their review,
flow should go to the "Approved Notification", otherwise, it should go to
"Revise":</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;sequenceFlow</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;flow12&quot;</span><span class="w"> </span><span class="na">sourceRef=</span><span class="s">&quot;usertask2&quot;</span><span class="w"> </span><span class="na">targetRef=</span><span class="s">&quot;usertask3&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;conditionExpression</span><span class="w"> </span><span class="na">xsi:type=</span><span class="s">&quot;tFormalExpression&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;![CDATA[${scwf_tpApproved == false}]]&gt;</span><span class="nt">&lt;/conditionExpression&gt;</span>
<span class="nt">&lt;/sequenceFlow&gt;</span>
<span class="nt">&lt;sequenceFlow</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;flow17&quot;</span><span class="w"> </span><span class="na">sourceRef=</span><span class="s">&quot;usertask2&quot;</span><span class="w"> </span><span class="na">targetRef=</span><span class="s">&quot;usertask5&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;conditionExpression</span><span class="w"> </span><span class="na">xsi:type=</span><span class="s">&quot;tFormalExpression&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;![CDATA[${scwf_tpApproved == true}]]&gt;</span><span class="nt">&lt;/conditionExpression&gt;</span>
<span class="nt">&lt;/sequenceFlow&gt;</span>
</code></pre></div>
<p>The other place for condition expressions is on the "Revise" user task. The flow
should go to the "Submit" script task if the initiator re-submits and the "End"
task if they decide to withdraw or abort their request:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;sequenceFlow</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;flow16&quot;</span><span class="w"> </span><span class="na">sourceRef=</span><span class="s">&quot;usertask3&quot;</span><span class="w"> </span><span class="na">targetRef=</span><span class="s">&quot;endevent1&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;conditionExpression</span><span class="w"> </span><span class="na">xsi:type=</span><span class="s">&quot;tFormalExpression&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;![CDATA[${scwf_resubmit == false}]]&gt;</span><span class="nt">&lt;/conditionExpression&gt;</span>
<span class="nt">&lt;/sequenceFlow&gt;</span>
<span class="nt">&lt;sequenceFlow</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;flow13&quot;</span><span class="w"> </span><span class="na">sourceRef=</span><span class="s">&quot;usertask3&quot;</span><span class="w"> </span><span class="na">targetRef=</span><span class="s">&quot;scripttask1&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;conditionExpression</span><span class="w"> </span><span class="na">xsi:type=</span><span class="s">&quot;tFormalExpression&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;![CDATA[${scwf_resubmit == true}]]&gt;</span><span class="nt">&lt;/conditionExpression&gt;</span>
<span class="nt">&lt;/sequenceFlow&gt;</span>
</code></pre></div>
<p>The "Third Party Review" user task needs some logic to capture the
approve/reject outcome:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;extensionElements&gt;</span>
<span class="w">    </span><span class="nt">&lt;activiti:taskListener</span><span class="w"> </span><span class="na">event=</span><span class="s">&quot;complete&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;activiti:field</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;script&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;activiti:string&gt;</span>if(task.getVariableLocal(&#39;scwf_approveRejectOutcome&#39;)<span class="w"> </span>==<span class="w"> </span>&#39;Approve&#39;)<span class="w"> </span>{
<span class="w">                </span>execution.setVariable(&#39;scwf_tpApproved&#39;,<span class="w"> </span>true);
<span class="w">                </span>}<span class="w"> </span>else<span class="w"> </span>{
<span class="w">                </span>execution.setVariable(&#39;scwf_tpApproved&#39;,<span class="w"> </span>false);
<span class="w">                </span>}
<span class="w">            </span><span class="nt">&lt;/activiti:string&gt;</span>
<span class="w">        </span><span class="nt">&lt;/activiti:field&gt;</span>
<span class="w">    </span><span class="nt">&lt;/activiti:taskListener&gt;</span>
<span class="nt">&lt;/extensionElements&gt;</span>
</code></pre></div>
<p>Similarly, the Revise user task also needs to set a variable with the
Abort/Re-Submit outcome:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;extensionElements&gt;</span>
<span class="w">  </span><span class="nt">&lt;activiti:taskListener</span><span class="w"> </span><span class="na">event=</span><span class="s">&quot;complete&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;activiti:field</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;script&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;activiti:string&gt;</span>if(task.getVariableLocal(&#39;scwf_reviseOutcome&#39;)<span class="w"> </span>==<span class="w"> </span>&#39;Re-submit&#39;)<span class="w"> </span>{
<span class="w">                </span>execution.setVariable(&#39;scwf_resubmit&#39;,<span class="w"> </span>true);
<span class="w">                </span>}<span class="w"> </span>else<span class="w"> </span>{
<span class="w">                </span>execution.setVariable(&#39;scwf_resubmit&#39;,<span class="w"> </span>false);
<span class="w">                </span>}
<span class="w">            </span><span class="nt">&lt;/activiti:string&gt;</span>
<span class="w">        </span><span class="nt">&lt;/activiti:field&gt;</span>
<span class="w">  </span><span class="nt">&lt;/activiti:taskListener&gt;</span>
<span class="nt">&lt;/extensionElements&gt;</span>
</code></pre></div>
<p>You may be thinking that my sequence flow ID's aren't very helpful. I agree.
Unfortunately, when I went back in to the process definition to refactor those,
it caused some unanticipated problems. When you do your own business process
definitions you should start with meaningful ID's from the beginning.</p>
<h3 id="workflow-content-model-including-alfresco-share-configuration">Workflow content model including Alfresco Share configuration<a class="headerlink" href="#workflow-content-model-including-alfresco-share-configuration" title="Permanent link">&para;</a></h3>
<p>At this point you've defined the process. It doesn't have all of the logic it
will have eventually, but it has enough that you will be able to step through
all of the paths in the process once the Alfresco Share user interface is
configured. You'll do that in this section by defining the content model and
updating the client configuration.</p>
<h4 id="defining-the-workflow-content-model">Defining the workflow content model<a class="headerlink" href="#defining-the-workflow-content-model" title="Permanent link">&para;</a></h4>
<p>You started a workflow content model in the earlier Hello World UI example. The
first thing to do is update the content model XML (<a href="https://github.com/jpotts/alfresco-developer-series/blob/master/workflow/workflow-tutorial/workflow-tutorial-platform/src/main/resources/alfresco/module/workflow-tutorial-platform/model/scWorkflowModel.xml">scWorkflowModel.xml</a>)
with types and aspects specific to the publish whitepaper process.</p>
<p>Edit the file and add:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;type</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;scwf:submitReviewTask&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;parent&gt;</span>bpm:startTask<span class="nt">&lt;/parent&gt;</span>
<span class="w">    </span><span class="nt">&lt;mandatory-aspects&gt;</span>
<span class="w">        </span><span class="nt">&lt;aspect&gt;</span>scwf:thirdPartyReviewable<span class="nt">&lt;/aspect&gt;</span>
<span class="w">    </span><span class="nt">&lt;/mandatory-aspects&gt;</span>
<span class="nt">&lt;/type&gt;</span>
<span class="nt">&lt;type</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;scwf:activitiMarketingReview&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;parent&gt;</span>scwf:activitiReviewTask<span class="nt">&lt;/parent&gt;</span>
<span class="nt">&lt;/type&gt;</span>
<span class="nt">&lt;type</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;scwf:activitiOperationsReview&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;parent&gt;</span>scwf:activitiReviewTask<span class="nt">&lt;/parent&gt;</span>
<span class="nt">&lt;/type&gt;</span>
<span class="nt">&lt;type</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;scwf:activitiThirdPartyReview&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;parent&gt;</span>scwf:activitiReviewTask<span class="nt">&lt;/parent&gt;</span>
<span class="nt">&lt;/type&gt;</span>
<span class="nt">&lt;type</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;scwf:activitiRevise&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;parent&gt;</span>bpm:activitiOutcomeTask<span class="nt">&lt;/parent&gt;</span>
<span class="w">    </span><span class="nt">&lt;properties&gt;</span>
<span class="w">        </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;scwf:reviseOutcome&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;type&gt;</span>d:text<span class="nt">&lt;/type&gt;</span>
<span class="w">            </span><span class="nt">&lt;default&gt;</span>Abort<span class="nt">&lt;/default&gt;</span>
<span class="w">            </span><span class="nt">&lt;constraints&gt;</span>
<span class="w">                </span><span class="nt">&lt;constraint</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;LIST&quot;</span><span class="nt">&gt;</span>
<span class="w">                    </span><span class="nt">&lt;parameter</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;allowedValues&quot;</span><span class="nt">&gt;</span>
<span class="w">                        </span><span class="nt">&lt;list&gt;</span>
<span class="w">                            </span><span class="nt">&lt;value&gt;</span>Re-submit<span class="nt">&lt;/value&gt;</span>
<span class="w">                            </span><span class="nt">&lt;value&gt;</span>Abort<span class="nt">&lt;/value&gt;</span>
<span class="w">                        </span><span class="nt">&lt;/list&gt;</span>
<span class="w">                    </span><span class="nt">&lt;/parameter&gt;</span>
<span class="w">                </span><span class="nt">&lt;/constraint&gt;</span>
<span class="w">            </span><span class="nt">&lt;/constraints&gt;</span>
<span class="w">        </span><span class="nt">&lt;/property&gt;</span>
<span class="w">    </span><span class="nt">&lt;/properties&gt;</span>
<span class="w">    </span><span class="nt">&lt;overrides&gt;</span>
<span class="w">        </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;bpm:packageItemActionGroup&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;default&gt;</span>edit_package_item_actions<span class="nt">&lt;/default&gt;</span>
<span class="w">        </span><span class="nt">&lt;/property&gt;</span>
<span class="w">        </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;bpm:outcomePropertyName&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;default&gt;</span>{http://www.someco.com/model/workflow/1.0}reviseOutcome<span class="nt">&lt;/default&gt;</span>
<span class="w">        </span><span class="nt">&lt;/property&gt;</span>
<span class="w">    </span><span class="nt">&lt;/overrides&gt;</span>
<span class="nt">&lt;/type&gt;</span>
<span class="nt">&lt;type</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;scwf:activitiReviewTask&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;parent&gt;</span>bpm:activitiOutcomeTask<span class="nt">&lt;/parent&gt;</span>
<span class="w">    </span><span class="nt">&lt;properties&gt;</span>
<span class="w">        </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;scwf:approveRejectOutcome&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;type&gt;</span>d:text<span class="nt">&lt;/type&gt;</span>
<span class="w">            </span><span class="nt">&lt;default&gt;</span>Reject<span class="nt">&lt;/default&gt;</span>
<span class="w">            </span><span class="nt">&lt;constraints&gt;</span>
<span class="w">                </span><span class="nt">&lt;constraint</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;LIST&quot;</span><span class="nt">&gt;</span>
<span class="w">                    </span><span class="nt">&lt;parameter</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;allowedValues&quot;</span><span class="nt">&gt;</span>
<span class="w">                        </span><span class="nt">&lt;list&gt;</span>
<span class="w">                            </span><span class="nt">&lt;value&gt;</span>Approve<span class="nt">&lt;/value&gt;</span>
<span class="w">                            </span><span class="nt">&lt;value&gt;</span>Reject<span class="nt">&lt;/value&gt;</span>
<span class="w">                        </span><span class="nt">&lt;/list&gt;</span>
<span class="w">                    </span><span class="nt">&lt;/parameter&gt;</span>
<span class="w">                </span><span class="nt">&lt;/constraint&gt;</span>
<span class="w">            </span><span class="nt">&lt;/constraints&gt;</span>
<span class="w">        </span><span class="nt">&lt;/property&gt;</span>
<span class="w">    </span><span class="nt">&lt;/properties&gt;</span>
<span class="w">    </span><span class="nt">&lt;overrides&gt;</span>
<span class="w">        </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;bpm:packageItemActionGroup&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;default&gt;</span>read_package_item_actions<span class="nt">&lt;/default&gt;</span>
<span class="w">        </span><span class="nt">&lt;/property&gt;</span>
<span class="w">        </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;bpm:outcomePropertyName&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;default&gt;</span>{http://www.someco.com/model/workflow/1.0}approveRejectOutcome<span class="nt">&lt;/default&gt;</span>
<span class="w">        </span><span class="nt">&lt;/property&gt;</span>
<span class="w">    </span><span class="nt">&lt;/overrides&gt;</span>
<span class="nt">&lt;/type&gt;</span>
<span class="nt">&lt;type</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;scwf:activitiApprovedNotification&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;parent&gt;</span>bpm:workflowTask<span class="nt">&lt;/parent&gt;</span>
<span class="w">    </span><span class="nt">&lt;overrides&gt;</span>
<span class="w">        </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;bpm:packageItemActionGroup&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;default&gt;</span>read_package_item_actions<span class="nt">&lt;/default&gt;</span>
<span class="w">        </span><span class="nt">&lt;/property&gt;</span>
<span class="w">    </span><span class="nt">&lt;/overrides&gt;</span>
<span class="nt">&lt;/type&gt;</span>
</code></pre></div>
<p>There's one type for each task. The name of each type matches the form key of
the user tasks in the publishWhitepaper.bpmn file.</p>
<p>You'll notice that each type inherits from a type defined in the BPM content
model. If you were to look at the out-of-the-box bpmModel.xml file you would see
that the <code>bpm:startTask</code> type has helpful properties such as the workflow
description, due date, and priority.</p>
<p>The <code>bpm:workflowTask</code> has an association called <code>bpm:package</code>. The
<code>bpm:package</code> points to a <code>bpm:workflowPackage</code> which is the aspect applied to a
container (like a folder) that holds the documents being routed through a
workflow. When you write code that needs to access the content being routed in a
workflow you can get to it through the <code>bpm:package</code> association.</p>
<p>The <code>property</code> element named "bpm:packageItemActionGroup" defines what actions
are available for working with the content in the workflow at that particular
step in the process. In the case, the initiator needs to be able to change the
contents of the workflow when the workflow is started and when making revisions,
but reviewers should not be able to add or remove anything to or from the
workflow.</p>
<p>The start task has a mandatory aspect called "scwf:thirdPartyReviewable". After
the closing <code>types</code> element, add the following:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;aspects&gt;</span>
<span class="w">    </span><span class="nt">&lt;aspect</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;scwf:thirdPartyReviewable&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;title&gt;</span>Someco<span class="w"> </span>Third<span class="w"> </span>Party<span class="w"> </span>Reviewable<span class="nt">&lt;/title&gt;</span>
<span class="w">        </span><span class="nt">&lt;properties&gt;</span>
<span class="w">            </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;scwf:reviewerEmail&quot;</span><span class="nt">&gt;</span>
<span class="w">                </span><span class="nt">&lt;type&gt;</span>d:text<span class="nt">&lt;/type&gt;</span>
<span class="w">                </span><span class="nt">&lt;mandatory&gt;</span>false<span class="nt">&lt;/mandatory&gt;</span>
<span class="w">                </span><span class="nt">&lt;multiple&gt;</span>false<span class="nt">&lt;/multiple&gt;</span>
<span class="w">            </span><span class="nt">&lt;/property&gt;</span>
<span class="w">        </span><span class="nt">&lt;/properties&gt;</span>
<span class="w">    </span><span class="nt">&lt;/aspect&gt;</span>
<span class="nt">&lt;/aspects&gt;</span>
</code></pre></div>
<p>This defines an aspect used to define a property that will store the third-party
reviewer's email address.</p>
<p>That's it for the workflow content model. Now configure it in the Alfresco Share
user interface.</p>
<h4 id="configure-the-alfresco-share-user-interface">Configure the Alfresco Share user interface<a class="headerlink" href="#configure-the-alfresco-share-user-interface" title="Permanent link">&para;</a></h4>
<p>In the Hello World UI example you saw that Alfresco Share is configured using <a href="https://github.com/jpotts/alfresco-developer-series/blob/master/workflow/workflow-tutorial/workflow-tutorial-share/src/main/resources/META-INF/share-config-custom.xml">share-config-custom.xml</a>.
Because it is mostly repetitive, I'll just show the configuration for
<code>scwf:activitiReviewTask</code> here and if you want to see the rest of the Share
configuration, you can look at the source that accompanies this tutorial.</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;config</span><span class="w"> </span><span class="na">evaluator=</span><span class="s">&quot;task-type&quot;</span><span class="w"> </span><span class="na">condition=</span><span class="s">&quot;scwf:activitiReviewTask&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;forms&gt;</span>
<span class="w">        </span><span class="nt">&lt;form&gt;</span>
<span class="w">            </span><span class="nt">&lt;field-visibility&gt;</span>
<span class="w">                </span><span class="nt">&lt;show</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;bpm:workflowDescription&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">                </span><span class="nt">&lt;show</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;packageItems&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">                </span><span class="nt">&lt;show</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;scwf:approveRejectOutcome&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">                </span><span class="nt">&lt;show</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;transitions&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;/field-visibility&gt;</span>
<span class="w">            </span><span class="nt">&lt;appearance&gt;</span>
<span class="w">                </span><span class="nt">&lt;set</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="na">appearance=</span><span class="s">&quot;title&quot;</span><span class="w"> </span><span class="na">label-id=</span><span class="s">&quot;workflow.set.general&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">                </span><span class="nt">&lt;set</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;info&quot;</span><span class="w"> </span><span class="na">appearance=</span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="na">template=</span><span class="s">&quot;/org/alfresco/components/form/2-column-set.ftl&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">                </span><span class="nt">&lt;set</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;assignee&quot;</span><span class="w"> </span><span class="na">appearance=</span><span class="s">&quot;title&quot;</span><span class="w"> </span><span class="na">label-id=</span><span class="s">&quot;workflow.set.assignee&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">                </span><span class="nt">&lt;set</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;items&quot;</span><span class="w"> </span><span class="na">appearance=</span><span class="s">&quot;title&quot;</span><span class="w"> </span><span class="na">label-id=</span><span class="s">&quot;workflow.set.items&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">                </span><span class="nt">&lt;set</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;response&quot;</span><span class="w"> </span><span class="na">appearance=</span><span class="s">&quot;title&quot;</span><span class="w"> </span><span class="na">label-id=</span><span class="s">&quot;workflow.set.response&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">                </span><span class="nt">&lt;field</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;bpm:workflowDescription&quot;</span><span class="w"> </span><span class="na">label-id=</span><span class="s">&quot;workflow.field.message&quot;</span><span class="nt">&gt;</span>
<span class="w">                    </span><span class="nt">&lt;control</span><span class="w"> </span><span class="na">template=</span><span class="s">&quot;/org/alfresco/components/form/controls/textarea.ftl&quot;</span><span class="nt">&gt;</span>
<span class="w">                        </span><span class="nt">&lt;control-param</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;style&quot;</span><span class="nt">&gt;</span>width:<span class="w"> </span>95%<span class="nt">&lt;/control-param&gt;</span>
<span class="w">                    </span><span class="nt">&lt;/control&gt;</span>
<span class="w">                </span><span class="nt">&lt;/field&gt;</span>
<span class="w">                </span><span class="nt">&lt;field</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;packageItems&quot;</span><span class="w"> </span><span class="na">set=</span><span class="s">&quot;items&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">                </span><span class="nt">&lt;field</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;scwf:approveRejectOutcome&quot;</span><span class="w"> </span><span class="na">set=</span><span class="s">&quot;response&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">                </span><span class="nt">&lt;field</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;transitions&quot;</span><span class="w"> </span><span class="na">set=</span><span class="s">&quot;response&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;/appearance&gt;</span>
<span class="w">        </span><span class="nt">&lt;/form&gt;</span>
<span class="w">    </span><span class="nt">&lt;/forms&gt;</span>
<span class="nt">&lt;/config&gt;</span>
</code></pre></div>
<p>Something that isn't immediately obvious without looking closely at the
accompanying Share form configuration is that there are multiple workflow form
configurations needed for a given workflow. This table explains what
configuration does what:</p>
<table>
<thead>
<tr>
<th>For example, this configuration...</th>
<th>Is used by Share to figure out...</th>
</tr>
</thead>
<tbody>
<tr>
<td>\&lt;config evaluator="string-compare" condition="activiti\$publishWhitepaper"&gt;</td>
<td>What form to use when a workflow is started that has an ID matching the condition.</td>
</tr>
<tr>
<td>\&lt;config evaluator="task-type" condition="scwf:activitiReviewTask"&gt;\&lt;form&gt;...\&lt;/form&gt;</td>
<td>What form to use when someone manages a task with an activiti:formKey that matches the condition.</td>
</tr>
<tr>
<td>\&lt;config evaluator="task-type" condition="scwf:activitiReviewTask"&gt;\&lt;form id=”workflow-details”&gt;...\&lt;/form&gt;</td>
<td>What form to use when someone opens the "Workflow Details" page (e.g., from Workflows I've Started) where the last completed task has an <code>activiti:formKey</code> that matches the condition.</td>
</tr>
</tbody>
</table>
<p>Table: What does the config do?</p>
<h4 id="externalize-the-strings_1">Externalize the strings<a class="headerlink" href="#externalize-the-strings_1" title="Permanent link">&para;</a></h4>
<p>The last step is to externalize the strings in the model and process. Remember
that in the Hello World UI example the strings went into two files named
"scWorkflow.properties", one for the workflow-tutorial-platform module and
one for the workflow-tutorial-share module.</p>
<p>The one in the workflow-tutorial-platform module resides in:</p>
<div class="highlight"><pre><span></span><code>$TUTORIAL_HOME/workflow-tutorial-platform/src/main/resources/alfresco/module/workflow-tutorial-platform/messages
</code></pre></div>
<p>Add the following to <a href="https://github.com/jpotts/alfresco-developer-series/blob/master/workflow/workflow-tutorial/workflow-tutorial-platform/src/main/resources/alfresco/module/workflow-tutorial-platform/messages/scWorkflow.properties">scWorkflow.properties</a>:</p>
<div class="highlight"><pre><span></span><code>publishWhitepaper.workflow.title=Publish Whitepaper to Web (Activiti)
publishWhitepaper.workflow.description=Review and approve Someco Whitepaper content using Activiti
</code></pre></div>
<p>Note that the first part of the property key matches the name you gave the
process definition. The values for the workflow.title and workflow.description
keys will be what the user sees when she clicks "Start Advanced Workflow" in
Alfresco Share.</p>
<p>Also add this set of properties, which are for the types and properties defined
in the workflow model:</p>
<p><div class="highlight"><pre><span></span><code>scwf_workflowmodel.type.scwf_submitReviewTask.title=Start Someco Web Review
scwf_workflowmodel.type.scwf_submitReviewTask.description=Submit Someco Web documents for review &amp; approval to a group of people

scwf_workflowmodel.type.scwf_activitiMarketingReview.title=Marketing Review
scwf_workflowmodel.type.scwf_activitiMarketingReview.description=Review documents for impact on Someco marketing message

scwf_workflowmodel.type.scwf_activitiOperationsReview.title=Operations Review
scwf_workflowmodel.type.scwf_activitiOperationsReview.description=Review documents for technical accuracy and best practices

scwf_workflowmodel.type.scwf_activitiThirdPartyReview.title=Third Party Review
scwf_workflowmodel.type.scwf_activitiThirdPartyReview.description=Obtain third party approval

scwf_workflowmodel.type.scwf_activitiRevise.title=Revise
scwf_workflowmodel.type.scwf_activitiRevise.description=Make changes then resubmit or abort

scwf_workflowmodel.type.scwf_activitiReviewTask.title=Review
scwf_workflowmodel.type.scwf_activitiReviewTask.description=Approve or reject this change

scwf_workflowmodel.property.scwf_reviewerEmail.title=Reviewer email
scwf_workflowmodel.property.scwf_reviewerEmail.description=Third-party reviewer email address

scwf_workflowmodel.property.scwf_approveRejectOutcome.title=Outcome
scwf_workflowmodel.property.scwf_approveRejectOutcome.description=Reviewer outcome

scwf_workflowmodel.property.scwf_reviseOutcome.title=Outcome
scwf_workflowmodel.property.scwf_reviseOutcome.description=Reviewer outcome
</code></pre></div>
The first part of the key is the name of the workflow model, then whether or not
this key is for a type or a property, then the name of the type or property.
These are the strings shown when someone manages a task.</p>
<p>Now edit <a href="https://github.com/jpotts/alfresco-developer-series/blob/master/workflow/workflow-tutorial/workflow-tutorial-share/src/main/resources/alfresco/web-extension/messages/scWorkflow.properties">scWorkflow.properties</a> in the workflow-tutorial-share module. It resides in:</p>
<div class="highlight"><pre><span></span><code>$TUTORIAL_HOME/workflow-tutorial-share/src/main/resources/alfresco/web-extension/messages
</code></pre></div>
<p>Add these properties to the file:</p>
<div class="highlight"><pre><span></span><code>workflow.scwf_publishWhitepaper=SC Publish Whitepaper

#scwf:publishWhitepaper
prop.scwf_reviewerEmail=Reviewer Email
</code></pre></div>
<p>Save the file and you are ready to deploy and test what you have so far.</p>
<h3 id="deploy-and-test">Deploy and test<a class="headerlink" href="#deploy-and-test" title="Permanent link">&para;</a></h3>
<p>You created a new workflow so it needs to be deployed via Spring. Edit the "<a href="https://github.com/jpotts/alfresco-developer-series/blob/master/workflow/workflow-tutorial/workflow-tutorial-platform/src/main/resources/alfresco/module/workflow-tutorial-platform/context/bootstrap-context.xml">bootstrap-context.xml</a>" file that resides in:</p>
<div class="highlight"><pre><span></span><code>$TUTORIAL_HOME/workflow-tutorial-platform/src/main/resources/alfresco/module/workflow-tutorial-platform/context
</code></pre></div>
<p>Add the new workflow to the list of workflows:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;props&gt;</span>
<span class="w">    </span><span class="nt">&lt;prop</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;engineId&quot;</span><span class="nt">&gt;</span>activiti<span class="nt">&lt;/prop&gt;</span>
<span class="w">    </span><span class="nt">&lt;prop</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;location&quot;</span><span class="nt">&gt;</span>alfresco/module/${project.artifactId}/workflow/publishWhitepaper.bpmn<span class="nt">&lt;/prop&gt;</span>
<span class="w">    </span><span class="nt">&lt;prop</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;mimetype&quot;</span><span class="nt">&gt;</span>text/xml<span class="nt">&lt;/prop&gt;</span>
<span class="w">    </span><span class="nt">&lt;prop</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;redeploy&quot;</span><span class="nt">&gt;</span>false<span class="nt">&lt;/prop&gt;</span>
<span class="nt">&lt;/props&gt;</span>
</code></pre></div>
<p>At this stage you can continue to test using Alfresco on the SDK-generated
Docker containers configured by the Alfresco Maven SDK. Here are the steps
necessary to start up that you used earlier:</p>
<ol>
<li>Open a command-line window and switch to $TUTORIAL_HOME.</li>
<li>Stop the running containers with <code>./run.sh stop</code> (or <code>run.bat</code>).</li>
<li>Run <code>./run.sh build_start</code> (or <code>run.bat</code>). Your AMPs will be installed into
Docker containers running on 8080 (Alfresco) and 8180 (Share).</li>
</ol>
<p>When everything starts up:</p>
<ol>
<li>Go to http://localhost:8180/share and log in as admin (password: admin).</li>
<li>If you haven't done so already, create a group called "Operations" and a
group called "Marketing" and place one or more test users in each group.</li>
<li>Create a piece of test content. It doesn't matter what it is.</li>
<li>Now start a workflow for that piece of content.</li>
<li>You should see the "Submit Whitepaper" workflow in the list of workflows.
Start the workflow.</li>
</ol>
<p>You should see the workflow form you defined that includes the field for the
third-party reviewer email. Even though you haven't yet added logic to make
changes to the document in the workflow, you should at least be able to test
every path.</p>
<h2 id="step-2-implement-web-scripts-and-actions">Step 2: Implement web scripts and actions<a class="headerlink" href="#step-2-implement-web-scripts-and-actions" title="Permanent link">&para;</a></h2>
<p>Now that the base process is running and it's hooked in to the Alfresco UI,
it's time to make the process smarter by adding some business logic.</p>
<h3 id="call-the-set-web-action-on-approved-documents">Call the set-web-action on approved documents<a class="headerlink" href="#call-the-set-web-action-on-approved-documents" title="Permanent link">&para;</a></h3>
<p>When a whitepaper is approved it needs to show up on the web site. Recall from
the "<a href="https://ecmarchitect.com/alfresco-developer-series-tutorials/actions/tutorial/tutorial.html">Custom Actions</a>"
tutorial that there is already an action that will add the <code>sc:webable</code> aspect
to a document and set the <code>sc:isActive</code> and <code>sc:publishedFlag</code> properties. So
all you have to do is tell the process to execute it against the approved
whitepaper.</p>
<p>To do that, edit the business process and search for the <code>userTask</code> element
named "Approved Notification". Add the following extension element:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;userTask</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;usertask4&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;Approved Notification&quot;</span><span class="w"> </span><span class="na">activiti:assignee=</span><span class="s">&quot;${initiator.properties.userName}&quot;</span><span class="w"> </span><span class="na">activiti:formKey=</span><span class="s">&quot;scwf:activitiApprovedNotification&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;extensionElements&gt;</span>
<span class="w">        </span><span class="nt">&lt;activiti:taskListener</span><span class="w"> </span><span class="na">event=</span><span class="s">&quot;create&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;activiti:field</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;script&quot;</span><span class="nt">&gt;</span>
<span class="w">                </span><span class="nt">&lt;activiti:string&gt;</span>
<span class="w">                    </span>var<span class="w"> </span>setWebFlagAction<span class="w"> </span>=<span class="w"> </span>actions.create(&quot;set-web-flag&quot;);
<span class="w">                    </span>setWebFlagAction.parameters[&quot;active&quot;]<span class="w"> </span>=<span class="w"> </span>true;
<span class="w">                    </span>for<span class="w"> </span>(var<span class="w"> </span>i<span class="w"> </span>=<span class="w"> </span>0;<span class="w"> </span>i<span class="w"> </span><span class="ni">&amp;lt;</span><span class="w"> </span>bpm_package.children.length;<span class="w"> </span>i++)<span class="w"> </span>{
<span class="w">                        </span>logger.log(&quot;Approving<span class="w"> </span>node:&quot;<span class="w"> </span>+<span class="w"> </span>bpm_package.children[i].nodeRef);
<span class="w">                        </span>setWebFlagAction.execute(bpm_package.children[i]);
<span class="w">                    </span>}
<span class="w">                </span><span class="nt">&lt;/activiti:string&gt;</span>
<span class="w">            </span><span class="nt">&lt;/activiti:field&gt;</span>
<span class="w">        </span><span class="nt">&lt;/activiti:taskListener&gt;</span>
<span class="w">    </span><span class="nt">&lt;/extensionElements&gt;</span>
<span class="nt">&lt;/userTask&gt;</span>
</code></pre></div>
<p>This is a straightforward piece of Alfresco JavaScript that executes the custom
action called "set-web-flag" for every piece of content in the workflow package.
The action adds the aspect and sets the properties appropriately.</p>
<p>That's all that's needed to handle the approval. Now for the Third Party Review.</p>
<h3 id="implement-the-external-third-party-review">Implement the external third-party review<a class="headerlink" href="#implement-the-external-third-party-review" title="Permanent link">&para;</a></h3>
<p>The goal is to send an email to a third-party who may not have access to
Alfresco. The email will include two links--one if they approve the whitepaper
and one if they reject. When they click the link the workflow continues
execution along the selected path.</p>
<p>All of the business logic you've seen so far has been written in server-side
JavaScript. Let's change it up a little bit. There are two pieces required to
make this work. The first piece is some Java code that will send the email with
the "approve" and "reject" links in the email body. The recipient will open
their email and click on either the approve link or the reject link. This won't
require logging in to Alfresco at all. The second part is a web script that gets
called when the recipient clicks the links. The web script will get a handle to
the workflow task and set the outcome appropriately.</p>
<p>This may seem backwards, but let's build the web script that handles the links
first, then you'll see how to build an Activiti task listener class that sends
the email notification.</p>
<h4 id="implement-the-web-script">Implement the Web Script<a class="headerlink" href="#implement-the-web-script" title="Permanent link">&para;</a></h4>
<p>The "<a href="https://ecmarchitect.com/alfresco-developer-series-tutorials/webscripts/tutorial/tutorial.html">Introduction to Web Scripts</a>"
tutorial showed you how to create custom web scripts, so I am only going to show
you the Java class that acts as the web script controller. See the source for
the other files that make up the web script.</p>
<p>The source for the web script's controller resides in:</p>
<div class="highlight"><pre><span></span><code>$TUTORIAL_HOME/workflow-tutorial-platform/src/main/java
</code></pre></div>
<p>First, create a package folder structure called "com/someco/scripts".</p>
<p>Now create a new class called "<a href="https://github.com/jpotts/alfresco-developer-series/blob/master/workflow/workflow-tutorial/workflow-tutorial-platform/src/main/java/com/someco/scripts/GetReview.java">GetReview</a>"
. Here's the class, without the imports or the getter/setter methods:</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">GetReview</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">DeclarativeWebScript</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="n">Log</span><span class="w"> </span><span class="n">logger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LogFactory</span><span class="p">.</span><span class="na">getLog</span><span class="p">(</span><span class="n">GetReview</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Dependencies</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">WorkflowService</span><span class="w"> </span><span class="n">workflowService</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">executeImpl</span><span class="p">(</span><span class="n">WebScriptRequest</span><span class="w"> </span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">Status</span><span class="w"> </span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">req</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">req</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&quot;action&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">logger</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;Email, ID, action, or secret not set&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="n">status</span><span class="p">.</span><span class="na">setCode</span><span class="p">(</span><span class="mi">400</span><span class="p">);</span>
<span class="w">            </span><span class="n">status</span><span class="p">.</span><span class="na">setMessage</span><span class="p">(</span><span class="s">&quot;Required data has not been provided&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="n">status</span><span class="p">.</span><span class="na">setRedirect</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="p">();</span>

<span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">QName</span><span class="p">,</span><span class="w"> </span><span class="n">Serializable</span><span class="o">&gt;</span><span class="w"> </span><span class="n">props</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">QName</span><span class="p">,</span><span class="w"> </span><span class="n">Serializable</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">        </span><span class="n">props</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">QName</span><span class="p">.</span><span class="na">createQName</span><span class="p">(</span><span class="n">SomeCoWorkflowModel</span><span class="p">.</span><span class="na">NAMESPACE_SOMECO_WORKFLOW_CONTENT_MODEL</span><span class="p">,</span><span class="w"> </span><span class="n">SomeCoWorkflowModel</span><span class="p">.</span><span class="na">PROP_APPROVE_REJECT_OUTCOME</span><span class="p">),</span><span class="w"> </span><span class="n">action</span><span class="p">);</span>
<span class="w">        </span><span class="n">workflowService</span><span class="p">.</span><span class="na">updateTask</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">props</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<span class="w">        </span><span class="n">workflowService</span><span class="p">.</span><span class="na">endTask</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">action</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">model</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>The class grabs the task ID and the action to take (the outcome) and then uses
the workflow service to update and end the task. So, for example, if someone
were to post this URL:</p>
<div class="highlight"><pre><span></span><code>http://localhost:8080/alfresco/service/someco/bpm/review?id=activiti\$89&amp;action=Approve
</code></pre></div>
<p>the Java class would update the task identified by activiti$89 with the
"Approve" outcome.</p>
<p>If you are following along, don't forget to copy over the <a href="https://github.com/jpotts/alfresco-developer-series/blob/master/workflow/workflow-tutorial/workflow-tutorial-platform/src/main/resources/alfresco/extension/templates/webscripts/com/someco/bpm/review.get.desc.xml">web script descriptor</a>
and the <a href="https://github.com/jpotts/alfresco-developer-series/blob/master/workflow/workflow-tutorial/workflow-tutorial-platform/src/main/resources/alfresco/extension/templates/webscripts/com/someco/bpm/review.get.html.ftl">freemarker</a>
for the web script into:</p>
<div class="highlight"><pre><span></span><code>$TUTORIAL_HOME/workflow-tutorial-platform/src/main/resources/alfresco/extension/templates/webscripts/com/someco/bpm
</code></pre></div>
<p>You will also need to copy the Spring bean that wires in the Java controller into the <a href="https://github.com/jpotts/alfresco-developer-series/blob/master/workflow/workflow-tutorial/workflow-tutorial-platform/src/main/resources/alfresco/module/workflow-tutorial-platform/context/bootstrap-context.xml">bootstrap-context.xml</a>
file located in:</p>
<div class="highlight"><pre><span></span><code>$TUTORIAL_HOME/workflow-tutorial-platform/src/main/resources/alfresco/module/workflow-tutorial-platform/context
</code></pre></div>
<p>Once these are in place, the web script will be ready to receive clicks from the
email that gets sent out. Writing code that sends the email is the next step.</p>
<h4 id="create-a-custom-task-listener">Create a custom task listener<a class="headerlink" href="#create-a-custom-task-listener" title="Permanent link">&para;</a></h4>
<p>The second piece to the Third Party Review is sending the email to the
third-party. There is an out-of-the-box mail action, and you've already seen how
to call an action from a workflow using Alfresco JavaScript, but there are a few
things to take care of other than simply sending an email, so let's write a
custom task listener class to handle it.</p>
<p>First, create a new package called "com.someco.bpm".</p>
<p>Then, create a new class called "<a href="https://github.com/jpotts/alfresco-developer-series/blob/master/workflow/workflow-tutorial/workflow-tutorial-platform/src/main/java/com/someco/bpm/ExternalReviewNotification.java">ExternalReviewNotification</a>"
. The goal is to send an email that has two links—one for approve and one for
reject—that represent the two possible outcomes of the Third Party Review user
task. The links need to include the task ID and the desired outcome as
arguments.</p>
<p>The task listener's notify method will be called by Activiti. Here is what the
method looks like:</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">notify</span><span class="p">(</span><span class="n">DelegateTask</span><span class="w"> </span><span class="n">task</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">recipient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
<span class="w">    </span><span class="n">task</span><span class="p">.</span><span class="na">getVariable</span><span class="p">(</span><span class="n">ExternalReviewNotification</span><span class="p">.</span><span class="na">RECIP_PROCESS_VARIABLE</span><span class="p">);</span>

<span class="w">    </span><span class="n">StringBuffer</span><span class="w"> </span><span class="n">sb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StringBuffer</span><span class="p">();</span>
<span class="w">    </span><span class="n">sb</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="s">&quot;You have been assigned to a task named &quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">sb</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span>
<span class="w">    </span><span class="n">sb</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="s">&quot;. Take the appropriate action by clicking one of the links below:rnrn&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">sb</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="n">getLink</span><span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;Approve&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="n">sb</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="n">getLink</span><span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;Reject&quot;</span><span class="p">));</span>

<span class="w">    </span><span class="n">ActionService</span><span class="w"> </span><span class="n">actionService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getServiceRegistry</span><span class="p">().</span><span class="na">getActionService</span><span class="p">();</span>
<span class="w">    </span><span class="n">Action</span><span class="w"> </span><span class="n">mailAction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">actionService</span><span class="p">.</span><span class="na">createAction</span><span class="p">(</span><span class="n">MailActionExecuter</span><span class="p">.</span><span class="na">NAME</span><span class="p">);</span>

<span class="w">    </span><span class="n">mailAction</span><span class="p">.</span><span class="na">setParameterValue</span><span class="p">(</span><span class="n">MailActionExecuter</span><span class="p">.</span><span class="na">PARAM_SUBJECT</span><span class="p">,</span><span class="w"> </span><span class="n">ExternalReviewNotification</span><span class="p">.</span><span class="na">SUBJECT</span><span class="p">);</span>
<span class="w">    </span><span class="n">mailAction</span><span class="p">.</span><span class="na">setParameterValue</span><span class="p">(</span><span class="n">MailActionExecuter</span><span class="p">.</span><span class="na">PARAM_TO</span><span class="p">,</span><span class="w"> </span><span class="n">recipient</span><span class="p">);</span>
<span class="w">    </span><span class="n">mailAction</span><span class="p">.</span><span class="na">setParameterValue</span><span class="p">(</span><span class="n">MailActionExecuter</span><span class="p">.</span><span class="na">PARAM_FROM</span><span class="p">,</span><span class="w"> </span><span class="n">ExternalReviewNotification</span><span class="p">.</span><span class="na">FROM_ADDRESS</span><span class="p">);</span>
<span class="w">    </span><span class="n">mailAction</span><span class="p">.</span><span class="na">setParameterValue</span><span class="p">(</span><span class="n">MailActionExecuter</span><span class="p">.</span><span class="na">PARAM_TEXT</span><span class="p">,</span><span class="w"> </span><span class="n">sb</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span>

<span class="w">    </span><span class="n">actionService</span><span class="p">.</span><span class="na">executeAction</span><span class="p">(</span><span class="n">mailAction</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>The first thing the method does is grab the recipient from a process variable.
Next, it uses a string buffer to start building the message body. The
<code>task.getName()</code> call grabs the node name ("Third Party Review").</p>
<p>The <code>getLink()</code> method is just a helper method that produces a link that looks
like this:</p>
<div class="highlight"><pre><span></span><code>http://localhost:8080/alfresco/service/someco/bpm/review?id=activiti\$999&amp;action=Approve&amp;guest=true
</code></pre></div>
<p>The method has the host and port hardcoded which is another thing you'd want to
fix if you did this for real.</p>
<p>The last major block of code in the <code>notify()</code> method uses the action service to
execute the Alfresco mail action. Sure, you could use the Java mail API to do it
yourself, but why not leverage the mail action? That way you can leverage the
same SMTP configuration settings already configured for Alfresco in
alfresco-global.properties.</p>
<p>The last thing to do is to call the <code>ExternalReviewNotification</code> class from the
process. Edit the <a href="https://github.com/jpotts/alfresco-developer-series/blob/master/workflow/workflow-tutorial/workflow-tutorial-platform/src/main/resources/alfresco/module/workflow-tutorial-platform/workflow/publishWhitepaper.bpmn">publishWhitepaper.bpmn</a>
file and find the task named "Third Party Review". The user task already has a
task listener on the "complete" event that you added earlier. Insert a new
<code>activiti:taskListener</code> element that creates a task listener on the "create"
event that invokes the ExternalReviewNotification class, like this:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;userTask</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;usertask5&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;Third Party Review&quot;</span><span class="w"> </span><span class="na">activiti:assignee=</span><span class="s">&quot;${initiator.properties.userName}&quot;</span><span class="w"> </span><span class="na">activiti:formKey=</span><span class="s">&quot;scwf:activitiThirdPartyReview&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;extensionElements&gt;</span>
<span class="w">        </span><span class="nt">&lt;activiti:taskListener</span><span class="w"> </span><span class="na">event=</span><span class="s">&quot;create&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;com.someco.bpm.ExternalReviewNotification&quot;</span><span class="nt">&gt;&lt;/activiti:taskListener&gt;</span>
<span class="w">        </span><span class="nt">&lt;activiti:taskListener</span><span class="w"> </span><span class="na">event=</span><span class="s">&quot;complete&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;activiti:field</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;script&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span>...
</code></pre></div>
<p>Now the process will send an email to a third-party reviewer if an email address
is specified, the third-party reviewer can click on the appropriate outcome link
which will trigger a web script causing the workflow to continue along the right
path, and if the whitepaper is ultimately approved, the workflow will invoke the
"set web flag" action to set its properties so it can be searched for and
displayed on a web site.</p>
<h3 id="deploy-and-test_1">Deploy and test<a class="headerlink" href="#deploy-and-test_1" title="Permanent link">&para;</a></h3>
<p>It's time to deploy and test. If you want to try out the notification piece,
you'll need access to an SMTP server. For developing and testing locally,
<a href="http://james.apache.org/">Apache James</a> works great.</p>
<p>Remember to edit alfresco-global.properties to set your outgoing email settings
to match your environment. The alfresco-global.properties file that is copied to
the Docker container resides in "workflow-tutorial-platform-docker" under
src/main/docker. For example, I have Apache James running on a little test
server, so I've added the following to the alfresco-global.properties file:</p>
<div class="highlight"><pre><span></span><code>## Outbound email settings
mail.host=192.168.0.30
mail.port=25
mail.protocol=smtp
</code></pre></div>
<p>I often use my local /etc/hosts file to resolve IP addresses, but because
Alfresco is running in a Docker container, that won't work, so I'm using the IP
address instead of the hostname.</p>
<p>Two critical dependencies to your test are the content-tutorial and
actions-tutorial AMPs. These must be deployed to the same repository your
workflow-tutorial AMP is deployed to because your business process leverages an
action and some Java code that exists in those AMPs.</p>
<p>That's why, in the very beginning of the tutorial, you edited the Docker module
pom.xml to add those projects as dependencies. That way, when you run the
containers those AMPs will be installed automatically.</p>
<p>If you are deploying the workflow tutorial AMPs to a standalone Alfresco
installation, you can deploy the AMPs to your Alfresco installation as you
normally would using the "apply_amps.sh" script.</p>
<p>Deploying to a standalone Alfresco is fine, but while you are developing (and
working through these tutorials) it is easiest to use the Docker containers.</p>
<p>Start it up by doing <code>./run.sh build_start</code> or <code>run.bat</code> depending on your
platform. When it comes up, you'll be ready to test.</p>
<p>At a minimum, you'll need to run several workflows:</p>
<ol>
<li>The whitepaper receives all of its approvals but does not have a
third-party reviewer.</li>
<li>The whitepaper receives all of its approvals, has a third-party reviewer, and
the third-party approves.</li>
<li>The whitepaper receives all of its approvals, has a third-party reviewer, and
the third-party rejects, followed by a re-submission that then gets approved all
the way through.</li>
</ol>
<p>When you test using the third-party reviewer email you should get an email that
looks like this:</p>
<p><img alt="Third Party Reviewer notification email" src="../images/reviewer-email-notification.png" /></p>
<p>Clicking on a link causes the workflow to proceed along the specified path.</p>
<p><strong>Warning: The Third Party example is <em>not</em> production-ready</strong></p>
<p>I included the third-party example to show one type of wait-state/asynchronous
behavior in a process. It's got a long way to go before it can be used in
production. A short list list of obvious issues includes:</p>
<ul>
<li>The email recipient doesn't get a copy of the documents being reviewed. One
way to address this would be to have the notification action send a zip of the
documents in the workflow package. Another way would be to write additional web
scripts or send them a download link. I simply didn't have time to implement
this and figured it was a bit off-topic anyway.</li>
<li>It'd be really easy for an unauthorized person to signal any node in the
system because the controller class doesn't do any validation whatsoever and the
task ID's are trivial to guess. In real life, you'd want to check that (1) the
person making the request is the person assigned to the task, (2) that the task
is still active, and (3) possibly use an additional security mechanism like a
shared secret of some kind.</li>
<li>The email body should probably come from a Freemarker template. That way you
could reuse the notification class in any number of processes and it simplifies
email body maintenance.</li>
</ul>
<p>So, long story short, feel free to use this idea, but realize that I've cut
corners for brevity's sake.</p>
<h2 id="step-3-add-a-timer-to-the-third-party-task">Step 3: Add a timer to the third-party task<a class="headerlink" href="#step-3-add-a-timer-to-the-third-party-task" title="Permanent link">&para;</a></h2>
<p>What if you sent an email to the third party and they never took action? One way
to handle that problem is with a timer.</p>
<p>One way to do this is to add a boundary timer to the Third Party Review task.
When the timer expires, the timer can cancel the Third Party Review task and
then route to the Approved task.</p>
<p>Here's how to do it:</p>
<ol>
<li>Edit the <a href="https://github.com/jpotts/alfresco-developer-series/blob/master/workflow/workflow-tutorial/workflow-tutorial-platform/src/main/resources/alfresco/module/workflow-tutorial-platform/workflow/publishWhitepaper.bpmn">publishWhitepaper.bpmn</a>
process definition file.</li>
<li>
<p>Find the Third-Party Review task. In my diagram it is "usertask2". Find the
"Approved Notification" task. In my diagram it is "usertask5". With those
references updated to reflect the values in your diagram, add the following:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;boundaryEvent</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;boundarytimer1&quot;</span><span class="w"> </span><span class="na">cancelActivity=</span><span class="s">&quot;true&quot;</span><span class="w"> </span><span class="na">attachedToRef=</span><span class="s">&quot;usertask2&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;timerEventDefinition&gt;</span>
<span class="w">        </span><span class="nt">&lt;timeDuration&gt;</span>PT5M<span class="nt">&lt;/timeDuration&gt;</span>
<span class="w">    </span><span class="nt">&lt;/timerEventDefinition&gt;</span>
<span class="nt">&lt;/boundaryEvent&gt;</span>
<span class="nt">&lt;sequenceFlow</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;toExpiredApprove&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="na">sourceRef=</span><span class="s">&quot;boundarytimer1&quot;</span><span class="w"> </span><span class="na">targetRef=</span><span class="s">&quot;usertask5&quot;</span><span class="nt">&gt;&lt;/sequenceFlow&gt;</span>
</code></pre></div>
</li>
</ol>
<p>This sets the timer for 5 minutes—that's what the "PT5M" expression means--but
you could obviously set it for as long or as short as you wish. That expression
is part of the <a href="http://en.wikipedia.org/wiki/ISO_8601">ISO 8601</a> standard for
durations.</p>
<p>Setting an absolute date works as well. The due date could also be the result of
an expression. To use a specific date instead of a duration, use a <code>timeDate</code>
element instead of a <code>timeDuration</code> element.</p>
<h3 id="deploy-and-test_2">Deploy and test<a class="headerlink" href="#deploy-and-test_2" title="Permanent link">&para;</a></h3>
<p>If you only make changes to the process definition, you can just build the
project and restart the Alfresco container. You don't have to restart all of the
containers. To do that, run <code>mvn install -DskipTests</code> and then <code>./run.sh reload_acs</code>
to rebuild and reload the Alfresco container.</p>
<p>Remember to use the Alfresco workflow console to redeploy the process
definition.</p>
<p>Now test the third-party reviewer path but instead of clicking the approve or
reject link that is included in the email, ignore it for five minutes. You
should see the workflow continue along the approved path when the timer expires.</p>
<h1 id="conclusion">Conclusion<a class="headerlink" href="#conclusion" title="Permanent link">&para;</a></h1>
<p>You now know the ins and outs of implementing advanced workflows using the
Activiti engine embedded within Alfresco. You know when Alfresco's basic
workflows will suffice and when advanced workflows are more appropriate. You
learned that process definitions are collections of events, tasks, and gateways
joined by sequence flows. The representation of a process definition, both as a
diagram, and as XML, is standardized through BPMN. And, you now know how to add
business logic to workflows using expressions, Alfresco JavaScript, and Java.</p>
<p>I also walked you through the overall process of implementing advanced workflows
in Alfresco by walking through some simple Hello World examples and then a more
complex example that used many different node types and business logic options.
I even spiced things up a bit by exposing the business process to a third-party
via SMTP and HTTP with the help of the web script framework.</p>
<p>Hopefully, this has sparked some ideas about how you can leverage Alfresco and
Activiti in your own projects and has given you some concrete examples you can
leverage in your own projects going forward.</p>
<h1 id="where-to-find-more-information">Where to find more information<a class="headerlink" href="#where-to-find-more-information" title="Permanent link">&para;</a></h1>
<ul>
<li>The complete source code for these examples is available on <a href="https://github.com/jpotts/alfresco-developer-series">GitHub</a>.</li>
<li>Official documentation for both Enterprise Edition and Community Edition is
available at <a href="http://docs.alfresco.com/">docs.alfresco.com</a>.</li>
<li>Ask questions about Activiti embedded within Alfresco in the <a href="http://community.alfresco.com">Alfresco Community</a>.</li>
<li>If you are ready to cover new ground, try another <a href="https://ecmarchitect.com">ecmarchitect.com</a>
tutorial in the <a href="https://ecmarchitect.com/alfresco-developer-series">Alfresco Developer Series</a>.</li>
<li>Activiti and BPMN<ul>
<li>The <a href="http://activiti.org/">Activiti home page</a> has documentation and
tutorials.</li>
<li>OMG hosts <a href="http://www.bpmn.org/">bpmn.org</a>, which is where the <a href="http://www.omg.org/spec/BPMN/2.0/">BPMN 2.0 spec</a> lives as well as the <a href="http://www.omg.org/cgi-bin/doc?dtc/10-06-02">BPMN by Example</a> document.</li>
</ul>
</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.instant", "navigation.sections", "navigation.top", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>