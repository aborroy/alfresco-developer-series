
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Tutorials and best practices for Alfresco developers">
      
      
      
      
        <link rel="prev" href="../../../actions/tutorial/tutorial/">
      
      
        <link rel="next" href="../../../webscripts/tutorial/tutorial/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.20">
    
    
      
        <title>Behaviors - Alfresco Developer Series</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.e53b48f4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#implementing-custom-behaviors-in-alfresco" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Alfresco Developer Series" class="md-header__button md-logo" aria-label="Alfresco Developer Series" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Alfresco Developer Series
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Behaviors
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/aborroy/alfresco-developer-series" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Alfresco Developer Series" class="md-nav__button md-logo" aria-label="Alfresco Developer Series" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Alfresco Developer Series
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/aborroy/alfresco-developer-series" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Tutorials
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../maven-sdk/tutorial/tutorial/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Maven SDK
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../content/tutorial/tutorial/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Content Types & CMIS
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../actions/tutorial/tutorial/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Actions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Behaviors
    
  </span>
  

      </a>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../webscripts/tutorial/tutorial/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    WebScripts
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../workflow/tutorial/tutorial/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Workflows
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="implementing-custom-behaviors-in-alfresco">Implementing Custom Behaviors in Alfresco<a class="headerlink" href="#implementing-custom-behaviors-in-alfresco" title="Permanent link">&para;</a></h1>
<p><em>Jeff Potts, <a href="https://www.metaversant.com">Metaversant Group</a> — July, 2021</em></p>
<h1 id="license">License<a class="headerlink" href="#license" title="Permanent link">&para;</a></h1>
<p><img alt="" src="../images/cc-by-sa-88x31.png" /></p>
<p>This work is licensed under the Creative Commons Attribution-ShareAlike 3.0
Unported License. To view a copy of this license, visit http://creativecommons.org/licenses/by-sa/3.0/
or send a letter to Creative Commons, 444 Castro Street, Suite 900, Mountain
View, California, 94041, USA.</p>
<h1 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h1>
<p>This tutorial discusses how to write your own custom behavior code in
Java or JavaScript and then bind that code to node events or “policies”.</p>
<p>In previous tutorials I've discussed how to create <a href="https://ecmarchitect.com/alfresco-developer-series-tutorials/content/tutorial/tutorial.html">custom content models</a>
and how to write <a href="https://ecmarchitect.com/alfresco-developer-series-tutorials/actions/tutorial/tutorial.html">custom actions</a>.
In both cases, you've seen how to write code that works with custom content
types, properties, aspects, and associations, but the code wasn't tightly
coupled to the objects on which it operated. For example, with an action, the
business logic is triggered by something—a rule, a clicked link in the user
interface, a schedule, or a workflow—rather than being <em>bound</em> to the content
type or aspect.</p>
<p>Actions are very useful when the business logic the action carries out is
generic enough to be applied to many types of objects. The out-of-the-box
"copy", "move", or "add aspect" actions are obvious examples.</p>
<p>There are times, though, when you want code to be tightly-coupled to a
content type because you need to be sure it gets executed every time something
happens to that object rather than leaving it up to a rule on a folder or some
other trigger. Fortunately, Alfresco provides just such a mechanism—it's called
<em>behavior</em>.</p>
<p>Behaviors are used throughout Alfresco. Auditing and versioning are examples
where behaviors are involved. Here are a couple of other real world examples
where behaviors might be useful:</p>
<ul>
<li>You might need to default some metadata values using logic that can't be
expressed using Alfresco content model XML. An example might be that you want to
generate a unique identifier for an object when it is added to the repository.
You can write a custom behavior
that will set the property with the value of the identifier regardless of how
the object is created.</li>
<li>Suppose you have some metadata stored on a folder and you want some of that
metadata to be copied to items that get placed in those folders. You could write
a custom behavior to handle this kind of synchronization.</li>
</ul>
<p>In this tutorial you'll see a simple example also based on a real-world
implementation: Using a custom behavior to compute the average user rating
(based on a five star scale) for a piece of content.</p>
<p>As a side-note, Alfresco has rating functionality built-in. Out-of-the-box it
uses a simple "like" model but the underlying model supports other schemes. This
tutorial completely ignores what's available out-of-the-box.</p>
<p>You should already be familiar with general Alfresco concepts. If you want to
follow along, you should also know how to write basic Java code. You may want to
work through the <a href="https://ecmarchitect.com/alfresco-developer-series-tutorials/content/tutorial/tutorial.html">custom content models tutorial</a>
if you aren't already familiar with how to extend Alfresco's content model.</p>
<p>All of the source code that accompanies this tutorial is available on <a href="https://github.com/jpotts/alfresco-developer-series">GitHub</a>.</p>
<h1 id="introducing-the-user-ratings-example">Introducing the user ratings example<a class="headerlink" href="#introducing-the-user-ratings-example" title="Permanent link">&para;</a></h1>
<p>Recall that the custom content types tutorial created a custom type called
"whitepaper" for a fictitious company called SomeCo. The custom model also
included an aspect called “webable” that gets attached to content objects SomeCo
wants to show on the web. So, for example, SomeCo might use Alfresco to manage
all of its whitepapers, but show only a subset on the web. Whitepapers that need
to be shown on the web get the webable aspect attached and the <code>sc:isActive</code>
flag set to <code>true</code>. The front-end can then query for whitepapers based on that
flag.</p>
<p>Now let's extend that example further. Suppose that the Marketing folks at
SomeCo have decided to add user ratings to their web site. They would like users
to be able to assign a rating to a whitepaper and to display the average of all
ratings received for a specific whitepaper.</p>
<p>Assuming SomeCo wants to store the ratings in Alfresco instead of some other
repository, like a relational or NoSQL database, one way to do this is to create
a custom “rating” type that is related to a whitepaper through a child
association. A custom “rateable” aspect can be used to define the
association as well as a property to store the average rating for that
whitepaper. Any object in the repository will get all of the metadata it needs
to become "rateable" simply by adding the aspect to the object.</p>
<p>The image below shows the original custom content model with these enhancements.</p>
<p><img alt="SomeCo's content model modified to support ratings" src="../images/someco-model-with-ratings.png" /></p>
<p>That takes care of the data model, but what about the code that computes the
average? There are a few options to consider:</p>
<ol>
<li><strong>Rule Action</strong>. One way to handle it would be to write an action that gets
called by a rule. Any time a rating is added to a folder, the rule would trigger
the action to update the average. But this isn't the best option because every
time SomeCo wants to use user ratings functionality, they'd have to make sure to
set up a rule on the folder.</li>
<li><strong>Scheduled Action</strong>. A scheduled action might not be bad—it could be written
to find all objects with the rateable aspect and then compute the average. But
if SomeCo wants the average rating computed in real-time (and let's assume they
do) a scheduled action isn't a great option.</li>
<li><strong>Behavior</strong>. The third (and best) option is to use a behavior. The behavior
will contain the logic needed to compute the average. It will be bound to the
appropriate policies on the rating content type so that any time a rating gets
created (or deleted), the behavior will find the rating's parent (the
whitepaper) and recalculate the average rating.</li>
</ol>
<h2 id="what-can-trigger-a-behavior">What can trigger a behavior?<a class="headerlink" href="#what-can-trigger-a-behavior" title="Permanent link">&para;</a></h2>
<p>So the rating content type will contain business logic that knows how to compute
the overall average rating for a whitepaper. But what will trigger that logic?
The answer is that there are a bunch of <em>policies</em> to which your behavior can be
bound. To find out what's available, you need only look as far as the source
code (or the <a href="http://dev.alfresco.com/resource/docs/java/">Javadocs</a>). If you
search for classes that end in "*Policies" you'll find several interfaces,
including:</p>
<ul>
<li>CheckOutCheckInServicePolicies</li>
<li>ContentServicePolicies</li>
<li>CopyServicePolicies</li>
<li>LockServicePolicies</li>
<li>NodeServicePolicies</li>
<li>TransferServicePolicies</li>
<li>VersionServicePolicies</li>
</ul>
<p>Each of those interfaces contains inner interfaces that represent the policies
you can hook into. Check the Javadocs or source code for specifics—I'm listing
the methods in the table below so you can see an example of what's available.</p>
<p>Note: To make it easier to read, I'm omitting the inner interface which
follows the pattern of <code>&lt;method-name&gt;Policy</code>. For example, the
<code>onContentUpdate</code> method is a method of the inner interface
<code>OnContentUpdatePolicy</code>.</p>
<table>
<thead>
<tr>
<th>Interface</th>
<th>Method</th>
</tr>
</thead>
<tbody>
<tr>
<td>org.alfresco.repo.content.ContentServicePolicies</td>
<td>onContentPropertyUpdate \</td>
</tr>
<tr>
<td>onContentRead \</td>
<td></td>
</tr>
<tr>
<td>onContentUpdate</td>
<td></td>
</tr>
<tr>
<td>org.alfresco.repo.copy.CopyServicePolicies</td>
<td>beforeCopy \</td>
</tr>
<tr>
<td>onCopyComplete \</td>
<td></td>
</tr>
<tr>
<td>onCopyNode</td>
<td></td>
</tr>
<tr>
<td>org.alfresco.repo.node.NodeServicePolicies</td>
<td>beforeAddAspect \</td>
</tr>
<tr>
<td>beforeArchiveNode \</td>
<td></td>
</tr>
<tr>
<td>beforeCreateNode \</td>
<td></td>
</tr>
<tr>
<td>beforeCreateStore \</td>
<td></td>
</tr>
<tr>
<td>beforeDeleteAssociation \</td>
<td></td>
</tr>
<tr>
<td>beforeDeleteChildAssociation \</td>
<td></td>
</tr>
<tr>
<td>beforeDeleteNode \</td>
<td></td>
</tr>
<tr>
<td>beforeMoveNode \</td>
<td></td>
</tr>
<tr>
<td>beforeRemoveAspect \</td>
<td></td>
</tr>
<tr>
<td>beforeSetNodeType \</td>
<td></td>
</tr>
<tr>
<td>beforeUpdateNode \</td>
<td></td>
</tr>
<tr>
<td>onAddAspect \</td>
<td></td>
</tr>
<tr>
<td>onCreateAssociation \</td>
<td></td>
</tr>
<tr>
<td>onCreateChildAssociation \</td>
<td></td>
</tr>
<tr>
<td>onCreateNode \</td>
<td></td>
</tr>
<tr>
<td>onCreateStore \</td>
<td></td>
</tr>
<tr>
<td>onDeleteAssociation \</td>
<td></td>
</tr>
<tr>
<td>onDeleteChildAssociation \</td>
<td></td>
</tr>
<tr>
<td>onDeleteNode \</td>
<td></td>
</tr>
<tr>
<td>onMoveNode \</td>
<td></td>
</tr>
<tr>
<td>onRemoveAspect \</td>
<td></td>
</tr>
<tr>
<td>onSetNodeType \</td>
<td></td>
</tr>
<tr>
<td>onUpdateNode \</td>
<td></td>
</tr>
<tr>
<td>onUpdateProperties</td>
<td></td>
</tr>
<tr>
<td>org.alfresco.repo.version.VersionServicePolicies</td>
<td>beforeCreateVersion \</td>
</tr>
<tr>
<td>afterCreateVersion \</td>
<td></td>
</tr>
<tr>
<td>onCreateVersion \</td>
<td></td>
</tr>
<tr>
<td>calculateVersionLabel</td>
<td></td>
</tr>
</tbody>
</table>
<p>Table: Policies available for behavior binding</p>
<p>The rating behavior needs to recalculate a whitepaper's rating either when a new
rating is created or when a rating is deleted. One possibility would be to bind
the behavior to the <code>NodeService</code> policy's <code>onCreateChildAssociation</code> and
<code>onDeleteChildAssociation</code> policy for the whitepaper node. But that would mean
constantly inspecting the association type to see if the rating needed to be
recalculated because there could be other child associations added to the node
besides ratings. Instead, the rating behavior will bind to the rating node's
<code>onCreateNode</code> and <code>onDeleteNode</code> policies.</p>
<h2 id="java-or-javascript">Java or JavaScript?<a class="headerlink" href="#java-or-javascript" title="Permanent link">&para;</a></h2>
<p>There are two options for writing the code for the behavior: Java or JavaScript.
Which one to use depends on the standards you've settled on for the solution you
are building. This tutorial will implement the ratings example using Java first
and then again in JavaScript so you can see how it is done.</p>
<h1 id="setup">Setup<a class="headerlink" href="#setup" title="Permanent link">&para;</a></h1>
<p>Before getting too far down the road, let me tell you about the tools you'll
need and then give you a description of the project organization.</p>
<h2 id="tools">Tools<a class="headerlink" href="#tools" title="Permanent link">&para;</a></h2>
<p>Here is what I am using on my machine:</p>
<ul>
<li>MacOS 11.4</li>
<li>Java OpenJDK 11.0.2</li>
<li>Apache Maven 3.8.1</li>
<li>Alfresco Maven SDK 4.2 (No download necessary)</li>
<li>Docker 20.10.6</li>
<li>Docker Compose 1.29.1</li>
</ul>
<p>By default, when you create an Alfresco project using the Alfresco Maven
SDK the project will be configured to depend on the latest stable Alfresco
Community Edition build.</p>
<p>An IDE is optional. Most people working with Alfresco use IntelliJ, Eclipse, or
something similar.</p>
<h2 id="project-organization">Project Organization<a class="headerlink" href="#project-organization" title="Permanent link">&para;</a></h2>
<p>I am going to use the Alfresco Maven SDK to create a project using the
"all-in-one" archetype. The project will package up my customizations in two
AMPs (Alfresco Module Packages): One AMP for the "repo" tier and one AMP for the
"share" tier.</p>
<p>I am not going to spend much time talking about how the Alfresco Maven SDK
works. If you aren't already familiar with it, you may want to read the <a href="https://ecmarchitect.com/alfresco-developer-series">Getting
Started with the Alfresco Maven SDK</a>
tutorial on ecmarchitect.com first and then come back to this one.</p>
<p>If you are planning on following along, go ahead and use the Alfresco Maven SDK
to create a new project. Use a <code>groupId</code> of "com.someco" and an <code>artifactId</code> of
"behavior-tutorial".</p>
<p>I'm going to make a couple of quick changes to the generated project.</p>
<p>First, we always want to generate AMP files for our projects. Starting with SDK
3.0.0, the default is to generate JAR files. That's easily fixed by uncommenting
the "maven-assembly-plugin" in the list of plugins in the pom.xml file.</p>
<p>Next, the Java code we are about to write has a compile-time dependency on the
content tutorial repo tier project. To satisfy that, edit the "pom.xml" file in
the behavior-tutorial-platform folder to add the following dependency:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;dependency&gt;</span>
<span class="w">    </span><span class="nt">&lt;groupId&gt;</span>com.someco<span class="nt">&lt;/groupId&gt;</span>
<span class="w">    </span><span class="nt">&lt;artifactId&gt;</span>content-tutorial-platform<span class="nt">&lt;/artifactId&gt;</span>
<span class="w">    </span><span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
<span class="w">    </span><span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div>
<p>Now we're ready to begin.</p>
<h1 id="implementing-and-deploying-the-custom-behavior-in-java">Implementing and deploying the custom behavior in Java<a class="headerlink" href="#implementing-and-deploying-the-custom-behavior-in-java" title="Permanent link">&para;</a></h1>
<p>Let's do the Java example first. Here are the steps:</p>
<ol>
<li>Create a new custom model specifically for ratings. The model will define
    the new rateable aspect and rating type.</li>
<li>Write the custom behavior class and bind it to the appropriate
    policies. Configure a Spring bean to initialize the behavior class and pass
    in any dependencies.</li>
<li>Write and execute an integration test for the behavior.</li>
</ol>
<p>Let's get started.</p>
<h2 id="step-1-create-a-ratings-model">Step 1: Create a ratings model<a class="headerlink" href="#step-1-create-a-ratings-model" title="Permanent link">&para;</a></h2>
<p>In this step you will implement a content model used to persist ratings,
optionally configure the user interface so you can see the average rating and
rating count in Alfresco Share, define a Java class to hold constants for the
model, and write an integration test to test the new aspect.</p>
<h3 id="implement-the-rating-type-and-rateable-aspect">Implement the rating type and rateable aspect<a class="headerlink" href="#implement-the-rating-type-and-rateable-aspect" title="Permanent link">&para;</a></h3>
<p>As you learned in the content types tutorial, models are defined using XML and
the XML file resides in:</p>
<div class="highlight"><pre><span></span><code>$TUTORIAL_HOME/behavior-tutorial-platform/src/main/main/resources/alfresco/module/behavior-tutorial-platform/model
</code></pre></div>
<p>The Alfresco Maven SDK should have created a model directory for you and it may
have populated it with sample content model files. Delete those files as they
are not needed.</p>
<p>Now, create a new model XML file called "<a href="https://github.com/jpotts/alfresco-developer-series/blob/master/behaviors/behavior-tutorial/behavior-tutorial-platform/src/main/resources/alfresco/module/behavior-tutorial-platform/model/scRatingsModel.xml">scRatingsModel.xml</a>"
with the following content:</p>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cm">&lt;!-- Definition of new Model --&gt;</span>
<span class="nt">&lt;model</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;scr:somecoratingsmodel&quot;</span><span class="w"> </span><span class="na">xmlns=</span><span class="s">&quot;http://www.alfresco.org/model/dictionary/1.0&quot;</span><span class="nt">&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- Optional meta-data about the model --&gt;</span>
<span class="w">    </span><span class="nt">&lt;description&gt;</span>Someco<span class="w"> </span>Ratings<span class="w"> </span>Model<span class="nt">&lt;/description&gt;</span>
<span class="w">    </span><span class="nt">&lt;author&gt;</span>Jeff<span class="w"> </span>Potts<span class="nt">&lt;/author&gt;</span>
<span class="w">    </span><span class="nt">&lt;version&gt;</span>1.0<span class="nt">&lt;/version&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- Imports are required to allow references to definitions in other models --&gt;</span>
<span class="w">    </span><span class="nt">&lt;imports&gt;</span>
<span class="w">        </span><span class="cm">&lt;!-- Import Alfresco Dictionary Definitions --&gt;</span>
<span class="w">        </span><span class="nt">&lt;import</span><span class="w"> </span><span class="na">uri=</span><span class="s">&quot;http://www.alfresco.org/model/dictionary/1.0&quot;</span><span class="w"> </span><span class="na">prefix=</span><span class="s">&quot;d&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="cm">&lt;!-- Import Alfresco Content Domain Model Definitions --&gt;</span>
<span class="w">        </span><span class="nt">&lt;import</span><span class="w"> </span><span class="na">uri=</span><span class="s">&quot;http://www.alfresco.org/model/content/1.0&quot;</span><span class="w"> </span><span class="na">prefix=</span><span class="s">&quot;cm&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;import</span><span class="w"> </span><span class="na">uri=</span><span class="s">&quot;http://www.alfresco.org/model/system/1.0&quot;</span><span class="w"> </span><span class="na">prefix=</span><span class="s">&quot;sys&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">      </span><span class="nt">&lt;/imports&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- Introduction of new namespaces defined by this model --&gt;</span>
<span class="w">    </span><span class="nt">&lt;namespaces&gt;</span>
<span class="w">        </span><span class="nt">&lt;namespace</span><span class="w"> </span><span class="na">uri=</span><span class="s">&quot;http://www.someco.com/model/ratings/1.0&quot;</span><span class="w"> </span><span class="na">prefix=</span><span class="s">&quot;scr&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/namespaces&gt;</span>
<span class="nt">&lt;/model&gt;</span>
</code></pre></div>
<p>The model needs a type and an aspect. The chunk of XML below adds the type.
Insert it after the closing <code>namespaces</code> element:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;types&gt;</span>
<span class="w">    </span><span class="nt">&lt;type</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;scr:rating&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;title&gt;</span>Someco<span class="w"> </span>Rating<span class="nt">&lt;/title&gt;</span>
<span class="w">        </span><span class="nt">&lt;parent&gt;</span>sys:base<span class="nt">&lt;/parent&gt;</span>
<span class="w">        </span><span class="nt">&lt;properties&gt;</span>
<span class="w">            </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;scr:rating&quot;</span><span class="nt">&gt;</span>
<span class="w">                </span><span class="nt">&lt;type&gt;</span>d:int<span class="nt">&lt;/type&gt;</span>
<span class="w">                </span><span class="nt">&lt;mandatory&gt;</span>true<span class="nt">&lt;/mandatory&gt;</span>
<span class="w">            </span><span class="nt">&lt;/property&gt;</span>
<span class="w">            </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;scr:rater&quot;</span><span class="nt">&gt;</span>
<span class="w">                </span><span class="nt">&lt;type&gt;</span>d:text<span class="nt">&lt;/type&gt;</span>
<span class="w">                </span><span class="nt">&lt;mandatory&gt;</span>true<span class="nt">&lt;/mandatory&gt;</span>
<span class="w">            </span><span class="nt">&lt;/property&gt;</span>
<span class="w">        </span><span class="nt">&lt;/properties&gt;</span>
<span class="w">    </span><span class="nt">&lt;/type&gt;</span>
<span class="nt">&lt;/types&gt;</span>
</code></pre></div>
<p>Note that <code>scr:rating</code> inherits from <code>sys:base</code>. That's because rating objects
aren't going to store any content, they will only store properties.</p>
<p>Now add the <code>scr:rateable</code> aspect. The <code>aspects</code> element goes after the closing
<code>types</code> element:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;aspects&gt;</span>
<span class="w">    </span><span class="nt">&lt;aspect</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;scr:rateable&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;title&gt;</span>Someco<span class="w"> </span>Rateable<span class="nt">&lt;/title&gt;</span>
<span class="w">        </span><span class="nt">&lt;properties&gt;</span>
<span class="w">            </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;scr:averageRating&quot;</span><span class="nt">&gt;</span>
<span class="w">                </span><span class="nt">&lt;type&gt;</span>d:double<span class="nt">&lt;/type&gt;</span>
<span class="w">                </span><span class="nt">&lt;mandatory&gt;</span>false<span class="nt">&lt;/mandatory&gt;</span>
<span class="w">            </span><span class="nt">&lt;/property&gt;</span>
<span class="w">            </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;scr:totalRating&quot;</span><span class="nt">&gt;</span>
<span class="w">                </span><span class="nt">&lt;type&gt;</span>d:int<span class="nt">&lt;/type&gt;</span>
<span class="w">                </span><span class="nt">&lt;mandatory&gt;</span>false<span class="nt">&lt;/mandatory&gt;</span>
<span class="w">            </span><span class="nt">&lt;/property&gt;</span>
<span class="w">            </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;scr:ratingCount&quot;</span><span class="nt">&gt;</span>
<span class="w">                </span><span class="nt">&lt;type&gt;</span>d:int<span class="nt">&lt;/type&gt;</span>
<span class="w">                </span><span class="nt">&lt;mandatory&gt;</span>false<span class="nt">&lt;/mandatory&gt;</span>
<span class="w">            </span><span class="nt">&lt;/property&gt;</span><span class="w">             </span>
<span class="w">        </span><span class="nt">&lt;/properties&gt;</span>
<span class="w">        </span><span class="nt">&lt;associations&gt;</span>
<span class="w">            </span><span class="nt">&lt;child-association</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;scr:ratings&quot;</span><span class="nt">&gt;</span>
<span class="w">                </span><span class="nt">&lt;title&gt;</span>Rating<span class="nt">&lt;/title&gt;</span>
<span class="w">                </span><span class="nt">&lt;source&gt;</span>
<span class="w">                    </span><span class="nt">&lt;mandatory&gt;</span>false<span class="nt">&lt;/mandatory&gt;</span>
<span class="w">                    </span><span class="nt">&lt;many&gt;</span>true<span class="nt">&lt;/many&gt;</span>
<span class="w">                </span><span class="nt">&lt;/source&gt;</span>
<span class="w">                </span><span class="nt">&lt;target&gt;</span>
<span class="w">                    </span><span class="nt">&lt;class&gt;</span>scr:rating<span class="nt">&lt;/class&gt;</span>
<span class="w">                    </span><span class="nt">&lt;mandatory&gt;</span>false<span class="nt">&lt;/mandatory&gt;</span>
<span class="w">                    </span><span class="nt">&lt;many&gt;</span>true<span class="nt">&lt;/many&gt;</span>
<span class="w">                </span><span class="nt">&lt;/target&gt;</span>
<span class="w">            </span><span class="nt">&lt;/child-association&gt;</span>
<span class="w">        </span><span class="nt">&lt;/associations&gt;</span>
<span class="w">    </span><span class="nt">&lt;/aspect&gt;</span>
<span class="nt">&lt;/aspects&gt;</span>
</code></pre></div>
<p>The <code>scr:rateable</code> aspect has three properties used to store the average rating,
total rating, and rating count. It also defines the child association between a
piece of content and its ratings.</p>
<p>Using an aspect means any piece of content in the repository can become
"rateable" simply by adding the aspect to the object. SomeCo may start out using
ratings only for whitepapers and then decide later to use them for other types
of content. If so, it won't require any code changes. That's the beauty of
aspects.</p>
<p>Alfresco needs to know about the new model. Models are registered through Spring.
There are multiple Spring context files. It doesn't really matter which one you
use to wire in your models. Newer versions of the SDK use the
bootstrap-context.xml file, so let's use that. is called <a href="https://github.com/jpotts/alfresco-developer-series/blob/master/behaviors/behavior-tutorial/behavior-tutorial-platform/src/main/resources/alfresco/module/behavior-tutorial-platform/context/bootstrap-context.xml">service-context.xml</a>
and it lives in:</p>
<div class="highlight"><pre><span></span><code>$TUTORIAL_HOME/behavior-tutorial-platform/src/main/resources/alfresco/module/behavior-tutorial-platform/context
</code></pre></div>
<p>The context file may already exist and probably contains sample Spring beans
used to wire in sample models and labels. Replace whatever is there with the
bean below. It refers to the model XML file created earlier as well as a
properties file that doesn't exist yet:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;${project.artifactId}_dictionaryBootstrap&quot;</span><span class="w"> </span><span class="na">parent=</span><span class="s">&quot;dictionaryModelBootstrap&quot;</span><span class="w"> </span><span class="na">depends-on=</span><span class="s">&quot;dictionaryBootstrap&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;models&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;list&gt;</span><span class="w">                </span>
<span class="w">            </span><span class="nt">&lt;value&gt;</span>alfresco/module/${project.artifactId}/model/scRatingsModel.xml<span class="nt">&lt;/value&gt;</span><span class="w">                </span>
<span class="w">        </span><span class="nt">&lt;/list&gt;</span>
<span class="w">    </span><span class="nt">&lt;/property&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;labels&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;list&gt;</span>
<span class="w">            </span><span class="nt">&lt;value&gt;</span>alfresco/module/${project.artifactId}/messages/scRatingsModel<span class="nt">&lt;/value&gt;</span>
<span class="w">        </span><span class="nt">&lt;/list&gt;</span><span class="w">        </span>
<span class="w">    </span><span class="nt">&lt;/property&gt;</span><span class="w">        </span>
<span class="nt">&lt;/bean&gt;</span>
</code></pre></div>
<p>With that, the model is set up and ready to go.</p>
<h3 id="optionally-configure-the-user-interface">Optionally configure the user interface<a class="headerlink" href="#optionally-configure-the-user-interface" title="Permanent link">&para;</a></h3>
<p>Behaviors operate behind the scenes. So, really, there is no reason to configure
the user interface at all. But I like to do it because it makes it easier to
debug. And, SomeCo might want to use Alfresco Share to see the average rating
and rating count for a piece of content that has the rateable aspect.</p>
<p>In the previous step you added a Spring bean that referred to a properties
bundle used for the labels associated with the model. The labels go in a file
called <a href="https://github.com/jpotts/alfresco-developer-series/blob/master/behaviors/behavior-tutorial/behavior-tutorial-platform/src/main/resources/alfresco/module/behavior-tutorial-platform/messages/scRatingsModel.properties">scRatingsModel.properties</a>.
That file lives in:</p>
<div class="highlight"><pre><span></span><code>$TUTORIAL_HOME/behavior-tutorial-platform/src/main/resources/alfresco/module/behavior-tutorial-platform/messages
</code></pre></div>
<p>The content of that file looks like this:</p>
<div class="highlight"><pre><span></span><code>#scr:rating
scr_somecoratingsmodel.type.scr_rating.title=Rating
scr_somecoratingsmodel.property.scr_rating.title=Rating
scr_somecoratingsmodel.property.scr_rater.title=Rater

#scr:rateable
scr_somecoratingsmodel.aspect.scr_rateable.title=SomeCo Rateable
scr_somecoratingsmodel.property.scr_averageRating=Average Rating
scr_somecoratingsmodel.association.scr_ratings.title=Ratings
</code></pre></div>
<p>You can delete the example properties file that may already be in the messages
directory.</p>
<p>That's all that's needed in the behavior-tutorial-platform project. The rest
of the user interface configuration takes place in the
behavior-tutorial-share project.</p>
<p>Because these steps have already been covered in the custom content types
tutorial, I'll just list the files here and you can either copy them into your
project or do without them:</p>
<ul>
<li>$TUTORIAL_HOME/behavior-tutorial-share/src/main/resources/META-INF/<a href="https://github.com/jpotts/alfresco-developer-series/blob/master/behaviors/behavior-tutorial/behavior-tutorial-share/src/main/resources/META-INF/share-config-custom.xml">share-config-custom.xml</a>.
The configuration in this file adds the rateable aspect to the list of aspects
users can manage. It also defines which properties should be displayed when
showing the property list for a piece of content with the rateable aspect
applied.</li>
<li>$TUTORIAL_HOME/behavior-tutorial-share/src/main/resources/alfresco/web-extension/<a href="https://github.com/jpotts/alfresco-developer-series/blob/master/behaviors/behavior-tutorial/behavior-tutorial-share/src/main/resources/alfresco/web-extension/behavior-tutorial-share-context.xml">behavior-tutorial-share-context.xml</a>.
This is the Spring context file that tells Alfresco Share where to find the
properties bundle.</li>
<li>$TUTORIAL_HOME/behavior-tutorial-share/src/main/resources/alfresco/web-extension/messages/<a href="https://github.com/jpotts/alfresco-developer-series/blob/master/behaviors/behavior-tutorial/behavior-tutorial-share/src/main/resources/alfresco/web-extension/messages/scRatingsModel.properties">scRatingsModel.properties</a>.
This is the properties bundle for the module that Alfresco Share will use to
localize the labels.</li>
</ul>
<p>Now the Alfresco Share user interface will know how to show values for the
average rating and rating count when a piece of content with the rateable
aspect is displayed.</p>
<h3 id="define-a-java-class-to-hold-constants">Define a Java class to hold constants<a class="headerlink" href="#define-a-java-class-to-hold-constants" title="Permanent link">&para;</a></h3>
<p>It is often convenient to put model-related constants in a class. In this case,
that class is called SomeCoRatingsModel and it looks like this:</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">SomeCoRatingsModel</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="c1">// Namespaces</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">NAMESPACE_SOMECO_RATINGS_CONTENT_MODEL</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;http://www.someco.com/model/ratings/1.0&quot;</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Types</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">TYPE_SCR_RATING</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;rating&quot;</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Aspects</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">ASPECT_SCR_RATEABLE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;rateable&quot;</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Properties</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">PROP_RATING</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;rating&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">PROP_RATER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;rater&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">PROP_AVERAGE_RATING</span><span class="o">=</span><span class="w"> </span><span class="s">&quot;averageRating&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">PROP_TOTAL_RATING</span><span class="o">=</span><span class="w"> </span><span class="s">&quot;totalRating&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">PROP_RATING_COUNT</span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ratingCount&quot;</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Associations</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">ASSN_SCR_RATINGS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ratings&quot;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>These are just constants that will be used by the behavior class and other
classes in other tutorials when they need to refer to the rating type, rateable
aspect, or any of the properties by name.</p>
<h3 id="write-integration-tests">Write integration tests<a class="headerlink" href="#write-integration-tests" title="Permanent link">&para;</a></h3>
<p>The old 3.0.1 version of the Alfresco Maven SDK will automatically run
integration tests when <code>mvn install</code> runs. In SDK 4.0 and higher you must first
start up the Docker containers, then run <code>./run.sh test</code>.</p>
<p>If you're a TDD (Test-Driven Development) kind of person you could add a test
for the to-be-developed behavior. For now, I'll just create a test to make sure
I can successfully add the <code>scr:rateable</code> aspect to a piece of content. The
rating type will get tested shortly.</p>
<p>The test class goes in:</p>
<div class="highlight"><pre><span></span><code>$TUTORIAL_HOME/behavior-tutorial-integration-tests/src/test/java/com/someco/test
</code></pre></div>
<p>Here is the <a href="https://github.com/jpotts/alfresco-developer-series/blob/master/behaviors/behavior-tutorial/behavior-tutorial-integration-tests/src/test/java/com/someco/test/SomecoRatingModelIT.java">SomecoRatingModelIT</a>
test class:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@RunWith</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AlfrescoTestRunner</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SomecoRatingModelIT</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">BaseIT</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">testRateableAspect</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">AVG_RATING</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">RATING_COUNT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">TOTAL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">        </span><span class="n">NodeService</span><span class="w"> </span><span class="n">nodeService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getServiceRegistry</span><span class="p">().</span><span class="na">getNodeService</span><span class="p">();</span>

<span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">QName</span><span class="p">,</span><span class="w"> </span><span class="n">Serializable</span><span class="o">&gt;</span><span class="w"> </span><span class="n">nodeProperties</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">nodeRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createNode</span><span class="p">(</span><span class="n">getFilename</span><span class="p">(),</span><span class="w"> </span><span class="n">ContentModel</span><span class="p">.</span><span class="na">TYPE_CONTENT</span><span class="p">,</span><span class="w"> </span><span class="n">nodeProperties</span><span class="p">);</span>

<span class="w">        </span><span class="n">QName</span><span class="w"> </span><span class="n">aspectQName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createQName</span><span class="p">(</span><span class="n">SomeCoRatingsModel</span><span class="p">.</span><span class="na">NAMESPACE_SOMECO_RATINGS_CONTENT_MODEL</span><span class="p">,</span><span class="w"> </span><span class="n">SomeCoRatingsModel</span><span class="p">.</span><span class="na">ASPECT_SCR_RATEABLE</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// set up some aspect-based properties</span>
<span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">QName</span><span class="p">,</span><span class="w"> </span><span class="n">Serializable</span><span class="o">&gt;</span><span class="w"> </span><span class="n">aspectProps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">QName</span><span class="p">,</span><span class="w"> </span><span class="n">Serializable</span><span class="o">&gt;</span><span class="p">();</span>

<span class="w">        </span><span class="n">aspectProps</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">PROP_AVG_RATING_QNAME</span><span class="p">,</span><span class="w"> </span><span class="n">AVG_RATING</span><span class="p">);</span>
<span class="w">        </span><span class="n">aspectProps</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">PROP_TOTAL_QNAME</span><span class="p">,</span><span class="w"> </span><span class="n">TOTAL</span><span class="p">);</span>
<span class="w">        </span><span class="n">aspectProps</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">PROP_COUNT_QNAME</span><span class="p">,</span><span class="w"> </span><span class="n">RATING_COUNT</span><span class="p">);</span>

<span class="w">        </span><span class="n">nodeService</span><span class="p">.</span><span class="na">addAspect</span><span class="p">(</span><span class="n">nodeRef</span><span class="p">,</span><span class="w"> </span><span class="n">aspectQName</span><span class="p">,</span><span class="w"> </span><span class="n">aspectProps</span><span class="p">);</span>

<span class="w">        </span><span class="n">assertEquals</span><span class="p">(</span><span class="n">AVG_RATING</span><span class="p">,</span><span class="w"> </span><span class="n">nodeService</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">nodeRef</span><span class="p">,</span><span class="w"> </span><span class="n">PROP_AVG_RATING_QNAME</span><span class="p">));</span>
<span class="w">        </span><span class="n">assertEquals</span><span class="p">(</span><span class="n">TOTAL</span><span class="p">,</span><span class="w"> </span><span class="n">nodeService</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">nodeRef</span><span class="p">,</span><span class="w"> </span><span class="n">PROP_TOTAL_QNAME</span><span class="p">));</span>
<span class="w">        </span><span class="n">assertEquals</span><span class="p">(</span><span class="n">RATING_COUNT</span><span class="p">,</span><span class="w"> </span><span class="n">nodeService</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">nodeRef</span><span class="p">,</span><span class="w"> </span><span class="n">PROP_COUNT_QNAME</span><span class="p">));</span>

<span class="w">        </span><span class="n">assertTrue</span><span class="p">(</span><span class="s">&quot;Missing aspect&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">getServiceRegistry</span><span class="p">().</span><span class="na">getNodeService</span><span class="p">().</span><span class="na">hasAspect</span><span class="p">(</span><span class="n">nodeRef</span><span class="p">,</span><span class="w"> </span><span class="n">aspectQName</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>The test creates a new content node in Company Home and then adds the
<code>scr:rateable</code> aspect to it, simultaneously setting the aspect-based properties
to test values. It then makes sure it can get those same test values back.</p>
<p>To run the test, first start the Docker containers by running <code>./run.sh build_start_it_supported</code>.
Once everything comes up, run <code>./run.sh test</code>.</p>
<p>Assuming everything went okay, you now have your model in place and tested and
you are ready to write the behavior.</p>
<h2 id="step-2-implement-the-custom-behavior">Step 2: Implement the custom behavior<a class="headerlink" href="#step-2-implement-the-custom-behavior" title="Permanent link">&para;</a></h2>
<p>Implementing the behavior involves writing some Java, configuring a Spring Bean,
and adding an integration test for the behavior.</p>
<h3 id="write-the-behavior-class">Write the behavior class<a class="headerlink" href="#write-the-behavior-class" title="Permanent link">&para;</a></h3>
<p>The custom behavior is implemented as a Java class called <a href="https://github.com/jpotts/alfresco-developer-series/blob/master/behaviors/behavior-tutorial/behavior-tutorial-platform/src/main/java/com/someco/behavior/Rating.java">Rating</a>.
The class implements the interfaces that correspond to the policies the behavior
needs to bind to. In this example, the two policy interfaces are:
<code>NodeServicePolicies.OnDeleteNodePolicy</code> and
<code>NodeServicePolicies.OnCreateNodePolicy</code> so the class declaration is:</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Rating</span>
<span class="kd">implements</span><span class="w"> </span><span class="n">NodeServicePolicies</span><span class="p">.</span><span class="na">OnDeleteNodePolicy</span><span class="p">,</span>
<span class="n">NodeServicePolicies</span><span class="p">.</span><span class="na">OnCreateNodePolicy</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// SNIP</span>
<span class="p">}</span>
</code></pre></div>
<p>The class has two dependencies that Spring will handle for us. One is the
<code>NodeService</code> which will be used in the average calculation logic and the other
is the <code>PolicyComponent</code> which is used to bind the behavior to the policies.</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Dependencies</span>
<span class="kd">private</span><span class="w"> </span><span class="n">NodeService</span><span class="w"> </span><span class="n">nodeService</span><span class="p">;</span>
<span class="kd">private</span><span class="w"> </span><span class="n">PolicyComponent</span><span class="w"> </span><span class="n">policyComponent</span><span class="p">;</span>

<span class="c1">// Behaviours</span>
<span class="kd">private</span><span class="w"> </span><span class="n">Behaviour</span><span class="w"> </span><span class="n">onCreateNode</span><span class="p">;</span>
<span class="kd">private</span><span class="w"> </span><span class="n">Behaviour</span><span class="w"> </span><span class="n">onDeleteNode</span><span class="p">;</span>
</code></pre></div>
<p>At some point Alfresco has to know that the behavior needs to be bound to a
policy. A method called <code>init()</code> will handle the binding. It will get called
when Spring loads the bean.</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="c1">// Create behaviours</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">onCreateNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JavaBehaviour</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;onCreateNode&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">NotificationFrequency</span><span class="p">.</span><span class="na">EVERY_EVENT</span><span class="p">);</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">onDeleteNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JavaBehaviour</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;onDeleteNode&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">NotificationFrequency</span><span class="p">.</span><span class="na">EVERY_EVENT</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Bind behaviours to node policies</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">policyComponent</span><span class="p">.</span><span class="na">bindClassBehaviour</span><span class="p">(</span>
<span class="w">        </span><span class="n">Qname</span><span class="p">.</span><span class="na">createQName</span><span class="p">(</span><span class="n">NamespaceService</span><span class="p">.</span><span class="na">ALFRESCO_URI</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;onCreateNode&quot;</span><span class="p">),</span>
<span class="w">        </span><span class="n">Qname</span><span class="p">.</span><span class="na">createQName</span><span class="p">(</span><span class="n">SomeCoModel</span><span class="p">.</span><span class="na">NAMESPACE_SOMECO_CONTENT_MODEL</span><span class="p">,</span><span class="w"> </span><span class="n">SomeCoModel</span><span class="p">.</span><span class="na">TYPE_SC_RATING</span><span class="p">),</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">onCreateNode</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">policyComponent</span><span class="p">.</span><span class="na">bindClassBehaviour</span><span class="p">(</span>
<span class="w">        </span><span class="n">QName</span><span class="p">.</span><span class="na">createQName</span><span class="p">(</span><span class="n">NamespaceService</span><span class="p">.</span><span class="na">ALFRESCO_URI</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;onDeleteNode&quot;</span><span class="p">),</span>
<span class="w">        </span><span class="n">Qname</span><span class="p">.</span><span class="na">createQName</span><span class="p">(</span><span class="n">SomeCoModel</span><span class="p">.</span><span class="na">NAMESPACE_SOMECO_CONTENT_MODEL</span><span class="p">,</span><span class="w"> </span><span class="n">SomeCoModel</span><span class="p">.</span><span class="na">TYPE_SC_RATING</span><span class="p">),</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">onDeleteNode</span>
<span class="w">    </span><span class="p">);</span>

<span class="p">}</span>
</code></pre></div>
<p>The first thing to notice here is that you can decide when the behavior should
be invoked by specifying the appropriate <code>NotificationFrequency</code>. Besides
<code>EVERY_EVENT</code>, other choices include <code>FIRST_EVENT</code> and <code>TRANSACTION_COMMIT</code>. I
chose <code>EVERY_EVENT</code> here because there are times when I might want the behavior
to trigger before the transaction is actually committed. It doesn't matter to me
that the average will be re-computed potentially multiple times because I don't
anticipate there to be a lot of ratings. You'll need to think about your case
and choose what works for your requirements.</p>
<p>Also note that there are a few different overloaded methods for
<code>bindClassBehaviour</code>. In this case the code binds the Qname of a behavior to the
Qname of our type (“Rating”) and tells Alfresco to call the <code>onCreateNode</code> and
<code>onDeleteNode</code> behaviors that will be defined in this class.</p>
<p>There are also additional bind methods for associations
(<code>bindAssociationBehaviour</code>) and properties (<code>bindPropertyBehaviour</code>) that
you should use depending on the type of policy you are binding to.</p>
<p>Next are the methods required by the two policy interfaces. Regardless of
whether a ratings node is created or deleted, the average needs to be
recalculated. So the <code>onCreateNode</code> and <code>onDeleteNode</code> methods call
<code>computeAverage</code> and pass in the rating node reference.</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onCreateNode</span><span class="p">(</span><span class="n">ChildAssociationRef</span><span class="w"> </span><span class="n">childAssocRef</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="n">computeAverage</span><span class="p">(</span><span class="n">childAssocRef</span><span class="p">);</span>

<span class="p">}</span>

<span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onDeleteNode</span><span class="p">(</span><span class="n">ChildAssociationRef</span><span class="w"> </span><span class="n">childAssocRef</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isNodeArchived</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="n">computeAverage</span><span class="p">(</span><span class="n">childAssocRef</span><span class="p">);</span>

<span class="p">}</span>
</code></pre></div>
<p>The <code>computeAverage</code> method asks the child (the rating object) for its parent
node reference (the rateable object) and asks the parent for a list of its
children. It iterates over the children, computes an average, and sets the
average property on the content.</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">computeAverage</span><span class="p">(</span><span class="n">ChildAssociationRef</span><span class="w"> </span><span class="n">childAssocRef</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="c1">// get the parent node</span>
<span class="w">    </span><span class="n">NodeRef</span><span class="w"> </span><span class="n">parentRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">childAssocRef</span><span class="p">.</span><span class="na">getParentRef</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// check the parent to make sure it has the right aspect</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nodeService</span><span class="p">.</span><span class="na">exists</span><span class="p">(</span><span class="n">parentRef</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">nodeService</span><span class="p">.</span><span class="na">hasAspect</span><span class="p">(</span><span class="n">parentRef</span><span class="p">,</span><span class="w"> </span><span class="n">Qname</span><span class="p">.</span><span class="na">createQName</span><span class="p">(</span><span class="n">SomeCoModel</span><span class="p">.</span><span class="na">NAMESPACE_SOMECO_CONTENT_MODEL</span><span class="p">,</span><span class="w"> </span><span class="n">SomeCoModel</span><span class="p">.</span><span class="na">ASPECT_SC_RATEABLE</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="c1">// continue, this is what we want</span>

<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// get the parent node&#39;s children</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">ChildAssociationRef</span><span class="o">&gt;</span><span class="w"> </span><span class="n">children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodeService</span><span class="p">.</span><span class="na">getChildAssocs</span><span class="p">(</span><span class="n">parentRef</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// iterate through the children to compute the total</span>
<span class="w">    </span><span class="n">Double</span><span class="w"> </span><span class="n">average</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0d</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">total</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ChildAssociationRef</span><span class="w"> </span><span class="n">child</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">children</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">rating</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span><span class="n">nodeService</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span>
<span class="w">        </span><span class="n">child</span><span class="p">.</span><span class="na">getChildRef</span><span class="p">(),</span>
<span class="w">        </span><span class="n">Qname</span><span class="p">.</span><span class="na">createQName</span><span class="p">(</span><span class="n">SomeCoModel</span><span class="p">.</span><span class="na">NAMESPACE_SOMECO_CONTENT_MODEL</span><span class="p">,</span><span class="w"> </span><span class="n">SomeCoModel</span><span class="p">.</span><span class="na">PROP_RATING</span><span class="p">));</span>
<span class="w">        </span><span class="n">total</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">rating</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// compute the average</span>
<span class="w">    </span><span class="n">average</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">total</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">children</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1.0d</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// store the average, total, count on the parent node</span>
<span class="w">    </span><span class="n">nodeService</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span>
<span class="w">        </span><span class="n">parentRef</span><span class="p">,</span>
<span class="w">        </span><span class="n">QName</span><span class="p">.</span><span class="na">createQName</span><span class="p">(</span>
<span class="w">            </span><span class="n">SomeCoRatingsModel</span><span class="p">.</span><span class="na">NAMESPACE_SOMECO_RATINGS_CONTENT_MODEL</span><span class="p">,</span>
<span class="w">            </span><span class="n">SomeCoRatingsModel</span><span class="p">.</span><span class="na">PROP_AVERAGE_RATING</span><span class="p">),</span>
<span class="w">        </span><span class="n">average</span><span class="p">);</span>

<span class="w">    </span><span class="n">nodeService</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span>
<span class="w">        </span><span class="n">parentRef</span><span class="p">,</span>
<span class="w">        </span><span class="n">QName</span><span class="p">.</span><span class="na">createQName</span><span class="p">(</span>
<span class="w">            </span><span class="n">SomeCoRatingsModel</span><span class="p">.</span><span class="na">NAMESPACE_SOMECO_RATINGS_CONTENT_MODEL</span><span class="p">,</span>
<span class="w">            </span><span class="n">SomeCoRatingsModel</span><span class="p">.</span><span class="na">PROP_TOTAL_RATING</span><span class="p">),</span>
<span class="w">        </span><span class="n">total</span><span class="p">);</span>

<span class="w">    </span><span class="n">nodeService</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span>
<span class="w">        </span><span class="n">parentRef</span><span class="p">,</span>
<span class="w">        </span><span class="n">QName</span><span class="p">.</span><span class="na">createQName</span><span class="p">(</span>
<span class="w">            </span><span class="n">SomeCoRatingsModel</span><span class="p">.</span><span class="na">NAMESPACE_SOMECO_RATINGS_CONTENT_MODEL</span><span class="p">,</span>
<span class="w">            </span><span class="n">SomeCoRatingsModel</span><span class="p">.</span><span class="na">PROP_RATING_COUNT</span><span class="p">),</span>
<span class="w">        </span><span class="n">count</span><span class="p">);</span><span class="w">     </span>

<span class="w">    </span><span class="k">return</span><span class="p">;</span>

<span class="p">}</span>
</code></pre></div>
<p>The class stores the total rating and rating count, so it could actually compute
the average without iterating over the rating objects. All it really needs to
know is the value of the new rating. For this example we'll only have a handful
of associations anyway but in the real world, you need to think carefully about
such performance considerations when you write your behaviors.</p>
<h3 id="configure-a-spring-bean">Configure a Spring bean<a class="headerlink" href="#configure-a-spring-bean" title="Permanent link">&para;</a></h3>
<p>The last step before testing is to configure the behavior class as a Spring
bean. The bean config goes in <a href="https://github.com/jpotts/alfresco-developer-series/blob/master/behaviors/behavior-tutorial/behavior-tutorial-platform/src/main/resources/alfresco/module/behavior-tutorial-platform/context/service-context.xml">service-context.xml</a>,
which, as a reminder, lives in:</p>
<div class="highlight"><pre><span></span><code>$TUTORIAL_HOME/behavior-tutorial-platform/src/main/resources/alfresco/module/behavior-tutorial-platform/context
</code></pre></div>
<p>You can delete any demo or sample beans that may already be in this file.</p>
<p>Add the following before the closing <code>beans</code> element:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;ratingBehavior&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;com.someco.behavior.Rating&quot;</span>
<span class="na">init-method=</span><span class="s">&quot;init&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;nodeService&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;ref</span><span class="w"> </span><span class="na">bean=</span><span class="s">&quot;NodeService&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/property&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;policyComponent&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;ref</span><span class="w"> </span><span class="na">bean=</span><span class="s">&quot;policyComponent&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</code></pre></div>
<p>This bean declares the <code>init</code> method and injects the dependencies the behavior
needs.</p>
<h2 id="step-3-create-an-integration-test-for-the-behavior">Step 3: Create an integration test for the behavior<a class="headerlink" href="#step-3-create-an-integration-test-for-the-behavior" title="Permanent link">&para;</a></h2>
<p>The behavior should be able to calculate the average rating when rating objects
are created or deleted from any piece of content that has the <code>scr:rateable</code>
aspect. It's easy to test that with an integration test.</p>
<p>I'll add a class called <a href="https://github.com/jpotts/alfresco-developer-series/blob/master/behaviors/behavior-tutorial/behavior-tutorial-integration-tests/src/test/java/com/someco/test/RatingBehaviorIT.java">RatingBehaviorIT</a>
to the same test package that <code>SomecoRatingModelIT</code> is in. The test will:</p>
<ol>
<li>Create a piece of content and add the <code>scr:rateable</code> aspect to it.</li>
<li>Add three test ratings, checking the values for the average rating, total
rating and rating count.</li>
<li>Delete one of the test ratings, checking the values again to make sure the
delete was handled appropriately.</li>
</ol>
<p>Here's the code:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@RunWith</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AlfrescoTestRunner</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RatingBehaviorIT</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">BaseIT</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="n">Logger</span><span class="w"> </span><span class="n">log</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Logger</span><span class="p">.</span><span class="na">getLogger</span><span class="p">(</span><span class="n">RatingBehaviorIT</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">ratingTypeTest</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">RATER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;jpotts&quot;</span><span class="p">;</span>

<span class="w">        </span><span class="n">NodeService</span><span class="w"> </span><span class="n">nodeService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getServiceRegistry</span><span class="p">().</span><span class="na">getNodeService</span><span class="p">();</span>

<span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">QName</span><span class="p">,</span><span class="w"> </span><span class="n">Serializable</span><span class="o">&gt;</span><span class="w"> </span><span class="n">nodeProperties</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">nodeRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createNode</span><span class="p">(</span><span class="n">getFilename</span><span class="p">(),</span><span class="w"> </span><span class="n">ContentModel</span><span class="p">.</span><span class="na">TYPE_CONTENT</span><span class="p">,</span><span class="w"> </span><span class="n">nodeProperties</span><span class="p">);</span>

<span class="w">        </span><span class="n">QName</span><span class="w"> </span><span class="n">aspectQName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createQName</span><span class="p">(</span><span class="n">SomeCoRatingsModel</span><span class="p">.</span><span class="na">NAMESPACE_SOMECO_RATINGS_CONTENT_MODEL</span><span class="p">,</span><span class="w"> </span><span class="n">SomeCoRatingsModel</span><span class="p">.</span><span class="na">ASPECT_SCR_RATEABLE</span><span class="p">);</span>
<span class="w">        </span><span class="n">nodeService</span><span class="p">.</span><span class="na">addAspect</span><span class="p">(</span><span class="n">nodeRef</span><span class="p">,</span><span class="w"> </span><span class="n">aspectQName</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>

<span class="w">        </span><span class="n">createRating</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">nodeRef</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">RATER</span><span class="p">);</span>

<span class="w">        </span><span class="n">assertEquals</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="n">nodeService</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">nodeRef</span><span class="p">,</span><span class="w"> </span><span class="n">PROP_AVG_RATING_QNAME</span><span class="p">));</span>
<span class="w">        </span><span class="n">assertEquals</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nodeService</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">nodeRef</span><span class="p">,</span><span class="w"> </span><span class="n">PROP_TOTAL_QNAME</span><span class="p">));</span>
<span class="w">        </span><span class="n">assertEquals</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nodeService</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">nodeRef</span><span class="p">,</span><span class="w"> </span><span class="n">PROP_COUNT_QNAME</span><span class="p">));</span>

<span class="w">        </span><span class="n">NodeRef</span><span class="w"> </span><span class="n">rating2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createRating</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">nodeRef</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">RATER</span><span class="p">);</span>

<span class="w">        </span><span class="n">assertEquals</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span><span class="w"> </span><span class="n">nodeService</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">nodeRef</span><span class="p">,</span><span class="w"> </span><span class="n">PROP_AVG_RATING_QNAME</span><span class="p">));</span>
<span class="w">        </span><span class="n">assertEquals</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">nodeService</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">nodeRef</span><span class="p">,</span><span class="w"> </span><span class="n">PROP_TOTAL_QNAME</span><span class="p">));</span>
<span class="w">        </span><span class="n">assertEquals</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">nodeService</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">nodeRef</span><span class="p">,</span><span class="w"> </span><span class="n">PROP_COUNT_QNAME</span><span class="p">));</span>

<span class="w">        </span><span class="n">createRating</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">nodeRef</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">RATER</span><span class="p">);</span>

<span class="w">        </span><span class="n">assertEquals</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span><span class="w"> </span><span class="n">nodeService</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">nodeRef</span><span class="p">,</span><span class="w"> </span><span class="n">PROP_AVG_RATING_QNAME</span><span class="p">));</span>
<span class="w">        </span><span class="n">assertEquals</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="n">nodeService</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">nodeRef</span><span class="p">,</span><span class="w"> </span><span class="n">PROP_TOTAL_QNAME</span><span class="p">));</span>
<span class="w">        </span><span class="n">assertEquals</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">nodeService</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">nodeRef</span><span class="p">,</span><span class="w"> </span><span class="n">PROP_COUNT_QNAME</span><span class="p">));</span>

<span class="w">        </span><span class="n">nodeService</span><span class="p">.</span><span class="na">deleteNode</span><span class="p">(</span><span class="n">rating2</span><span class="p">);</span>

<span class="w">        </span><span class="n">assertEquals</span><span class="p">(</span><span class="n">nodeService</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">nodeRef</span><span class="p">,</span><span class="w"> </span><span class="n">PROP_AVG_RATING_QNAME</span><span class="p">),</span><span class="w"> </span><span class="mf">2.0</span><span class="p">);</span>
<span class="w">        </span><span class="n">assertEquals</span><span class="p">(</span><span class="n">nodeService</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">nodeRef</span><span class="p">,</span><span class="w"> </span><span class="n">PROP_TOTAL_QNAME</span><span class="p">),</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span>
<span class="w">        </span><span class="n">assertEquals</span><span class="p">(</span><span class="n">nodeService</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">nodeRef</span><span class="p">,</span><span class="w"> </span><span class="n">PROP_COUNT_QNAME</span><span class="p">),</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">NodeRef</span><span class="w"> </span><span class="nf">createRating</span><span class="p">(</span><span class="n">NodeRef</span><span class="w"> </span><span class="n">nodeRef</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">rating</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">rater</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">NodeService</span><span class="w"> </span><span class="n">nodeService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getServiceRegistry</span><span class="p">().</span><span class="na">getNodeService</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// assign name</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Rating (&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">QName</span><span class="p">,</span><span class="w"> </span><span class="n">Serializable</span><span class="o">&gt;</span><span class="w"> </span><span class="n">contentProps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">QName</span><span class="p">,</span><span class="w"> </span><span class="n">Serializable</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">        </span><span class="n">contentProps</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">ContentModel</span><span class="p">.</span><span class="na">PROP_NAME</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span>
<span class="w">        </span><span class="n">contentProps</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">PROP_RATING_QNAME</span><span class="p">,</span><span class="w"> </span><span class="n">rating</span><span class="p">);</span>
<span class="w">        </span><span class="n">contentProps</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">PROP_RATER_QNAME</span><span class="p">,</span><span class="w"> </span><span class="n">rater</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// create rating as a child of the content node using the scr:ratings child association</span>
<span class="w">        </span><span class="n">ChildAssociationRef</span><span class="w"> </span><span class="n">association</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodeService</span><span class="p">.</span><span class="na">createNode</span><span class="p">(</span>
<span class="w">                        </span><span class="n">nodeRef</span><span class="p">,</span>
<span class="w">                        </span><span class="n">QName</span><span class="p">.</span><span class="na">createQName</span><span class="p">(</span>
<span class="w">                                </span><span class="n">SomeCoRatingsModel</span><span class="p">.</span><span class="na">NAMESPACE_SOMECO_RATINGS_CONTENT_MODEL</span><span class="p">,</span>
<span class="w">                                </span><span class="n">SomeCoRatingsModel</span><span class="p">.</span><span class="na">ASSN_SCR_RATINGS</span><span class="p">),</span>
<span class="w">                        </span><span class="n">QName</span><span class="p">.</span><span class="na">createQName</span><span class="p">(</span><span class="n">NamespaceService</span><span class="p">.</span><span class="na">CONTENT_MODEL_PREFIX</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">),</span>
<span class="w">                        </span><span class="n">QName</span><span class="p">.</span><span class="na">createQName</span><span class="p">(</span>
<span class="w">                                </span><span class="n">SomeCoRatingsModel</span><span class="p">.</span><span class="na">NAMESPACE_SOMECO_RATINGS_CONTENT_MODEL</span><span class="p">,</span>
<span class="w">                                </span><span class="n">SomeCoRatingsModel</span><span class="p">.</span><span class="na">TYPE_SCR_RATING</span><span class="p">),</span>
<span class="w">                        </span><span class="n">contentProps</span>
<span class="w">                        </span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">association</span><span class="p">.</span><span class="na">getChildRef</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>To run the test, first, check to see if your containers are running by doing a
<code>docker ps</code>. If any are running, do <code>./run.sh stop</code>. Next, run <code>mvn install -DskipTests</code>
to re-build everything. Now start fresh containers by doing <code>./run.sh build_start_it_supported</code>.</p>
<p>Once everything is up-and-running, run <code>./run.sh test</code>. If you see something
like this:</p>
<div class="highlight"><pre><span></span><code>[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 4.554 s
[INFO] Finished at: 2019-02-11T16:19:16-06:00
[INFO] Final Memory: 32M/489M
[INFO] ------------------------------------------------------------------------
</code></pre></div>
<p>...it means your behavior is working.</p>
<p>If something is broken, try changing <a href="https://github.com/jpotts/alfresco-developer-series/blob/master/behaviors/behavior-tutorial/behavior-tutorial-platform/src/main/resources/alfresco/module/behavior-tutorial-platform/log4j.properties">log4j.properties</a>
in:</p>
<div class="highlight"><pre><span></span><code>$TUTORIAL_HOME/behavior-tutorial-platform/src/main/resources/alfresco/module
</code></pre></div>
<p>To:</p>
<div class="highlight"><pre><span></span><code>log4j.logger.com.someco=DEBUG
</code></pre></div>
<p>And then re-build the AMPs by running <code>mvn install -DskipTests</code>. Once the build
is complete, stop and start the Alfresco container by doing <code>./run.sh reload_acs</code>.
You can then look for the debug messages in the log.</p>
<h1 id="re-implementing-the-behavior-in-javascript">Re-implementing the behavior in JavaScript<a class="headerlink" href="#re-implementing-the-behavior-in-javascript" title="Permanent link">&para;</a></h1>
<p>You've seen how to implement the average rating calculation behavior in
Java, but what if you wanted to implement the behavior using JavaScript
instead? Behaviors can be implemented in server-side JavaScript and bound to
policies through Spring. Let's re-implement the Rating bean using JavaScript.</p>
<p>The high-level steps are:</p>
<ol>
<li>Write the custom behavior as one or more server-side JavaScript files.</li>
<li>Configure a Spring bean to bind the JavaScript to the appropriate policies.</li>
<li>Test the behavior.</li>
</ol>
<h2 id="step-1-write-the-custom-behavior-as-server-side-javascript">Step 1: Write the custom behavior as server-side JavaScript<a class="headerlink" href="#step-1-write-the-custom-behavior-as-server-side-javascript" title="Permanent link">&para;</a></h2>
<p>For this example I'm going to shamelessly steal a JavaScript file that
is part of the Alfresco source and then tweak it. The original script is
used by Alfresco to test <code>Policy</code> functionality. (As a side note, the test
code that is buried in the Alfresco source tree is a great resource for
example code).</p>
<p>I am going to write three scripts for this:</p>
<ol>
<li>onCreateRating.js will be bound to the <code>onCreateNode</code> policy.</li>
<li>onDeleteRating.js will be bound to the <code>onDeleteNode</code> policy.</li>
<li>rating.js will contain the average rating calculation logic and will be
imported by the other two scripts using the <code>import</code> tag.</li>
</ol>
<p>In this example, the scripts are going to reside as part of the web application
rather than being uploaded to the repository. I'll place them in:</p>
<div class="highlight"><pre><span></span><code>$TUTORIAL_HOME/behavior-tutorial-platform/src/main/resources/alfresco/module/behavior-tutorial-platform/scripts
</code></pre></div>
<p>If you are following along, you'll need to create the scripts directory.</p>
<p>The <a href="https://github.com/jpotts/alfresco-developer-series/blob/master/behaviors/behavior-tutorial/behavior-tutorial-platform/src/main/resources/alfresco/module/behavior-tutorial-platform/scripts/onCreateRating.js">onCreateRating.js</a>
and <a href="https://github.com/jpotts/alfresco-developer-series/blob/master/behaviors/behavior-tutorial/behavior-tutorial-platform/src/main/resources/alfresco/module/behavior-tutorial-platform/scripts/onDeleteRating.js">onDeleteRating.js</a>
files are virtually identical. They just need to do some basic error checking
and then call the <code>computeAverage()</code> function. Here is what onCreateRating.js
looks like:</p>
<div class="highlight"><pre><span></span><code><span class="o">&lt;</span><span class="k">import</span><span class="w"> </span><span class="nx">resource</span><span class="o">=</span><span class="s2">&quot;classpath:alfresco/module/behavior-tutorial-platform/scripts/rating.js&quot;</span><span class="o">&gt;</span>

<span class="c1">// Check behaviour is set and the name of the behaviour</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">behaviour</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="nx">behaviour</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">behaviour</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">&quot;onCreateNode&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;The behaviour behaviour object or name has not been set correctly.&quot;</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Behaviour name: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">behaviour</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Check the arguments</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">behaviour</span><span class="p">.</span><span class="nx">args</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;The args have not been set.&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">behaviour</span><span class="p">.</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">childAssoc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">behaviour</span><span class="p">.</span><span class="nx">args</span><span class="p">[</span><span class="mf">0</span><span class="p">];</span>
<span class="w">            </span><span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Calling compute average&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="nx">computeAverage</span><span class="p">(</span><span class="nx">childAssoc</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;The number of arguments is incorrect.&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>The code for onDeleteRating.js is identical with the exception of the
behavior name and the number of arguments expected (2 instead of 1) so I
won't duplicate the listing here.</p>
<p>The <code>computeAverage()</code> function lives in <a href="https://github.com/jpotts/alfresco-developer-series/blob/master/behaviors/behavior-tutorial/behavior-tutorial-platform/src/main/resources/alfresco/module/behavior-tutorial-platform/scripts/rating.js">rating.js</a>. It does pretty
much the same thing as the <code>computeAverage()</code> method in the Java example, but
obviously in JavaScript:</p>
<div class="highlight"><pre><span></span><code><span class="c1">//calculate rating</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">computeAverage</span><span class="p">(</span><span class="nx">childAssocRef</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">parentRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">childAssocRef</span><span class="p">.</span><span class="nx">parent</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// check the parent to make sure it has the right aspect</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">parentRef</span><span class="p">.</span><span class="nx">hasAspect</span><span class="p">(</span><span class="s2">&quot;{http://www.someco.com/model/ratings/1.0}rateable&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Rating&#39;s parent ref did not have rateable aspect.&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// get the parent node&#39;s children</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parentRef</span><span class="p">.</span><span class="nx">children</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// iterate through the children to compute the total</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">average</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">total</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">children</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">children</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">rating</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">child</span><span class="p">.</span><span class="nx">properties</span><span class="p">[</span><span class="s2">&quot;{http://www.someco.com/model/content/1.0}rating&quot;</span><span class="p">];</span>
<span class="w">            </span><span class="nx">total</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">rating</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// compute the average</span>
<span class="w">        </span><span class="nx">average</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">total</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Computed average:&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">average</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// store the average, total, count on the parent node</span>
<span class="w">    </span><span class="nx">parentRef</span><span class="p">.</span><span class="nx">properties</span><span class="p">[</span><span class="s2">&quot;{http://www.someco.com/model/ratings/1.0}averageRating&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">average</span><span class="p">;</span>
<span class="w">    </span><span class="nx">parentRef</span><span class="p">.</span><span class="nx">properties</span><span class="p">[</span><span class="s2">&quot;{http://www.someco.com/model/ratings/1.0}totalRating&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">total</span><span class="p">;</span>
<span class="w">    </span><span class="nx">parentRef</span><span class="p">.</span><span class="nx">properties</span><span class="p">[</span><span class="s2">&quot;{http://www.someco.com/model/ratings/1.0}ratingCount&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
<span class="w">    </span><span class="nx">parentRef</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span>

<span class="w">    </span><span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Property set&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>As you can see, this is the same logic used in the Java example modified to
follow the Alfresco JavaScript API syntax.</p>
<h2 id="step-2-configure-a-spring-bean-to-bind-the-script-to-the-appropriate-policies">Step 2: Configure a Spring bean to bind the script to the appropriate policies<a class="headerlink" href="#step-2-configure-a-spring-bean-to-bind-the-script-to-the-appropriate-policies" title="Permanent link">&para;</a></h2>
<p>The Java example used an <code>init()</code> method on the <code>Rating</code> bean to make calls to
the <code>bindClassBehaviour()</code> method of <code>PolicyComponent</code>. The JavaScript example
doesn't do that. Instead, it uses Spring to associate the JavaScript files with
the <code>onCreateNode</code> and <code>onDeleteNode</code> policies.</p>
<p>As you've seen, the Spring context, <a href="https://github.com/jpotts/alfresco-developer-series/blob/master/behaviors/behavior-tutorial/behavior-tutorial-platform/src/main/resources/alfresco/module/behavior-tutorial-platform/context/service-context.xml">service-context.xml</a>
file resides in:</p>
<div class="highlight"><pre><span></span><code>$TUTORIAL_HOME/behavior-tutorial-platform/src/main/resources/alfresco/module/behavior-tutorial-platform/context
</code></pre></div>
<p>Edit the file. Comment out the <code>ratingBehavior</code> bean element used for the Java
example and add two new bean configs below it for the JavaScript behavior
code—one for the create and one for the delete:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;onCreateRatingNode&quot;</span>
<span class="na">class=</span><span class="s">&quot;org.alfresco.repo.policy.registration.ClassPolicyRegistration&quot;</span>
<span class="na">parent=</span><span class="s">&quot;policyRegistration&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;policyName&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;value&gt;</span>{http://www.alfresco.org}onCreateNode<span class="nt">&lt;/value&gt;</span>
<span class="w">    </span><span class="nt">&lt;/property&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;className&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;value&gt;</span>{http://www.someco.com/model/ratings/1.0}rating<span class="nt">&lt;/value&gt;</span>
<span class="w">    </span><span class="nt">&lt;/property&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;behaviour&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.alfresco.repo.jscript.ScriptBehaviour&quot;</span><span class="w"> </span><span class="na">parent=</span><span class="s">&quot;scriptBehaviour&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;location&quot;</span><span class="nt">&gt;</span>
<span class="w">                </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.alfresco.repo.jscript.ClasspathScriptLocation&quot;</span><span class="nt">&gt;</span>
<span class="w">                    </span><span class="nt">&lt;constructor-arg&gt;</span>
<span class="w">                        </span><span class="nt">&lt;value&gt;</span>alfresco/module/${project.artifactId}/scripts/onCreateRating.js<span class="nt">&lt;/value&gt;</span>
<span class="w">                    </span><span class="nt">&lt;/constructor-arg&gt;</span>
<span class="w">                </span><span class="nt">&lt;/bean&gt;</span>
<span class="w">            </span><span class="nt">&lt;/property&gt;</span>
<span class="w">        </span><span class="nt">&lt;/bean&gt;</span>
<span class="w">    </span><span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;onDeleteRatingNode&quot;</span>
<span class="na">class=</span><span class="s">&quot;org.alfresco.repo.policy.registration.ClassPolicyRegistration&quot;</span>
<span class="na">parent=</span><span class="s">&quot;policyRegistration&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;policyName&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;value&gt;</span>{http://www.alfresco.org}onDeleteNode<span class="nt">&lt;/value&gt;</span>
<span class="w">    </span><span class="nt">&lt;/property&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;className&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;value&gt;</span>{http://www.someco.com/model/ratings/1.0}rating<span class="nt">&lt;/value&gt;</span>
<span class="w">    </span><span class="nt">&lt;/property&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;behaviour&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.alfresco.repo.jscript.ScriptBehaviour&quot;</span><span class="w"> </span><span class="na">parent=</span><span class="s">&quot;scriptBehaviour&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;location&quot;</span><span class="nt">&gt;</span>
<span class="w">                </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.alfresco.repo.jscript.ClasspathScriptLocation&quot;</span><span class="nt">&gt;</span>
<span class="w">                    </span><span class="nt">&lt;constructor-arg&gt;</span>
<span class="w">                        </span><span class="nt">&lt;value&gt;</span>alfresco/module/${project.artifactId}/scripts/onDeleteRating.js<span class="nt">&lt;/value&gt;</span>
<span class="w">                    </span><span class="nt">&lt;/constructor-arg&gt;</span>
<span class="w">                </span><span class="nt">&lt;/bean&gt;</span>
<span class="w">            </span><span class="nt">&lt;/property&gt;</span>
<span class="w">        </span><span class="nt">&lt;/bean&gt;</span>
<span class="w">    </span><span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</code></pre></div>
<p>Now Alfresco will use the two server-side JavaScript files as the behavior
implementation instead of the Java-based behavior created earlier.</p>
<h2 id="step-3-test-the-javascript-based-behavior">Step 3: Test the JavaScript-based behavior<a class="headerlink" href="#step-3-test-the-javascript-based-behavior" title="Permanent link">&para;</a></h2>
<p>If you are following along and you already did the Java-based behavior, this
step is easy. The integration test doesn't have to change at all because all that is
different is that the underlying behavior logic is written in JavaScript instead
of Java.</p>
<p>So, switch to the $TUTORIAL_HOME directory and run <code>mvn install -DskipTests</code> to
rebuild the AMPs, then <code>./run.sh reload_acs</code> to re-build and re-start the
Alfresco image. Once it is back up, run <code>./run.sh test</code>. Just like the Java
example, you should see something like this:</p>
<div class="highlight"><pre><span></span><code>[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 3.887 s
[INFO] Finished at: 2019-02-11T17:26:19-06:00
[INFO] Final Memory: 32M/488M
[INFO] ------------------------------------------------------------------------
</code></pre></div>
<p>Successful tests are certainly comforting, but they are not very satisfying.
Wouldn't you like to actually see this behavior working in the user interface?
In the web scripts tutorial I'll show you how to create a little web page that
lets you click on stars and post ratings for whitepapers. For now, if
you'd like to run a simple web script that creates test rating objects on
specified content, follow these steps:</p>
<ol>
<li>
<p>If you are using the source code checked out from GitHub instead of creating
your own project you can move on to step 2. Otherwise, if you are following
along in your own project directories, copy the following directory and its
descendants from the source code that accompanies this tutorial into your
behavior-tutorial-platform module. Copy:</p>
<div class="highlight"><pre><span></span><code>$TUTORIAL_SOURCE/behavior-tutorial-platform/src/main/resources/alfresco/extension/templates/webscripts
</code></pre></div>
<p>to:</p>
<div class="highlight"><pre><span></span><code>$TUTORIAL_HOME/behavior-tutorial-platform/src/main/resources/alfresco/extension/templates/webscripts
</code></pre></div>
<p>The directory contains the files that make up a quick-and-dirty web script
that will create random ratings on a specified piece of content.</p>
</li>
<li>
<p>Switch to $TUTORIAL_HOME and run <code>mvn install -DskipTests</code> to re-build the
AMPs.</p>
</li>
<li>
<p>Run <code>./run.sh reload_acs</code> to stop and start the Alfresco container.</p>
</li>
<li>
<p>Once the server comes up, log in to http://localhost:8180/share as admin,
password admin.</p>
</li>
<li>
<p>Create a piece of test content somewhere in the repository. It doesn't matter
what it is or what it is named.</p>
</li>
<li>
<p>Grab the test content's nodeRef. The easiest way to do this is to copy it
from the URL that is displayed when you view the content's details page. For
example, when you look at the details for your test content, the URL should
look something like this:</p>
<div class="highlight"><pre><span></span><code>http://localhost:8080/share/page/document-details?nodeRef=workspace://SpacesStore/00408a65-1e9e-42ad-b02c-aa3546624d07
</code></pre></div>
<p>Copy everything after "nodeRef=".</p>
</li>
<li>
<p>Now invoke the test web script, passing in the nodeRef you just copied, like
this:</p>
<div class="highlight"><pre><span></span><code>http://localhost:8080/alfresco/s/someco/rating-test?nodeRef=workspace://SpacesStore/00408a65-1e9e-42ad-b02c-aa3546624d07
</code></pre></div>
<p>Every time you invoke the web script, the script generates a random rating
value and creates a new rating object for your piece of test content.</p>
</li>
<li>
<p>Go back into Share and look at the test document's details. You should see
its average rating and the total number of ratings displayed in the property
list, like this:</p>
</li>
</ol>
<p><img alt="This piece of content has 20 ratings with an average of 3" src="../images/content-with-test-ratings.png" /></p>
<p>This shouldn't be too surprising--you are using a web script to exercise the
same behavior as the integration test, but at least this way you can log in to
Share and see for yourself that the behavior works.</p>
<h1 id="deploying-the-amps-to-your-alfresco-server">Deploying the AMPs to your Alfresco server<a class="headerlink" href="#deploying-the-amps-to-your-alfresco-server" title="Permanent link">&para;</a></h1>
<p>When you are ready, you can deploy these AMPs to any Alfresco server. Both the
platform module and the share module directories should have a directory called
target. Maven puts the AMP there when you run <code>mvn install</code>. You can install
those AMPs as you normally would. For example, if you installed Alfresco in your
own manually set up Tomcat server, you would:</p>
<ol>
<li>Copy the repo tier AMP to $ALFRESCO_HOME/amps</li>
<li>Copy the share tier AMP to $ALFRESCO_HOME/amps_share</li>
<li>Install the AMPs by running $ALFRESCO_HOME/bin/apply_amps.sh</li>
</ol>
<p>If you deployed Alfresco using Docker Compose or Kubernetes you'll need to build
new images that copy the AMPs to the containers and then invoke the Alfresco MMT
to install them into the Alfresco and Share WARs.</p>
<h1 id="conclusion">Conclusion<a class="headerlink" href="#conclusion" title="Permanent link">&para;</a></h1>
<p>This tutorial has shown how to bind custom behavior to Alfresco policies.
Specifically, the tutorial showed how to implement a custom "rateable" aspect
and a custom "rating" type that can be used to persist user ratings of content
stored in the repository. The custom behavior is responsible for calculating
the average rating for a piece of content any time a rating is created or
deleted. The tutorial showed how to implement the average rating calculation
behavior in Java as well as JavaScript.</p>
<h1 id="where-to-find-more-information">Where to Find More Information<a class="headerlink" href="#where-to-find-more-information" title="Permanent link">&para;</a></h1>
<ul>
<li>The complete source code for these examples is available on <a href="https://github.com/jpotts/alfresco-developer-series">GitHub</a>.</li>
<li>Official documentation for both Enterprise Edition and Community Edition is
available at <a href="http://docs.alfresco.com/">docs.alfresco.com</a>.</li>
<li>Get help from the <a href="http://community.alfresco.com">community</a>.</li>
<li>If you are ready to cover new ground, try another <a href="https://ecmarchitect.com">ecmarchitect.com</a> tutorial in the <a href="https://ecmarchitect.com/alfresco-developer-series">Alfresco Developer Series</a>.
The most logical next step is the <a href="https://ecmarchitect.com/alfresco-developer-series-tutorials/webscripts/tutorial/tutorial.html">Intro to the Web Script Framework</a>
tutorial.</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.instant", "navigation.sections", "navigation.top", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>